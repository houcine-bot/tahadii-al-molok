<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <link
      rel="shortcut icon"
      href="684eb59d-327f-4353-a31e-3a12640c54ae.jpg"
      type="image/x-icon"
    />
    <meta
      property="og:image"
      content="https://houcine-bot/tahadii-al-molok.io/684eb59d-327f-4353-a31e-3a12640c54ae.jpg"
    />
    <!-- إعدادات تجعل الموقع يعمل كتطبيق ويب (PWA) -->
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <meta name="theme-color" content="#000000" />
    <title>تحدي الملوك</title>
    <!-- استيراد الخطوط والأيقونات -->
    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />
    <style>
      /* --- إعدادات الصفحة الأساسية --- */
      body {
        margin: 0;
        overflow: hidden;
        background-color: #1a1a1a; /* لون رمادي غامق بدلاً من الأسود للتفريق */
        font-family: "Cairo", sans-serif;
        user-select: none;
        -webkit-touch-callout: none;
      }

      /* --- شاشة البداية (Splash Screen) --- */
      #splash-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: #000;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        color: #f1c40f;
        opacity: 1;
        transition: opacity 1s ease-out;
        pointer-events: auto;
      }
      #splash-logo {
        width: 150px;
        height: 150px;
        margin-bottom: 20px;
        opacity: 0;
        animation: fadeInLogo 2s forwards;
      }
      #splash-text {
        font-size: 24px;
        font-weight: bold;
        color: #fff;
        opacity: 0;
        animation: fadeInText 2s 1s forwards; /* يبدأ بعد ثانية */
        text-shadow: 0 0 10px #f1c40f;
      }
      @keyframes fadeInLogo {
        from {
          opacity: 0;
          transform: scale(0.8);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }
      @keyframes fadeInText {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* --- تحذير تدوير الشاشة (Landscape Enforcer) --- */
      #orientation-warning {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #2c3e50;
        color: white;
        z-index: 10000;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
      }
      #orientation-warning .material-icons {
        font-size: 60px;
        margin-bottom: 20px;
        animation: rotatePhone 2s infinite;
      }
      @keyframes rotatePhone {
        0% {
          transform: rotate(0deg);
        }
        50% {
          transform: rotate(-90deg);
        }
        100% {
          transform: rotate(0deg);
        }
      }

      /* إظهار التحذير فقط في وضع البورتريه */
      @media screen and (orientation: portrait) {
        #orientation-warning {
          display: flex !important;
        }
        /* إخفاء باقي العناصر عند ظهور التحذير */
        #ui-container,
        #game-navbar,
        #mobile-controls,
        #sidebar-container {
          display: none !important;
        }
      }

      /* --- شريط التنقل العلوي --- */
      #game-navbar {
        display: none; /* مخفي افتراضياً حتى الدخول */
        position: fixed;
        top: -10px;
        right: 50%;
        transform: translateX(50%);
        width: 90%;
        max-width: 1200px;
        height: 40px;
        padding: 0 15px;
        flex-direction: row;
        flex-wrap: nowrap;
        justify-content: space-between;
        align-items: center;
        background: rgba(0, 0, 0, 0.45);
        backdrop-filter: blur(15px);
        border-bottom: 2px solid #f1c40f;
        border-radius: 0 0 18px 18px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.6);
        z-index: 999;
      }
      /* Ticker for Event */
      #event-ticker-container {
        position: absolute;
        top: 55px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(192, 57, 43, 0.9);
        color: white;
        padding: 5px 20px;
        border-radius: 0 0 10px 10px;
        font-weight: bold;
        box-shadow: 0 0 15px red;
        display: none; /* يظهر فقط عند تفعيل الحدث */
        z-index: 990;
        white-space: nowrap;
        animation: pulseEvent 2s infinite;
      }
      @keyframes pulseEvent {
        0% {
          text-shadow: 0 0 5px white;
        }
        50% {
          text-shadow: 0 0 20px yellow;
        }
        100% {
          text-shadow: 0 0 5px white;
        }
      }

      @media (min-width: 330px) and (max-width: 781px) {
        #game-navbar {
          height: 48px;
          padding: 0 10px;
          margin-top: 20px;
        }
        .nav-item {
          font-size: 5px;
        }
        .nav-value {
          font-size: 5px;
        }
      }

      .glass-card {
        width: 380px;
      }
      .modal-content {
        width: 90%;
      }
      .unit-card {
        gap: 15px;
      }
      .tab-btn {
        font-size: 15px;
      }

      .nav-item {
        color: #e0e0e0;
        font-size: 9px;
        font-weight: 700;
        display: flex;
        flex-direction: column;
        align-items: center;
        line-height: 1;
        text-shadow: 1px 1px 2px black;
      }
      .nav-item:hover {
        color: #f1c40f;
        transform: scale(1.05);
      }
      .nav-value {
        font-size: 9px;
        color: #f1c40f;
        margin-top: 2px;
        font-weight: bold;
        text-shadow: 0 0 10px rgba(241, 196, 15, 0.6);
      }

      /* --- واجهة تسجيل الدخول --- */
      /* --- واجهة تسجيل الدخول --- */
      #ui-container {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        /* display: flex;  <-- احذف هذا السطر أو غيره */
        display: none; /* <--- اجعله مخفياً افتراضياً */
        justify-content: center;
        align-items: center;
        z-index: 1000;
        background: rgba(0, 0, 0, 0.8);
        pointer-events: auto;
      }
      .glass-card {
        background: rgba(20, 20, 20, 0.9);
        backdrop-filter: blur(20px);
        padding: 50px;
        border-radius: 25px;
        width: 350px;
        border: 2px solid rgba(255, 255, 255, 0.1);
        text-align: center;
        color: white;
        pointer-events: auto;
        box-shadow: 0 0 50px rgba(0, 0, 0, 0.8);
      }
      h2 {
        font-family: "Cairo", sans-serif;
        color: #f1c40f;
        margin-top: 0;
        font-weight: 700;
        font-size: 28px;
        margin-bottom: 10px;
      }
      .google-btn {
        width: 100%;
        background-color: white;
        color: #333;
        border: none;
        border-radius: 12px;
        padding: 15px;
        font-weight: 700;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
        margin-bottom: 20px;
        font-family: "Cairo", sans-serif;
        font-size: 16px;
        transition: 0.2s;
      }
      .google-btn:hover {
        background-color: #f0f0f0;
        transform: translateY(-2px);
      }

      /* --- النوافذ المنبثقة (Modal) العامة --- */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 80%;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(5px);
        z-index: 2000;
        justify-content: center;
        align-items: center;
        padding: 20px; /* Safe area */
        box-sizing: border-box;
      }

      .modal-content {
        background: rgba(30, 30, 40, 0.98);
        border: 1px solid #444;
        border-radius: 16px;
        /* Responsive Sizing */
        width: 95%;
        max-width: 800px; /* Prevent too wide on tablets */
        max-height: 85vh; /* Vital for landscape phones */
        display: flex;
        flex-direction: column;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8);
        animation: modalPopIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        overflow: hidden; /* Header fixed, body scrolls */
      }

      @keyframes modalPopIn {
        from {
          transform: scale(0.9);
          opacity: 0;
        }
        to {
          transform: scale(1);
          opacity: 1;
        }
      }

      .modal-header {
        padding: 10px 20px;
        background: linear-gradient(90deg, #2c3e50, #1a1a1a);
        border-bottom: 2px solid #f1c40f;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0; /* Header stays fixed */
      }
      .modal-header h2 {
        font-size: 18px;
        margin: 0;
      }
      .close-modal {
        background: none;
        border: none;
        color: #e74c3c;
        padding: 5px;
        cursor: pointer;
      }
      .close-modal .material-icons {
        font-size: 28px;
      }

      /* --- نافذة الجيش --- */
      .military-tabs {
        display: flex;
        background: #1a1a1a;
      }
      .tab-btn {
        flex: 1;
        padding: 18px;
        border: none;
        background: none;
        color: #888;
        font-family: "Cairo", sans-serif;
        font-weight: bold;
        font-size: 16px;
        cursor: pointer;
        transition: 0.3s;
        border-bottom: 4px solid transparent;
      }
      .tab-btn:hover {
        background: #252525;
        color: white;
      }
      .tab-btn.active {
        color: #f1c40f;
        border-bottom: 4px solid #f1c40f;
        background: #2c2c2c;
      }
      .military-body {
        flex: 1;
        padding: 25px;
        overflow-y: auto;
        color: white;
      }

      .unit-card {
        background: linear-gradient(
          45deg,
          rgba(255, 255, 255, 0.05),
          transparent
        );
        border: 1px solid rgba(255, 255, 255, 0.1);
        padding: 20px;
        margin-bottom: 15px;
        border-radius: 12px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: 0.3s;
      }
      .unit-card:hover {
        background: rgba(255, 255, 255, 0.1);
        border-color: #f1c40f;
        transform: translateX(-5px);
      }
      .unit-info h3 {
        margin: 0 0 8px 0;
        color: #f1c40f;
        font-size: 20px;
      }
      .unit-stats {
        font-size: 14px;
        color: #ccc;
        display: flex;
        gap: 15px;
      }
      .stat-badge {
        background: #333;
        padding: 4px 10px;
        border-radius: 6px;
        border: 1px solid #555;
      }

      .recruit-actions {
        display: flex;
        gap: 15px;
        align-items: center;
      }
      .recruit-input {
        width: 70px;
        padding: 8px;
        background: #000;
        border: 1px solid #555;
        color: #f1c40f;
        font-weight: bold;
        text-align: center;
        border-radius: 8px;
        font-size: 16px;
      }
      .recruit-btn {
        background: linear-gradient(180deg, #27ae60, #219150);
        color: white;
        border: none;
        padding: 8px 25px;
        border-radius: 8px;
        cursor: pointer;
        font-family: "Cairo";
        font-weight: bold;
        box-shadow: 0 4px 0 #1e8449;
        transition: 0.1s;
      }
      .recruit-btn:hover {
        background: linear-gradient(180deg, #2ecc71, #27ae60);
      }
      .recruit-btn:active {
        transform: translateY(4px);
        box-shadow: none;
      }

      /* --- نافذة الهجوم (Attack UI) --- */
      /* --- نافذة الهجوم (Attack UI) - التصميم الأساسي --- */
      #attack-modal .modal-header {
        background: linear-gradient(90deg, #500000, #200000);
        border-bottom: 3px solid #c0392b;
        padding: 10px 15px; /* تقليل حواشي الرأس قليلاً */
      }

      .attack-header-title {
        color: #e74c3c !important;
        text-shadow: 0 0 10px red;
        font-size: 18px; /* حجم مناسب */
        margin: 0;
      }

      .attack-unit-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: rgba(100, 0, 0, 0.2);
        padding: 10px; /* تم التقليل من 15px */
        border-radius: 8px;
        margin-bottom: 8px; /* تم التقليل من 10px */
        border: 1px solid rgba(255, 0, 0, 0.1);
      }

      .attack-unit-info {
        text-align: right;
        flex: 1; /* لتأخذ المساحة المتاحة */
      }

      .attack-unit-name {
        color: #f1c40f;
        font-weight: bold;
        font-size: 16px; /* تم التقليل من 18px */
        margin-bottom: 2px;
        display: block;
      }

      .attack-unit-avail {
        font-size: 11px; /* تم التقليل من 12px */
        color: #aaa;
      }

      /* تنسيق منطقة التحكم بالكمية (المدخلات) */
      .attack-unit-input-area {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        min-width: 100px;
      }

      .war-btn {
        width: 100%;
        padding: 12px; /* تم التقليل من 20px */
        background: linear-gradient(180deg, #c0392b, #922b21);
        color: white;
        font-family: "Cairo";
        font-size: 18px; /* تم التقليل من 22px */
        font-weight: bold;
        border: none;
        cursor: pointer;
        box-shadow: 0 -3px 10px rgba(192, 57, 43, 0.4);
        transition: 0.3s;
        border-radius: 0 0 12px 12px; /* تدوير الحواف السفلية لتناسب النافذة */
      }

      .war-btn:hover {
        background: linear-gradient(180deg, #e74c3c, #c0392b);
        letter-spacing: 1px;
      }

      /* --- تعديلات خاصة للهواتف في الوضع العرضي (Landscape) --- */
      /* يتم تطبيق هذا فقط عندما يكون ارتفاع الشاشة أقل من 500 بكسل */
      /* --- تحسين خاص جداً للموبايل (وضع العرض - Landscape) --- */
      @media screen and (orientation: landscape) and (max-height: 500px) {
        /* جعل القائمة نحيفة جداً وشفافة لرؤية اللعبة خلفها */
        #sidebar-container {
          width: 170px !important; /* عرض صغير جداً */
          right: -170px !important; /* إخفاء كامل عند الغلق */
          background: rgba(0, 0, 0, 0.7) !important; /* شفافية عالية */
          padding-top: 5px !important; /* تقليل المساحة العلوية */
          border-left: 1px solid rgba(241, 196, 15, 0.5);
        }

        /* تعديل وضع الفتح */
        #sidebar-container.open {
          right: 0 !important;
        }

        /* تصغير زر الفتح */
        .sidebar-toggle-btn {
          width: 25px !important;
          height: 35px !important;
          top: 15px !important;
          left: -25px !important;
          font-size: 12px !important;
        }
        .sidebar-toggle-btn .material-icons {
          font-size: 18px !important;
        }

        /* ضغط الأزرار لتكون صغيرة ومتقاربة */
        .sidebar-btn {
          padding: 6px 10px !important; /* حواشي صغيرة جداً */
          font-size: 11px !important; /* خط صغير */
          gap: 8px !important; /* تقريب الأيقونة من النص */
          height: 35px !important; /* ارتفاع ثابت صغير للزر */
        }

        /* تصغير الأيقونات */
        .sidebar-btn .material-icons {
          font-size: 16px !important;
        }

        /* شارة التنبيه (النقطة الحمراء) */
        #mail-badge {
          width: 6px !important;
          height: 6px !important;
          top: 5px !important;
          right: 5px !important;
        }
      }
      @media (max-height: 500px) {
        #attack-modal .modal-content {
          max-height: 95vh; /* استغلال كامل الارتفاع */
        }

        #attack-modal .modal-header {
          padding: 5px 10px; /* رأس صغير جداً */
        }

        .attack-header-title {
          font-size: 14px;
        }

        .attack-unit-row {
          padding: 4px 8px; /* تقليل الحواشي لأقصى حد */
          margin-bottom: 4px;
          border-radius: 4px;
        }

        .attack-unit-name {
          font-size: 13px; /* خط صغير للاسم */
          margin-bottom: 0;
        }

        .attack-unit-avail {
          font-size: 10px;
        }

        /* تصغير المدخلات والأرقام */
        input[type="range"] {
          height: 4px; /* تنحيف الشريط */
        }

        .war-btn {
          padding: 6px; /* زر نحيف */
          font-size: 14px; /* خط صغير */
          box-shadow: none;
        }
      }

      /* --- نافذة التبرع (Donation UI) --- */
      #donation-modal .modal-header {
        background: linear-gradient(90deg, #145a32, #1e8449);
        border-bottom: 3px solid #2ecc71;
      }
      .donation-section {
        margin-bottom: 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        padding-bottom: 10px;
      }
      .donation-label {
        color: #2ecc71;
        font-weight: bold;
        margin-bottom: 5px;
        display: block;
      }
      .donation-row {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 10px;
      }
      .donate-btn {
        width: 100%;
        padding: 15px;
        background: linear-gradient(180deg, #27ae60, #145a32);
        color: white;
        font-family: "Cairo";
        font-size: 20px;
        font-weight: bold;
        border: none;
        cursor: pointer;
        box-shadow: 0 -5px 20px rgba(46, 204, 113, 0.4);
        transition: 0.3s;
      }
      .donate-btn:hover {
        background: linear-gradient(180deg, #2ecc71, #27ae60);
        letter-spacing: 1px;
      }

      /* --- نافذة الخيارات (Action Choice) --- */
      #action-modal .modal-content {
        width: 400px;
      }
      .action-btn-container {
        padding: 40px;
        display: flex;
        gap: 20px;
        justify-content: center;
      }
      .action-choice-btn {
        flex: 1;
        padding: 20px;
        border-radius: 15px;
        border: 2px solid rgba(255, 255, 255, 0.1);
        color: white;
        font-family: "Cairo";
        font-weight: bold;
        font-size: 18px;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
        transition: 0.3s;
      }
      .action-choice-btn.attack {
        background: rgba(192, 57, 43, 0.3);
        border-color: #c0392b;
      }
      .action-choice-btn.attack:hover {
        background: #c0392b;
        transform: scale(1.05);
      }
      .action-choice-btn.donate {
        background: rgba(39, 174, 96, 0.3);
        border-color: #27ae60;
      }
      .action-choice-btn.donate:hover {
        background: #27ae60;
        transform: scale(1.05);
      }

      /* --- نافذة التطوير (Upgrade UI) --- */
      #upgrade-modal .modal-content {
        width: 500px;
        border-color: #3498db;
      }
      #upgrade-modal .modal-header {
        background: linear-gradient(90deg, #1a2a6c, #b21f1f, #fdbb2d);
        background-size: 200% 200%;
        animation: gradientBG 5s ease infinite;
      }
      @keyframes gradientBG {
        0% {
          background-position: 0% 50%;
        }
        50% {
          background-position: 100% 50%;
        }
        100% {
          background-position: 0% 50%;
        }
      }
      .upgrade-details {
        padding: 30px;
        text-align: center;
        color: white;
      }
      .lvl-badge {
        font-size: 40px;
        color: #f1c40f;
        text-shadow: 0 0 15px gold;
        margin-bottom: 20px;
        display: block;
      }
      .resource-row {
        display: flex;
        justify-content: space-between;
        padding: 10px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        font-size: 18px;
      }
      .res-name {
        color: #aaa;
      }
      .res-val {
        font-weight: bold;
      }
      .res-val.ok {
        color: #2ecc71;
      }
      .res-val.no {
        color: #e74c3c;
      }
      .confirm-upgrade-btn {
        width: 100%;
        padding: 15px;
        margin-top: 20px;
        background: linear-gradient(180deg, #2980b9, #1a5276);
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 20px;
        font-family: "Cairo";
        cursor: pointer;
        transition: 0.3s;
      }
      .confirm-upgrade-btn:hover {
        background: linear-gradient(180deg, #3498db, #2980b9);
      }
      .confirm-upgrade-btn:disabled {
        background: #555;
        cursor: not-allowed;
        color: #888;
      }

      /* تم إخفاء الأزرار القديمة لاستبدالها بالقائمة الجانبية */
      .floating-ui-btn {
        display: none !important;
      }

      /* Badge Style */
      #mail-badge {
        display: none;
        position: absolute;
        top: 15px;
        right: 15px;
        width: 10px;
        height: 10px;
        background-color: #e74c3c;
        border-radius: 50%;
        border: 1px solid white;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
      }

      /* Warning Overlay */
      #attack-warning-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 80%;
        background: radial-gradient(
          circle,
          transparent 50%,
          rgba(255, 0, 0, 0.6) 100%
        );
        z-index: 500;
        pointer-events: none;
        animation: pulseWarning 1s infinite;
        justify-content: center;
        align-items: flex-start;
        padding-top: 100px;
      }
      #attack-warning-text {
        font-size: 15px;
        color: red;
        font-weight: bold;
        text-shadow: 0 0 20px black;
        background: rgba(0, 0, 0, 0.7);
        padding: 20px 50px;
        border-radius: 20px;
        border: 3px solid red;
      }
      @keyframes pulseWarning {
        0% {
          opacity: 0.5;
          box-shadow: inset 0 0 50px red;
        }
        50% {
          opacity: 1;
          box-shadow: inset 0 0 150px red;
        }
        100% {
          opacity: 0.5;
          box-shadow: inset 0 0 50px red;
        }
      }

      .material-icons {
        font-size: 20px;
      }

      /* --- REPORTS MODAL STYLE --- */
      .report-item {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid #444;
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 10px;
        display: flex;
        flex-direction: column;
        gap: 5px;
      }
      .report-item.win {
        border-right: 5px solid #2ecc71;
      }
      .report-item.loss {
        border-right: 5px solid #e74c3c;
      }
      .report-header {
        display: flex;
        justify-content: space-between;
        font-weight: bold;
        font-size: 16px;
      }
      .report-loot {
        display: flex;
        gap: 15px;
        font-size: 14px;
        color: #f1c40f;
      }
      .report-time {
        font-size: 12px;
        color: #888;
        align-self: flex-end;
      }

      /* The Windows-style menu for upgrade/recruit */
      #castle-controls-panel {
        position: absolute;
        bottom: 120px; /* Centered bottom */
        left: 50%;
        transform: translateX(-50%);
        display: none; /* Hidden by default */
        flex-direction: row; /* Horizontal on desktop */
        gap: 12px;
        z-index: 1000;
        pointer-events: auto;
        animation: slideUp 0.3s ease-out;
        padding: 15px;
        background: rgba(0, 0, 0, 0.5);
        border-radius: 20px;
        backdrop-filter: blur(5px);
      }
      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translate(-50%, 20px);
        }
        to {
          opacity: 1;
          transform: translate(-50%, 0);
        }
      }
      .castle-action-btn {
        background: rgba(20, 20, 30, 0.9);
        border: 2px solid #555;
        border-bottom: 5px solid #f1c40f;
        color: white;
        padding: 15px 25px;
        border-radius: 12px;
        font-family: "Cairo";
        font-size: 18px;
        font-weight: bold;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
        min-width: 140px;
        backdrop-filter: blur(10px);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
        transition: 0.2s;
      }
      .castle-action-btn:hover {
        background: #333;
        border-color: #f1c40f;
        transform: translateY(-5px);
      }
      .castle-action-btn span {
        font-size: 32px;
        color: #f1c40f;
      }

      /* --- أزرار التحكم للموبايل (Mobile Controls) --- */
      #mobile-controls {
        display: none; /* مخفي افتراضياً، يظهر في الموبايل */
        position: absolute;
        bottom: 19px;
        left: 20px;
        flex-direction: column;
        align-items: center;
        gap: 10px;
        z-index: 1000;
        pointer-events: auto;
      }

      .control-row-middle {
        display: flex;
        gap: 50px;
      }

      .m-btn {
        width: 27px;
        height: 27px;
        border-radius: 50%;
        background: rgba(0, 0, 0, 0.4);
        border: 2px solid rgba(255, 255, 255, 0.3);
        color: white;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 20px;
        user-select: none;
        touch-action: manipulation;
        backdrop-filter: blur(5px);
        -webkit-tap-highlight-color: transparent;
      }
      .m-btn:active {
        background: rgba(241, 196, 15, 0.5);
        transform: scale(0.95);
      }

      /* --- NEW: Sidebar Styles --- */
      #sidebar-container {
        position: fixed;
        top: 0;
        right: -250px; /* Hidden initially */
        width: 250px;
        height: 100%;
        background: rgba(10, 10, 15, 0.95);
        backdrop-filter: blur(15px);
        z-index: 1500;
        border-left: 2px solid #f1c40f;
        box-shadow: -5px 0 20px rgba(0, 0, 0, 0.8);
        transition: right 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        display: flex;
        flex-direction: column;
        padding-top: 80px; /* Space for Navbar */
        pointer-events: auto;
      }

      #sidebar-container.open {
        right: 0;
      }

      .sidebar-toggle-btn {
        margin-top: 6.5rem;
        position: absolute;
        top: 50%;
        left: -20px; /* Stick out to the left of the sidebar */
        width: 20px;
        height: 35px;
        background: #f1c40f;
        border-radius: 10px 0 0 10px;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        box-shadow: -2px 0 10px rgba(0, 0, 0, 0.5);
        color: #000;
        font-weight: bold;
        transition: 0.3s;
      }
      .sidebar-toggle-btn:hover {
        background: #9b8b00;
      }

      .sidebar-btn {
        background: none;
        border: none;
        color: #fff;
        padding: 15px 25px;
        text-align: right;
        font-family: "Cairo", sans-serif;
        font-size: 18px;
        cursor: pointer;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        align-items: center;
        gap: 15px;
        transition: 0.2s;
        position: relative;
      }
      .sidebar-btn:hover {
        background: rgba(255, 255, 255, 0.1);
        padding-right: 35px;
        color: #f1c40f;
      }
      .sidebar-btn.danger {
        color: #e74c3c;
      }
      .sidebar-btn.danger:hover {
        background: rgba(231, 76, 60, 0.2);
      }

      /* --- NEW: The Blood Sidebar Button --- */
      .sidebar-btn.blood {
        color: #e74c3c;
        border-left: 5px solid #c0392b;
        background: rgba(192, 57, 43, 0.1);
      }
      .sidebar-btn.blood:hover {
        background: rgba(192, 57, 43, 0.3);
      }

      /* --- ADMIN PANEL STYLES --- */
      .admin-modal-content {
        width: 95%;
        height: 95%;
        background: #111;
        border: 2px solid #f1c40f;
        display: flex;
        flex-direction: column;
      }
      .admin-tabs {
        display: flex;
        background: #222;
        border-bottom: 2px solid #444;
      }
      .admin-tab {
        padding: 15px 30px;
        color: #aaa;
        cursor: pointer;
        font-weight: bold;
        font-size: 18px;
        flex: 1;
        text-align: center;
      }
      .admin-tab:hover {
        background: #333;
        color: white;
      }
      .admin-tab.active {
        background: #f1c40f;
        color: black;
      }

      .admin-section {
        display: none;
        flex: 1;
        padding: 20px;
        overflow-y: auto;
      }
      .admin-section.active {
        display: block;
      }

      /* Admin Table */
      .admin-table-container {
        overflow-x: auto;
      }
      .admin-table {
        width: 100%;
        border-collapse: collapse;
        color: white;
        min-width: 800px;
      }
      .admin-table th,
      .admin-table td {
        border: 1px solid #444;
        padding: 10px;
        text-align: center;
      }
      .admin-table th {
        background: #333;
        color: #f1c40f;
      }
      .admin-table tr:nth-child(even) {
        background: #1a1a1a;
      }
      .admin-table tr:hover {
        background: #222;
      }
      .btn-delete-user {
        background: #c0392b;
        color: white;
        border: none;
        padding: 5px 10px;
        cursor: pointer;
        border-radius: 5px;
      }

      /* Admin Form */
      .admin-form-group {
        margin-bottom: 15px;
        background: #222;
        padding: 15px;
        border-radius: 10px;
        border: 1px solid #444;
      }
      .admin-form-label {
        display: block;
        color: #f1c40f;
        margin-bottom: 5px;
        font-weight: bold;
      }
      .admin-input {
        width: 95%;
        padding: 10px;
        background: #111;
        border: 1px solid #555;
        color: white;
        border-radius: 5px;
      }
      .admin-btn-action {
        background: #27ae60;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        font-size: 18px;
        cursor: pointer;
        width: 100%;
      }
      .admin-checkbox-group {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }
      .locked-section {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100%;
        flex-direction: column;
        color: #555;
      }

      /* Event Styles */
      .event-control-btn {
        width: 100%;
        padding: 20px;
        font-size: 24px;
        font-weight: bold;
        border-radius: 10px;
        border: none;
        cursor: pointer;
        margin-bottom: 20px;
      }
      .event-start {
        background: #2ecc71;
        color: white;
      }
      .event-stop {
        background: #e74c3c;
        color: white;
      }
      .event-stop:disabled {
        background: #555;
        color: #888;
        cursor: not-allowed;
      }

      /* Dynamic Unit Input */
      .dynamic-unit-row {
        display: flex;
        gap: 10px;
        margin-bottom: 5px;
      }
      .dynamic-unit-select,
      .dynamic-unit-input {
        background: #333;
        color: white;
        border: 1px solid #555;
        padding: 5px;
        border-radius: 4px;
      }

      /* Blood Leaderboard */
      .leaderboard-row {
        display: flex;
        justify-content: space-between;
        padding: 10px;
        border-bottom: 1px solid #333;
        color: white;
      }
      .leaderboard-row.top-1 {
        color: #f1c40f;
        font-weight: bold;
        font-size: 18px;
      }
      .leaderboard-row.top-2 {
        color: #bdc3c7;
        font-weight: bold;
      }
      .leaderboard-row.top-3 {
        color: #d35400;
        font-weight: bold;
      }

      /* Responsive adjustments */
      @media (max-width: 768px) {
        #castle-controls-panel {
          bottom: 100px;
        }
        .castle-action-btn {
          padding: 10px 15px;
          font-size: 14px;
          min-width: 100px;
        }
        .castle-action-btn span {
          font-size: 24px;
        }

        /* --- تحسين نافذة التطوير للموبايل --- */
        #upgrade-modal .modal-content {
          width: 95%;
          max-width: 380px; /* تصغير العرض */
          margin: auto;
        }
        .upgrade-details {
          padding: 15px;
        }
        .lvl-badge {
          font-size: 28px;
          margin-bottom: 10px;
        }
        .resource-row {
          padding: 5px;
          font-size: 14px;
        }
        .confirm-upgrade-btn {
          padding: 10px;
          font-size: 16px;
        }

        /* --- تحسين نافذة الجيش للموبايل --- */
        #military-modal .modal-content {
          width: 98%;
          height: 80vh;
        }
        .tab-btn {
          font-size: 12px;
          padding: 10px;
        }
        .military-body {
          padding: 10px;
        }
        .unit-card {
          flex-direction: column; /* جعل العناصر فوق بعضها */
          align-items: flex-start;
          gap: 10px;
          padding: 10px;
        }
        .recruit-actions {
          width: 100%;
          justify-content: space-between;
        }
        .recruit-input {
          width: 50px;
          font-size: 14px;
          padding: 5px;
        }
        .recruit-btn {
          padding: 5px 15px;
          font-size: 14px;
        }
        .unit-info h3 {
          font-size: 16px;
        }
      }
      /* --- إصلاح نافذة خيارات القلعة للوضع الأفقي (Landscape Fix) --- */
      @media screen and (max-height: 500px) {
        #castle-controls-panel {
          bottom: 10px !important; /* إنزال النافذة لأسفل الشاشة */
          padding: 5px !important; /* تقليل الحواشي */
          gap: 8px !important; /* تقليل المسافة بين الأزرار */
          border-radius: 10px !important;
          background: rgba(
            0,
            0,
            0,
            0.85
          ) !important; /* خلفية أغمق لوضوح أفضل */
        }

        .castle-action-btn {
          min-width: 70px !important; /* عرض أصغر للزر */
          padding: 5px 10px !important; /* تصغير حجم الزر */
          font-size: 11px !important; /* تصغير الخط */
          border-radius: 8px !important;
        }

        .castle-action-btn span.material-icons {
          font-size: 20px !important; /* تصغير الأيقونات (التاج، الدرع، الإغلاق) */
          margin-bottom: 2px !important;
        }
      }
      /* --- إصلاح جذري لنافذة تطوير القلعة (تصميم أنيق وصغير) --- */
      /* --- إصلاح نافذة الجيش (الثكنات) للوضع الأفقي --- */
      @media screen and (max-height: 500px) {
        /* 1. تصغير النافذة وتوسيطها */
        #military-modal .modal-content {
          margin-top: 50px;
          width: 75% !important; /* عرض معقول */
          max-width: 500px !important;
          height: 90vh !important; /* استغلال ارتفاع الشاشة */
          background: #111 !important; /* خلفية داكنة */
          border: 1px solid #444 !important;
        }

        /* 2. تحسين أزرار التبويب (مشاة، رماة...) */
        .military-tabs {
          background: #000 !important;
        }
        .tab-btn {
          padding: 8px 0 !important;
          font-size: 11px !important; /* خط صغير */
        }

        /* 3. تحويل بطاقة الجندي إلى شريط أفقي أنيق */
        .unit-card {
          display: flex !important;
          flex-direction: row !important; /* جعل المحتوى بجانب بعضه وليس فوق بعض */
          justify-content: space-between !important;
          align-items: center !important;
          padding: 5px 10px !important; /* تقليل الحواشي */
          margin-bottom: 6px !important; /* تقليل المسافة بين البطاقات */
          background: rgba(255, 255, 255, 0.03) !important;
          border: 1px solid rgba(255, 255, 255, 0.05) !important;
          min-height: 45px !important; /* ارتفاع صغير وثابت */
        }

        /* 4. تنسيق معلومات الوحدة (الاسم والإحصائيات) */
        .unit-info {
          text-align: right !important;
          flex: 1 !important;
        }

        .unit-info h3 {
          font-size: 13px !important; /* تصغير الاسم */
          margin: 0 0 2px 0 !important;
          color: #f1c40f !important;
        }

        .unit-info small {
          display: none !important; /* إخفاء جملة "تملك كذا" لتوفير المساحة */
        }

        .unit-stats {
          gap: 5px !important;
        }

        /* تصغير مربعات الأرقام (هجوم/دفاع) */
        .stat-badge {
          padding: 1px 5px !important;
          font-size: 10px !important;
          border-radius: 3px !important;
        }

        /* 5. تحسين منطقة الشراء (الزر والرقم) */
        .recruit-actions {
          display: flex !important;
          align-items: center !important;
          gap: 8px !important;
          width: auto !important; /* إلغاء العرض الكامل */
          margin-top: 0 !important;
        }

        .recruit-input {
          width: 40px !important; /* مربع إدخال صغير */
          height: 25px !important;
          font-size: 12px !important;
          padding: 2px !important;
          margin: 0 !important;
        }

        .recruit-btn {
          padding: 4px 12px !important;
          font-size: 11px !important;
          height: 28px !important;
          background: linear-gradient(180deg, #27ae60, #219150) !important;
        }

        /* إخفاء تفاصيل التكلفة لتوفير المساحة (أو تصغيرها جداً) */
        .unit-info div[style*="font-size:11px"] {
          font-size: 9px !important;
          color: #888 !important;
        }
      }
      /* --- إصلاح نافذة كود الهدايا (Gift Code) للوضع الأفقي --- */
      @media screen and (max-height: 500px) {
        /* 1. تصغير النافذة وضبط الخلفية */
        #gift-modal .modal-content {
          margin-top: 50px;
          width: 50% !important;
          max-width: 380px !important;
          height: auto !important; /* الارتفاع يتناسب مع المحتوى */
          min-height: 220px !important;
          background: #151515 !important; /* خلفية سوداء أنيقة */
          border: 1px solid #444 !important;
          border-radius: 12px !important;
        }

        /* 2. تنسيق الرأس (Header) */
        #gift-modal .modal-header {
          background: #000 !important;
          border-bottom: 2px solid #2ecc71 !important; /* خط أخضر (لون الهدايا) */
          padding: 8px 15px !important;
        }

        #gift-modal .modal-header h2 {
          font-size: 14px !important;
          color: #fff !important;
        }

        /* 3. تنسيق المحتوى الداخلي (تصغير الحواشي) */
        /* نستهدف الـ div الذي يحتوي على الحشو الكبير */
        #gift-modal .modal-content > div:last-child {
          padding: 15px !important;
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          gap: 10px; /* مسافة بين العناصر */
        }

        /* 4. تصغير النص (أدخل الكود للحصول على...) */
        #gift-modal p {
          font-size: 12px !important;
          color: #aaa !important;
          margin: 0 !important;
        }

        /* 5. تحسين شكل مربع الإدخال (Input) */
        #gift-code-input {
          width: 90% !important;
          height: 30px !important; /* ارتفاع مناسب للإصبع */
          font-size: 16px !important;
          background: #222 !important;
          border: 1px solid #555 !important;
          color: #f1c40f !important; /* نص ذهبي */
          border-radius: 6px !important;
          margin-bottom: 5px !important; /* تقليل المسافة السفلية */
        }

        #gift-code-input:focus {
          border-color: #f1c40f !important;
          outline: none !important;
        }

        /* 6. تحسين زر التحقق */
        #gift-modal .recruit-btn {
          width: 90% !important;
          padding: 10px !important;
          font-size: 14px !important;
          background: linear-gradient(180deg, #27ae60, #1e8449) !important;
          border-radius: 6px !important;
        }
      }
      /* --- إصلاح نافذة البريد العسكري (التقارير) للوضع الأفقي --- */
      @media screen and (max-height: 500px) {
        /* 1. تصغير حجم النافذة ككل */
        #reports-modal .modal-content {
          margin-top: 50px;
          width: 65% !important; /* عرض متوسط */
          max-width: 450px !important;
          height: 85vh !important; /* ارتفاع مناسب */
          background: #121212 !important; /* خلفية داكنة */
          border: 1px solid #444 !important;
        }

        /* 2. تحسين منطقة عرض التقارير */
        #reports-list {
          padding: 10px !important;
          display: flex !important;
          flex-direction: column !important;
          gap: 8px !important; /* مسافة متساوية بين التقارير */
        }

        /* 3. إعادة تصميم بطاقة التقرير الواحدة */
        .report-item {
          padding: 8px 12px !important;
          background: rgba(255, 255, 255, 0.04) !important;
          border: 1px solid rgba(255, 255, 255, 0.05) !important;
          border-radius: 6px !important;
          margin-bottom: 0 !important; /* إزالة الهوامش الزائدة */
          /* ضبط الخط الجانبي (أخضر/أحمر) ليكون أنحف */
          border-right-width: 3px !important;
        }

        /* 4. تنسيق رأس التقرير (انتصار - ضد فلان) */
        .report-header {
          font-size: 12px !important;
          margin-bottom: 3px !important;
          justify-content: space-between !important;
        }

        /* 5. تصغير نص تفاصيل القوة */
        .report-item div[style*="color:#ccc"] {
          font-size: 10px !important;
          color: #888 !important;
        }

        /* 6. تحسين عرض الغنائم (الموارد المكتسبة) */
        .report-loot {
          font-size: 11px !important;
          margin-top: 3px !important;
          gap: 10px !important;
        }

        /* 7. تصغير التاريخ والوقت */
        .report-time {
          font-size: 9px !important;
          color: #555 !important;
          margin-top: 2px !important;
        }
      }
      /* --- إصلاح نافذة خيارات التفاعل (هجوم/تبرع) للوضع الأفقي --- */
      @media screen and (max-height: 500px) {
        /* 1. تصغير النافذة ومنع تمددها */
        #action-modal .modal-content {
          margin-top: 50px;
          width: auto !important; /* العرض حسب المحتوى فقط */
          min-width: 320px !important; /* حد أدنى للعرض */
          max-width: 400px !important; /* حد أقصى للعرض */
          height: auto !important; /* الارتفاع تلقائي */
          background: #151515 !important;
          border: 1px solid #444 !important;
          border-radius: 12px !important;
        }

        /* 2. تحسين الرأس (Header) */
        #action-modal .modal-header {
          padding: 8px 15px !important;
          background: #000 !important;
          border-bottom: 1px solid #333 !important;
        }

        #action-modal .modal-header h2 {
          font-size: 14px !important;
          color: #fff !important;
        }

        /* 3. تقليل الحواشي حول الأزرار */
        .action-btn-container {
          padding: 20px !important; /* تقليل المسافة الداخلية */
          gap: 15px !important; /* تقريب الأزرار من بعضها */
          display: flex !important;
          justify-content: center !important;
        }

        /* 4. تصميم الأزرار (تصغير الحجم وتنسيق الأيقونات) */
        .action-choice-btn {
          flex: 1 !important; /* توزيع متساوي */
          padding: 15px 10px !important; /* تصغير الحجم */
          border-radius: 10px !important;
          font-size: 13px !important; /* خط أصغر */
          font-weight: bold !important;
          background: rgba(255, 255, 255, 0.05) !important;
          border-width: 1px !important;
          /* تأثير انتقال ناعم */
          transition: transform 0.2s, background 0.2s !important;
        }

        /* 5. تصغير الأيقونات داخل الأزرار */
        .action-choice-btn span.material-icons {
          font-size: 28px !important; /* تصغير الأيقونة الضخمة */
          margin-bottom: 8px !important;
        }

        /* تحسين زر الحرب */
        .action-choice-btn.attack {
          border-color: #c0392b !important;
          color: #e74c3c !important;
        }

        /* تحسين زر التبرع */
        .action-choice-btn.donate {
          border-color: #27ae60 !important;
          color: #2ecc71 !important;
        }
      }
      /* --- إصلاح نافذة الهجوم (غرفة الحرب) للوضع الأفقي --- */
      @media screen and (max-height: 500px) {
        /* 1. ضبط حجم النافذة وتنسيقها العام */
        #attack-modal .modal-content {
          margin-top: 50px;
          width: 60% !important; /* عرض متوسط */
          max-width: 450px !important;
          height: 90vh !important; /* استغلال الارتفاع */
          background: #1a0505 !important; /* خلفية سوداء مائلة للأحمر الداكن جداً */
          border: 1px solid #c0392b !important; /* إطار أحمر دموي */
          border-radius: 12px !important;
          display: flex !important;
          flex-direction: column !important;
        }

        /* 2. تحسين الرأس (Header) */
        #attack-modal .modal-header {
          background: linear-gradient(90deg, #500000, #000) !important;
          padding: 8px 15px !important;
          border-bottom: 2px solid #800000 !important;
        }

        #attack-modal .attack-header-title {
          font-size: 14px !important;
          text-shadow: none !important;
        }

        /* 3. تحسين منطقة النص "اختر الجنود" */
        #attack-modal .modal-content > div:nth-child(2) {
          padding: 5px !important;
          background: rgba(0, 0, 0, 0.3) !important;
        }
        #attack-modal .modal-content > div:nth-child(2) p {
          font-size: 11px !important;
          color: #888 !important;
        }

        /* 4. قائمة الجنود (القائمة المنزلقة) */
        #attack-units-list {
          flex: 1 !important; /* تملأ المساحة المتبقية */
          overflow-y: auto !important;
          padding: 10px !important;
          display: flex !important;
          flex-direction: column !important;
          gap: 5px !important;
        }

        /* 5. تصميم شريط الجندي الواحد */
        .attack-unit-row {
          padding: 5px 10px !important;
          background: rgba(
            255,
            0,
            0,
            0.05
          ) !important; /* خلفية حمراء شفافة جداً */
          border: 1px solid rgba(192, 57, 43, 0.3) !important;
          border-radius: 6px !important;
          display: flex !important;
          justify-content: space-between !important;
          align-items: center !important;
          min-height: 40px !important;
        }

        /* نصوص واسم الجندي */
        .attack-unit-name {
          font-size: 12px !important;
          margin-bottom: 2px !important;
        }
        .attack-unit-avail {
          font-size: 10px !important;
          color: #aaa !important;
        }

        /* 6. شريط القوة الإجمالية (أسفل القائمة) */
        #attack-modal .modal-content > div:nth-last-child(2) {
          padding: 8px 15px !important;
          background: #2c0505 !important; /* أحمر داكن */
          border-top: 1px solid #500 !important;
          font-size: 12px !important;
        }

        #attack-total-power {
          font-size: 16px !important;
        }

        /* 7. زر إعلان الحرب */
        .war-btn {
          width: 100% !important;
          padding: 12px !important;
          font-size: 14px !important;
          background: linear-gradient(180deg, #c0392b, #922b21) !important;
          border-radius: 0 0 12px 12px !important;
          margin: 0 !important;
        }
      }
      /* --- إصلاح نافذة التبرع (إرسال دعم) للوضع الأفقي --- */
      @media screen and (max-height: 500px) {
        /* 1. ضبط حجم النافذة وتنسيق الخلفية */
        #donation-modal .modal-content {
          margin-top: 50px;
          width: 60% !important; /* عرض متوسط */
          max-width: 450px !important;
          height: 90vh !important; /* استغلال الارتفاع */
          background: #0a150a !important; /* أسود مائل للأخضر الداكن جداً */
          border: 1px solid #2ecc71 !important; /* إطار أخضر */
          border-radius: 12px !important;
          display: flex !important;
          flex-direction: column !important;
        }

        /* 2. تحسين الرأس (Header) */
        #donation-modal .modal-header {
          background: linear-gradient(90deg, #145a32, #000) !important;
          padding: 8px 15px !important;
          border-bottom: 2px solid #27ae60 !important;
        }

        #donation-modal .modal-header h2 {
          font-size: 14px !important;
          color: #2ecc71 !important;
        }

        /* 3. منطقة المحتوى القابلة للتمرير */
        #donation-body {
          flex: 1 !important; /* تملأ المساحة المتبقية */
          overflow-y: auto !important; /* السماح بالتمرير */
          padding: 10px !important;
          display: flex !important;
          flex-direction: column !important;
          gap: 5px !important;
        }

        /* 4. تنسيق أقسام الموارد (الذهب، الخشب...) */
        .donation-section {
          padding: 5px 10px !important;
          background: rgba(46, 204, 113, 0.05) !important;
          border-radius: 6px !important;
          border-bottom: none !important;
          margin-bottom: 5px !important;
        }

        .donation-label {
          font-size: 11px !important;
          color: #2ecc71 !important;
          margin-bottom: 2px !important;
        }

        /* جعل شريط التمرير والرقم بجانب بعضهما */
        .donation-row {
          display: flex !important;
          align-items: center !important;
          gap: 10px !important;
          margin: 0 !important;
        }

        /* تحسين شكل الرقم */
        .donation-row span {
          font-size: 11px !important;
          background: #000 !important;
          padding: 2px 6px !important;
          border-radius: 4px !important;
          color: #fff !important;
          min-width: 40px !important;
        }

        /* تحسين شريط التمرير (Slider) */
        input[type="range"] {
          height: 4px !important; /* تنحيف الشريط */
        }

        /* 5. زر إرسال القافلة */
        .donate-btn {
          width: 100% !important;
          padding: 12px !important;
          font-size: 14px !important;
          background: linear-gradient(180deg, #27ae60, #1e8449) !important;
          border-radius: 0 0 12px 12px !important; /* تدوير الحواف السفلية فقط */
          margin: 0 !important;
          box-shadow: none !important;
        }
      }
      /* --- عكس أماكن أزرار اليمين واليسار --- */
      .control-row-middle {
        flex-direction: row-reverse !important;
      }
    </style>
    <style>
      /* --- إصلاح جذري لنافذة تطوير القلعة (تصميم أنيق وصغير) --- */
      @media screen and (max-height: 500px) {
        /* 1. تصغير إطار النافذة وإصلاح الخلفية */
        #upgrade-modal .modal-content {
          overflow: auto;
          width: 60% !important; /* عرض متوسط */
          max-width: 350px !important; /* لا تتجاوز هذا العرض */
          max-height: 90vh !important; /* ارتفاع مناسب للشاشة */
          background: rgba(
            15,
            15,
            20,
            0.98
          ) !important; /* لون داكن موحد (بدون تدرجات غريبة) */
          border: 1px solid #444 !important;
          border-radius: 10px !important;
          display: flex;
          flex-direction: column;
        }

        /* 2. إصلاح الرأس (إزالة الألوان المتحركة البشعة) */
        #upgrade-modal .modal-header {
          background: #000 !important; /* أسود بسيط */
          border-bottom: 2px solid #f1c40f !important; /* خط ذهبي أنيق */
          padding: 8px 15px !important; /* تقليل الحواشي */
          animation: none !important; /* إيقاف الألوان المتحركة */
        }

        #upgrade-modal .modal-header h2 {
          font-size: 14px !important; /* تصغير عنوان النافذة */
          color: #fff !important;
        }

        /* 3. تنسيق المحتوى الداخلي */
        .upgrade-details {
          padding: 10px !important;
          display: flex;
          flex-direction: column;
          justify-content: center;
          gap: 5px; /* مسافة صغيرة بين العناصر */
        }

        /* إخفاء جملة "ترقية القلعة" لأن العنوان يكفي */
        .upgrade-details p {
          display: none !important;
        }

        /* 4. تصغير نص المستوى (Level X -> Level Y) */
        .lvl-badge {
          font-size: 18px !important; /* تصغير الخط بشكل كبير */
          color: #f1c40f !important;
          margin-bottom: 5px !important;
          text-shadow: none !important; /* إزالة التوهج المزعج */
          font-weight: bold;
        }

        /* 5. تحسين قائمة الموارد المطلوبة */
        .resource-row {
          padding: 2px 0 !important; /* تقليل المسافات */
          font-size: 12px !important; /* خط صغير وواضح */
          border-bottom: 1px solid #333 !important;
          display: flex;
          justify-content: space-between;
        }

        /* 6. تحسين زر التأكيد */
        .confirm-upgrade-btn {
          margin-top: 10px !important;
          padding: 8px !important;
          font-size: 13px !important;
          background: linear-gradient(
            180deg,
            #2980b9,
            #1a5276
          ) !important; /* أزرق هادئ */
          border-radius: 6px !important;
          width: 100% !important;
        }
      }
      /* --- إصلاح لوحة التحكم (Admin Panel) للوضع الأفقي --- */
      @media screen and (max-height: 500px) {
        /* 1. تحسين الإطار الخارجي للوحة */
        .admin-modal-content {
          width: 85% !important; /* لا تجعلها تملأ الشاشة بالكامل */
          max-width: 600px !important;
          height: 85vh !important; /* ارتفاع مناسب */
          background: #111 !important; /* خلفية داكنة أنيقة */
          border: 1px solid #f1c40f !important; /* إطار ذهبي نحيف */
          border-radius: 12px !important;
          overflow: hidden !important;
        }

        /* 2. شريط التبويبات (Tabs) - جعلها تسحب لليسار واليمين */
        .admin-tabs {
          display: flex !important;
          flex-wrap: nowrap !important; /* منع نزول التبويبات للسطر الثاني */
          overflow-x: auto !important; /* تفعيل التمرير الأفقي إذا كثرت التبويبات */
          background: #000 !important;
          border-bottom: 1px solid #333 !important;
          scrollbar-width: none; /* إخفاء شريط التمرير لشكل أنظف */
        }
        .admin-tabs::-webkit-scrollbar {
          display: none;
        }

        /* 3. تصميم التبويب الواحد (الأيقونة بجانب النص لتوفير المساحة) */
        .admin-tab {
          flex: 1 0 auto !important; /* يحافظ على حجم التبويب */
          padding: 12px 15px !important;
          font-size: 13px !important;
          font-weight: bold !important;
          display: flex !important;
          flex-direction: row !important; /* الأيقونة بجانب النص وليس تحته */
          align-items: center !important;
          justify-content: center !important;
          gap: 8px !important; /* مسافة بين الأيقونة والنص */
          color: #888 !important;
          background: transparent !important;
          border-bottom: 3px solid transparent !important;
          transition: 0.2s !important;
        }

        /* 4. تصميم التبويب النشط (مظهر عصري) */
        .admin-tab.active {
          color: #f1c40f !important; /* نص ذهبي */
          background: rgba(
            241,
            196,
            15,
            0.1
          ) !important; /* خلفية ذهبية شفافة جداً */
          border-bottom: 3px solid #f1c40f !important; /* خط سفلي فقط */
        }

        /* 5. محتوى الصفحات الداخلية */
        .admin-section {
          padding: 10px !important;
          overflow-y: auto !important;
        }

        /* 6. تصغير الجداول والحقول لتناسب الموبايل */
        .admin-table th,
        .admin-table td {
          padding: 6px !important;
          font-size: 11px !important;
        }

        .admin-input {
          padding: 8px !important;
          font-size: 12px !important;
        }

        .admin-btn-action {
          padding: 8px 12px !important;
          font-size: 13px !important;
        }
      }
      /* --- إصلاح نافذة تسجيل الدخول (Login) للوضع الأفقي --- */
      @media screen and (max-height: 500px) {
        /* 1. تصغير البطاقة الزجاجية */
        .glass-card {
          width: 50% !important; /* عرض متوسط */
          max-width: 350px !important; /* لا تتجاوز هذا العرض */
          padding: 25px 20px !important; /* تقليل الحواشي الداخلية */
          border-radius: 15px !important;
          background: rgba(
            20,
            20,
            20,
            0.95
          ) !important; /* خلفية داكنة أكثر وضوحاً */
        }

        /* 2. تصغير العنوان (أهلاً بك...) */
        .glass-card h2 {
          font-size: 18px !important;
          margin-bottom: 15px !important;
          color: #f1c40f !important;
        }

        /* 3. تحسين زر جوجل */
        .google-btn {
          padding: 10px !important; /* تصغير ارتفاع الزر */
          font-size: 14px !important; /* تصغير الخط */
          border-radius: 8px !important;
          gap: 10px !important; /* مسافة أقل بين الأيقونة والنص */
        }

        /* 4. تصغير أيقونة جوجل داخل الزر */
        .google-btn svg {
          width: 20px !important;
          height: 20px !important;
        }
      }
      /* --- تنسيقات الدبلوماسية (Diplomacy UI) --- */
      .dip-grid {
        display: grid;
        grid-template-columns: 1fr 1fr; /* عمودين متساويين */
        gap: 15px;
        margin-bottom: 15px;
      }

      .dip-col {
        display: flex;
        flex-direction: column;
        gap: 5px;
      }

      /* تحسينات الموبايل (Landscape) */
      @media screen and (max-height: 500px) {
        #diplomacy-modal .modal-content {
          margin-top: 50px;
          height: 90vh !important;
          max-width: 600px !important;
        }

        .dip-grid {
          gap: 10px !important;
          margin-bottom: 10px !important;
        }

        /* تصغير القوائم والحقول */
        #peace-target-select,
        #siege-target-select,
        #siege-type,
        #peace-duration {
          padding: 5px !important;
          font-size: 12px !important;
          height: 30px !important;
        }

        .admin-form-label {
          font-size: 11px !important;
          margin-bottom: 2px !important;
        }
      }
      /* --- إصلاح لوحة التحكم (Admin Panel) للوضع الأفقي (Mobile Landscape) --- */
      @media screen and (max-height: 500px) {
        /* 1. ضبط الإطار الخارجي ليكون مرناً ومناسباً للشاشة */
        .admin-modal-content {
          width: 70% !important; /* عرض أقل لتجنب الامتداد الزائد */
          max-width: 550px !important; /* حد أقصى للعرض */
          height: 92vh !important; /* استغلال 92% من ارتفاع الشاشة */
          margin: auto !important; /* توسيط */
          background: #121212 !important; /* خلفية داكنة موحدة */
          border: 1px solid #f1c40f !important;
          border-radius: 10px !important;

          /* تقنية Flexbox لضمان ثبات الرأس وتحريك المحتوى */
          display: flex !important;
          flex-direction: column !important;
          overflow: hidden !important; /* منع ظهور شريط تمرير خارجي */
        }

        /* 2. تصغير رأس النافذة (Header) */
        .admin-modal-content .modal-header {
          flex-shrink: 0 !important; /* منع التقلص */
          padding: 5px 10px !important;
          background: #000 !important;
          border-bottom: 1px solid #333 !important;
        }

        .admin-modal-content .modal-header h2 {
          font-size: 13px !important; /* تصغير العنوان */
        }

        /* 3. شريط التبويبات (Tabs) - جعله قابلاً للتمرير الأفقي إذا لزم الأمر */
        .admin-tabs {
          flex-shrink: 0 !important; /* منع التقلص */
          overflow-x: auto !important; /* السماح بالتمرير الأفقي للأزرار */
          white-space: nowrap !important; /* الأزرار بجانب بعضها */
          background: #1a1a1a !important;
          padding: 0 !important;
          height: 35px !important; /* ارتفاع ثابت صغير */
          display: flex !important;
          align-items: center !important;
          scrollbar-width: none; /* إخفاء شريط التمرير (Firefox) */
        }
        .admin-tabs::-webkit-scrollbar {
          display: none;
        } /* إخفاء شريط التمرير (Chrome) */

        /* تصميم الزر الواحد في التبويبات */
        .admin-tab {
          flex: none !important; /* إلغاء التمدد التلقائي */
          padding: 0 12px !important;
          font-size: 11px !important;
          height: 100% !important;
          display: flex !important;
          align-items: center !important;
          justify-content: center !important;
          border-bottom: 2px solid transparent !important;
        }

        .admin-tab.active {
          background: rgba(241, 196, 15, 0.15) !important;
          border-bottom-color: #f1c40f !important;
          color: #f1c40f !important;
        }

        /* 4. منطقة المحتوى (Content Area) - هي الوحيدة التي تقبل التمرير العمودي */
        .admin-section {
          flex-grow: 1 !important; /* تأخذ باقي المساحة المتاحة */
          overflow-y: auto !important; /* تفعيل التمرير العمودي هنا فقط */
          padding: 10px !important;
          display: none; /* مخفي افتراضياً */
        }

        .admin-section.active {
          display: block !important; /* يظهر عند التفعيل */
        }

        /* 5. تصغير الجداول (Tables) */
        .admin-table th,
        .admin-table td {
          padding: 4px 6px !important;
          font-size: 10px !important; /* خط صغير جداً للبيانات */
        }

        .btn-delete-user {
          padding: 2px 6px !important;
          font-size: 10px !important;
        }

        /* 6. تصغير النماذج والمدخلات (Inputs & Forms) */
        .admin-form-group {
          padding: 8px !important;
          margin-bottom: 8px !important;
          background: rgba(255, 255, 255, 0.03) !important;
        }

        .admin-form-label {
          font-size: 10px !important;
          margin-bottom: 2px !important;
        }

        .admin-input {
          padding: 4px !important;
          height: 25px !important;
          font-size: 11px !important;
        }

        .admin-btn-action {
          padding: 6px !important;
          font-size: 12px !important;
          margin-top: 5px !important;
        }
      }
      /* --- Ramadan Icon & Stars Styles --- */
#ramadan-container {
    position: fixed;
    top: 60px; /* أسفل الشريط العلوي */
    right: 20px; /* على اليمين */
    width: 70px;
    height: 70px;
    z-index: 11000; /* طبقة عالية جداً */
    cursor: pointer;
    display: flex;
    justify-content: center;
    align-items: center;
    transition: transform 0.3s;
}

#ramadan-container:hover {
    transform: scale(1.1) rotate(-10deg);
}

.ramadan-icon {
    width: 100%;
    height: 100%;
    object-fit: contain;
    filter: drop-shadow(0 0 5px rgba(255, 215, 0, 0.5));
}

/* حاوية النجوم */
.stars-wrapper {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
}

/* النجمة الفردية */
.r-star {
    position: absolute;
    background-color: #fff;
    width: 2px;
    height: 2px;
    border-radius: 50%;
    box-shadow: 0 0 4px #fff, 0 0 8px #f1c40f;
    opacity: 0;
    animation: twinkleStar 2s infinite ease-in-out;
}

@keyframes twinkleStar {
    0% { opacity: 0; transform: scale(0.5); }
    50% { opacity: 1; transform: scale(1.5); }
    100% { opacity: 0; transform: scale(0.5); }
}
    </style>
  </head>
  <body>
    <!-- عناصر الصوت -->
    <!-- تم تعديل كود الصوت ليعمل فقط بعد الضغط لتجنب حظر المتصفح -->
    <audio
      id="bg-music"
      src="magic-fantasy-fairy-tale-music-431276.mp3"
      loop
    ></audio>
    <audio id="alarm-sound" src="beep-warning-6387.mp3" loop></audio>

    <!-- شاشة البداية (Splash Screen) -->
    <div id="splash-screen">
      <img
        id="splash-logo"
        src="684eb59d-327f-4353-a31e-3a12640c54ae.jpg"
        alt="شعار اللعبة"
      />
      <div id="splash-text">من تطوير HOUCINE EZ</div>
    </div>

    <!-- تحذير تدوير الشاشة -->
    <div id="orientation-warning">
      <span class="material-icons">screen_rotation</span>
      <h2>يرجى تدوير الهاتف للعب</h2>
      <p>هذه اللعبة مصممة للعمل في الوضع الأفقي فقط.</p>
    </div>
    <!-- شاشة البداية (Splash Screen) -->
    <div id="splash-screen">
      <img
        id="splash-logo"
        src="684eb59d-327f-4353-a31e-3a12640c54ae.jpg"
        alt="شعار اللعبة"
      />
      <div id="splash-text">من تطوير HOUCINE EZ</div>
    </div>
    <!-- أيقونة رمضان مع النجوم -->
<div id="ramadan-container" onclick="openRamadanModal()">
    <!-- استبدل الرابط أدناه برابط الصورة التي رفعتها إذا لم تظهر -->
    <img src="Gemini_Generated_Image_lep5l8lep5l8lep5-removebg-preview (1).png" alt="Ramadan" class="ramadan-icon">
    <!-- النجوم (ستتم إضافتها بالكود) -->
    <div class="stars-wrapper" id="ramadan-stars"></div>
</div>
<!-- نافذة حدث رمضان -->
<div id="ramadan-modal" class="modal">
    <div class="modal-content" style="width: 400px; text-align: center; border-color: #f1c40f;">
        <div class="modal-header" style="background: linear-gradient(90deg, #1a1a1a, #2c3e50); border-bottom: 2px solid #f1c40f;">
            <h2 style="margin: 0; color: #f1c40f;">🌙 شهر رمضان المبارك</h2>
            <button class="close-modal" onclick="document.getElementById('ramadan-modal').style.display='none'">
                <span class="material-icons">close</span>
            </button>
        </div>
        <div style="padding: 40px; background: rgba(0,0,0,0.9);">
            <span class="material-icons" style="font-size: 60px; color: #f1c40f; margin-bottom: 20px; animation: pulseEvent 2s infinite;">nights_stay</span>
            <h2 style="color: #fff; font-family: 'Cairo'; margin-bottom: 10px;">حدث رمضان</h2>
            <p style="color: #ccc; font-size: 18px;">قريباً في اللعبة...</p>
            <p style="color: #f1c40f; font-size: 14px;">ترقبوا جوائز ومفاجآت خاصة!</p>
        </div>
    </div>
</div>
    <!-- واجهة التحذير من الهجوم -->
    <div id="attack-warning-overlay">
      <div id="attack-warning-text">⚠️ تحذير: القلعة تحت الهجوم! ⚠️</div>
    </div>

    <!-- شريط المعلومات العلوي -->
    <nav id="game-navbar">
      <div class="nav-item">
        مستوى القلعة<span id="ui-lvl" class="nav-value">1</span>
      </div>
      <div class="nav-item">
        الذهب<span id="ui-gold" class="nav-value">0</span>
      </div>
      <div class="nav-item">
        الخشب<span id="ui-wood" class="nav-value">0</span>
      </div>
      <div class="nav-item">
        الفضة<span id="ui-silver" class="nav-value">0</span>
      </div>
      <div class="nav-item">
        القوة<span id="ui-power" class="nav-value">0</span>
      </div>
    </nav>

    <!-- EVENT TICKER -->
    <div id="event-ticker-container">The Blood Event has started</div>

    <!-- شاشة الدخول -->
    <div id="ui-container">
      <div id="login-form" class="glass-card">
        <button id="google-login-btn" class="google-btn">
          <!-- SVG Google -->
          <svg
            width="24"
            height="24"
            viewBox="0 0 24 24"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"
              fill="#4285F4"
            />
            <path
              d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"
              fill="#34A853"
            />
            <path
              d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"
              fill="#FBBC05"
            />
            <path
              d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"
              fill="#EA4335"
            />
          </svg>
          <span>تسجيل الدخول </span>
        </button>
      </div>
    </div>

    <!-- NEW SIDEBAR STRUCTURE -->
    <!-- START SIDEBAR -->
    <div id="sidebar-container">
      <!-- زر الفتح والإغلاق -->
      <div class="sidebar-toggle-btn" onclick="toggleSidePanel()">
        <span class="material-icons">menu_open</span>
      </div>

      <!-- محتويات القائمة -->
      <button
        class="sidebar-btn"
        onclick="openReportsModal(); toggleSidePanel()"
      >
        <span class="material-icons">mail</span> البريد
        <span
          id="mail-badge"
          style="
            display: none;
            width: 8px;
            height: 8px;
            background: red;
            border-radius: 50%;
            margin-right: auto;
          "
        ></span>
      </button>

      <button class="sidebar-btn" onclick="openGiftModal(); toggleSidePanel()">
        <span class="material-icons">redeem</span> كود الهدايا
      </button>

      <button
        class="sidebar-btn blood"
        onclick="openBloodLeaderboard(); toggleSidePanel()"
      >
        <span class="material-icons">bloodtype</span> ترتيب القتلة (The Blood)
      </button>
      <!-- زر الدبلوماسية في القائمة الجانبية -->
      <button
        class="sidebar-btn"
        style="color: #3498db"
        onclick="openDiplomacyModal(); toggleSidePanel()"
      >
        <span class="material-icons">handshake</span> الدبلوماسية
      </button>

      <!-- زر الأدمن يظهر فقط للمشرفين -->
      <button
        id="admin-sidebar-btn"
        class="sidebar-btn"
        style="display: none; color: #f1c40f"
        onclick="attemptAdminLogin()"
      >
        <span class="material-icons">admin_panel_settings</span> لوحة الإدارة
      </button>
      <!-- full screan -->
      <button
        class="sidebar-btn"
        onclick="toggleFullScreen(); toggleSidePanel()"
      >
        <span class="material-icons">fullscreen</span> وضع ملء الشاشة
      </button>

      <button class="sidebar-btn" onclick="logoutUser()">
        <span class="material-icons">logout</span> تسجيل الخروج
      </button>

      <button class="sidebar-btn danger" onclick="deleteAccount()">
        <span class="material-icons">delete_forever</span> حذف الحساب
      </button>
    </div>
    <!-- END SIDEBAR -->

    <!-- NEW: نافذة كود الهدايا -->
    <div id="gift-modal" class="modal">
      <div class="modal-content" style="width: 400px; text-align: center">
        <div class="modal-header">
          <h2 style="margin: 0; color: #fff">كود الهدايا</h2>
          <button
            class="close-modal"
            onclick="document.getElementById('gift-modal').style.display='none'"
          >
            <span class="material-icons">close</span>
          </button>
        </div>
        <div style="padding: 30px">
          <p style="color: #ccc">أدخل الكود للحصول على الذهب والموارد:</p>
          <input
            type="text"
            id="gift-code-input"
            placeholder="اكتب الكود هنا..."
            style="
              width: 80%;
              padding: 10px;
              border-radius: 5px;
              border: 1px solid #555;
              background: #222;
              color: #f1c40f;
              font-size: 18px;
              text-align: center;
              margin-bottom: 20px;
            "
          />
          <button class="recruit-btn" onclick="verifyGiftCode()">
            تحقق من الكود
          </button>
        </div>
      </div>
    </div>

    <!-- ADMIN MODAL -->
    <div id="admin-modal" class="modal">
      <div class="modal-content admin-modal-content">
        <div class="modal-header">
          <h2 style="margin: 0; color: #f1c40f">لوحة التحكم - الإدارة</h2>
          <button
            class="close-modal"
            onclick="document.getElementById('admin-modal').style.display='none'"
          >
            <span class="material-icons">close</span>
          </button>
        </div>
        <div class="admin-tabs">
          <div class="admin-tab active" onclick="switchAdminTab('players')">
            اللاعبين
          </div>
          <div class="admin-tab" onclick="switchAdminTab('codes')">الأكواد</div>
          <div class="admin-tab" onclick="switchAdminTab('events')">
            الأحداث
          </div>
          <!-- تبويب العقوبات (للآدمن والمشرفين) -->
          <div class="admin-tab" onclick="switchAdminTab('sanctions')">
            العقوبات ⚖️
          </div>
          <!-- تبويب المشرفين (للآدمن فقط - يظهر عبر JS) -->
          <div
            id="tab-moderators"
            class="admin-tab"
            style="display: none; color: #3498db"
            onclick="switchAdminTab('moderators')"
          >
            المشرفين 👮‍♂️
          </div>
        </div>

        <!-- قسم اللاعبين -->
        <div id="admin-sec-players" class="admin-section active">
          <div
            style="
              display: flex;
              justify-content: space-between;
              margin-bottom: 15px;
            "
          >
            <h3 style="color: white; margin: 0">قائمة اللاعبين المسجلين</h3>
            <button class="recruit-btn" onclick="loadAdminPlayers()">
              تحديث القائمة
            </button>
          </div>
          <div class="admin-table-container">
            <table class="admin-table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>الاسم</th>
                  <th>البريد (Gmail)</th>
                  <th>Castle Level</th>
                  <!-- New Column -->
                  <th>الذهب</th>
                  <th>الفضة</th>
                  <th>الخشب</th>
                  <th>القوة</th>
                  <th>إجراء</th>
                </tr>
              </thead>
              <tbody id="admin-players-body">
                <!-- Rows will be injected here -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- قسم صناعة الأكواد (UPDATED) -->
        <div id="admin-sec-codes" class="admin-section">
          <h3 style="color: #f1c40f; text-align: center">
            مولد أكواد الهدايا المتقدم
          </h3>
          <div class="admin-form-group">
            <label class="admin-form-label">رمز الكود (مثلاً: KING2026):</label>
            <input
              type="text"
              id="adm-code-text"
              class="admin-input"
              placeholder="أدخل الكود هنا"
            />
          </div>

          <div class="admin-form-group">
            <label class="admin-form-label">مدة الصلاحية (بالساعات):</label>
            <input
              type="number"
              id="adm-code-duration"
              class="admin-input"
              value="24"
            />
          </div>

          <div class="admin-form-group">
            <label class="admin-form-label">محتوى الهدية (الموارد):</label>
            <div style="display: flex; gap: 10px">
              <input
                type="number"
                id="adm-g-reward"
                class="admin-input"
                placeholder="ذهب"
              />
              <input
                type="number"
                id="adm-s-reward"
                class="admin-input"
                placeholder="فضة"
              />
              <input
                type="number"
                id="adm-w-reward"
                class="admin-input"
                placeholder="خشب"
              />
            </div>
          </div>

          <div class="admin-form-group">
            <label class="admin-form-label"
              >محتوى الهدية (الجيش - Advanced):</label
            >
            <div id="adm-unit-list-container">
              <!-- Dynamic Rows Here -->
            </div>
            <button
              class="recruit-btn"
              style="margin-top: 10px; font-size: 12px"
              onclick="addCodeUnitRow()"
            >
              + إضافة وحدة
            </button>
          </div>

          <button class="admin-btn-action" onclick="createGiftCode()">
            إنشاء الكود
          </button>
        </div>

        <!-- قسم الأحداث (The Blood) -->
        <div id="admin-sec-events" class="admin-section">
          <h2 style="color: #e74c3c; text-align: center; margin-bottom: 20px">
            🩸 The Blood Event
          </h2>

          <div class="admin-form-group" style="text-align: center">
            <p style="color: #ccc">
              تحكم في حدث الدم. عند البدء، سيظهر الترتيب والإشعار لجميع
              اللاعبين.
            </p>

            <button
              id="btn-start-event"
              class="event-control-btn event-start"
              onclick="startTheBloodEvent()"
            >
              Start Event
            </button>
            <button
              id="btn-stop-event"
              class="event-control-btn event-stop"
              onclick="stopTheBloodEvent()"
              disabled
            >
              Stop Event
            </button>

            <p id="event-status-text" style="color: #888">الحالة: متوقف</p>
          </div>
        </div>

        <!-- قسم العقوبات (الجديد) -->
        <div id="admin-sec-sanctions" class="admin-section">
          <h3 style="color: #e74c3c; text-align: center">
            إدارة العقوبات والمخالفات
          </h3>
          <button class="recruit-btn" onclick="loadSanctionsList()">
            تحديث القائمة
          </button>
          <div class="admin-table-container">
            <table class="admin-table">
              <thead>
                <tr>
                  <th>الاسم</th>
                  <th>الحالة</th>
                  <!-- هل عليه عقوبات؟ -->
                  <th>إجراء</th>
                </tr>
              </thead>
              <tbody id="admin-sanctions-body"></tbody>
            </table>
          </div>
        </div>

        <!-- قسم المشرفين (الجديد - للآدمن فقط) -->
        <div id="admin-sec-moderators" class="admin-section">
          <h3 style="color: #3498db; text-align: center">إدارة المشرفين</h3>
          <div class="admin-form-group">
            <label class="admin-form-label">إضافة مشرف جديد (Gmail):</label>
            <input
              type="email"
              id="new-mod-email"
              class="admin-input"
              placeholder="example@gmail.com"
            />
            <button
              class="admin-btn-action"
              style="background: #3498db; margin-top: 10px"
              onclick="addModerator()"
            >
              إضافة مشرف
            </button>
          </div>
          <hr style="border-color: #444" />
          <h4 style="color: white">قائمة المشرفين الحالية:</h4>
          <ul
            id="moderators-list"
            style="color: #ccc; list-style: none; padding: 0"
          ></ul>
        </div>
      </div>
    </div>

    <!-- نافذة تطبيق العقوبة (Modal منفصل) -->
    <div id="sanction-action-modal" class="modal">
      <div class="modal-content" style="width: 400px; border-color: #e74c3c">
        <div class="modal-header" style="background: #500000">
          <h2 style="margin: 0; color: #fff">تطبيق عقوبة</h2>
          <button
            class="close-modal"
            onclick="document.getElementById('sanction-action-modal').style.display='none'"
          >
            <span class="material-icons">close</span>
          </button>
        </div>
        <div style="padding: 20px; color: white">
          <p>
            اللاعب:
            <span
              id="sanction-target-name"
              style="color: #f1c40f; font-weight: bold"
            ></span>
          </p>
          <input type="hidden" id="sanction-target-id" />

          <div class="admin-form-group" style="background: #220000">
            <label
              class="admin-form-label"
              style="
                display: flex;
                align-items: center;
                gap: 10px;
                cursor: pointer;
              "
            >
              <input
                type="checkbox"
                id="chk-no-mining"
                style="width: 20px; height: 20px"
              />
              منع جمع الموارد
            </label>
            <label
              class="admin-form-label"
              style="
                display: flex;
                align-items: center;
                gap: 10px;
                cursor: pointer;
              "
            >
              <input
                type="checkbox"
                id="chk-no-recruit"
                style="width: 20px; height: 20px"
              />
              منع التجنيد
            </label>
            <label
              class="admin-form-label"
              style="
                display: flex;
                align-items: center;
                gap: 10px;
                cursor: pointer;
              "
            >
              <input
                type="checkbox"
                id="chk-no-attack"
                style="width: 20px; height: 20px"
              />
              منع الهجوم
            </label>
          </div>

          <button
            class="admin-btn-action"
            onclick="confirmSanctions()"
            style="background: #e74c3c"
          >
            تأكيد العقوبة
          </button>

          <!-- زر إلغاء العقوبة (يظهر للآدمن فقط عبر JS) -->
          <button
            id="btn-remove-sanctions"
            class="admin-btn-action"
            onclick="removeSanctions()"
            style="background: #888; margin-top: 10px; display: none"
          >
            إلغاء كافة العقوبات (Admin Only)
          </button>
        </div>
      </div>
    </div>

    <!-- Reward Setup Modal for The Blood -->
    <div id="event-rewards-modal" class="modal">
      <div class="modal-content" style="width: 500px">
        <div class="modal-header">
          <h2 style="margin: 0; color: #e74c3c">إعداد جوائز The Blood</h2>
          <button
            class="close-modal"
            onclick="document.getElementById('event-rewards-modal').style.display='none'"
          >
            <span class="material-icons">close</span>
          </button>
        </div>

        <!-- SCROLL FIX HERE -->
        <div
          style="
            padding: 20px;
            color: white;
            overflow-y: auto;
            max-height: 70vh;
          "
        >
          <p style="color: #aaa; margin-bottom: 15px">
            حدد الجوائز للفائزين الثلاثة الأوائل:
          </p>

          <!-- Rank 1 -->
          <h3 style="color: #f1c40f">المركز الأول 🥇</h3>
          <div class="admin-form-group">
            <input
              type="number"
              id="reward-r1-gold"
              class="admin-input"
              placeholder="Gold"
              style="margin-bottom: 5px"
            />
            <input
              type="number"
              id="reward-r1-silver"
              class="admin-input"
              placeholder="Silver"
              style="margin-bottom: 5px"
            />
            <input
              type="number"
              id="reward-r1-wood"
              class="admin-input"
              placeholder="Wood"
              style="margin-bottom: 5px"
            />
            <input
              type="text"
              id="reward-r1-army"
              class="admin-input"
              placeholder="Army (e.g., infantry_5:100)"
            />
          </div>

          <!-- Rank 2 -->
          <h3 style="color: #bdc3c7">المركز الثاني 🥈</h3>
          <div class="admin-form-group">
            <input
              type="number"
              id="reward-r2-gold"
              class="admin-input"
              placeholder="Gold"
              style="margin-bottom: 5px"
            />
            <input
              type="number"
              id="reward-r2-silver"
              class="admin-input"
              placeholder="Silver"
              style="margin-bottom: 5px"
            />
            <input
              type="number"
              id="reward-r2-wood"
              class="admin-input"
              placeholder="Wood"
              style="margin-bottom: 5px"
            />
            <input
              type="text"
              id="reward-r2-army"
              class="admin-input"
              placeholder="Army (e.g., infantry_5:50)"
            />
          </div>

          <!-- Rank 3 -->
          <h3 style="color: #d35400">المركز الثالث 🥉</h3>
          <div class="admin-form-group">
            <input
              type="number"
              id="reward-r3-gold"
              class="admin-input"
              placeholder="Gold"
              style="margin-bottom: 5px"
            />
            <input
              type="number"
              id="reward-r3-silver"
              class="admin-input"
              placeholder="Silver"
              style="margin-bottom: 5px"
            />
            <input
              type="number"
              id="reward-r3-wood"
              class="admin-input"
              placeholder="Wood"
              style="margin-bottom: 5px"
            />
            <input
              type="text"
              id="reward-r3-army"
              class="admin-input"
              placeholder="Army (e.g., infantry_5:20)"
            />
          </div>

          <button class="admin-btn-action" onclick="confirmStartTheBlood()">
            تأكيد وبدء الحدث
          </button>
        </div>
      </div>
    </div>

    <!-- The Blood Leaderboard Modal -->
    <div id="blood-leaderboard-modal" class="modal">
      <div class="modal-content" style="width: 500px; max-height: 80vh">
        <div
          class="modal-header"
          style="background: linear-gradient(90deg, #500000, #000)"
        >
          <h2 style="margin: 0; color: #e74c3c; display: flex; gap: 10px">
            <span class="material-icons">bloodtype</span> قائمة القتلة
          </h2>
          <button
            class="close-modal"
            onclick="document.getElementById('blood-leaderboard-modal').style.display='none'"
          >
            <span class="material-icons">close</span>
          </button>
        </div>
        <div
          style="
            padding: 20px;
            background: #111;
            overflow-y: auto;
            min-height: 300px;
          "
        >
          <div id="blood-leaderboard-list">
            <!-- Rows injected via JS -->
            <p style="color: #888; text-align: center">
              جاري تحميل البيانات...
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- NEW: القائمة المنبثقة التي تظهر عند الضغط على القلعة -->
    <div id="castle-controls-panel">
      <button
        class="castle-action-btn"
        onclick="openUpgradeModal(); document.getElementById('castle-controls-panel').style.display='none'"
      >
        <span class="material-icons">foundation</span> تطوير القلعة
      </button>
      <button
        class="castle-action-btn"
        onclick="militaryModal.style.display='flex'; renderUnits(); document.getElementById('castle-controls-panel').style.display='none'"
      >
        <span class="material-icons">security</span> تجنيد الجيش
      </button>
      <button
        class="castle-action-btn"
        style="border-bottom-color: #e74c3c"
        onclick="document.getElementById('castle-controls-panel').style.display='none'; document.getElementById('mobile-controls').style.display='flex'"
      >
        <span class="material-icons" style="color: #e74c3c">close</span> إغلاق
      </button>
      <!-- ... الأزرار الموجودة سابقاً ... -->
<button
  class="castle-action-btn"
  onclick="activateTeleportMode(); document.getElementById('castle-controls-panel').style.display='none'"
>
  <span class="material-icons">travel_explore</span> نقل القلعة
</button>
<!-- ... زر الإغلاق ... -->
    </div>

    <!-- النافذة المنبثقة: الجيش -->
    <div id="military-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2
            style="
              margin: 0;
              color: #f1c40f;
              display: flex;
              align-items: center;
              gap: 10px;
            "
          >
            <span class="material-icons">security</span> الثكنات العسكرية
          </h2>
          <button class="close-modal" onclick="closeMilitaryModal()">
            <span class="material-icons">close</span>
          </button>
        </div>
        <div class="military-tabs">
          <button class="tab-btn active" onclick="switchTab('infantry')">
            مشاة
          </button>
          <button class="tab-btn" onclick="switchTab('archers')">رماة</button>
          <button class="tab-btn" onclick="switchTab('cavalry')">فرسان</button>
          <button class="tab-btn" onclick="switchTab('siege')">مركبات</button>
        </div>
        <div class="military-body" id="units-list"></div>
      </div>
    </div>

    <!-- النافذة المنبثقة: التقارير (Barid) -->
    <div id="reports-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2
            style="
              margin: 0;
              color: #fff;
              display: flex;
              align-items: center;
              gap: 10px;
            "
          >
            <span class="material-icons">mail</span> البريد العسكري
          </h2>
          <button
            class="close-modal"
            onclick="document.getElementById('reports-modal').style.display='none'"
          >
            <span class="material-icons">close</span>
          </button>
        </div>
        <div class="military-body" id="reports-list">
          <p style="text-align: center; color: #888">جاري تحميل التقارير...</p>
        </div>
      </div>
    </div>

    <!-- النافذة المنبثقة: الاختيار (هجوم أو تبرع) -->
    <div id="action-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 style="margin: 0; color: #fff">خيارات التفاعل</h2>
          <button
            class="close-modal"
            onclick="document.getElementById('action-modal').style.display='none'"
          >
            <span class="material-icons">close</span>
          </button>
        </div>
        <div class="action-btn-container">
          <button class="action-choice-btn attack" onclick="chooseAttack()">
            <span class="material-icons" style="font-size: 40px">whatshot</span>
            <span>إعلان الحرب</span>
          </button>
          <button class="action-choice-btn donate" onclick="chooseDonate()">
            <span class="material-icons" style="font-size: 40px"
              >volunteer_activism</span
            >
            <span>تبرع بالموارد</span>
          </button>
        </div>
      </div>
    </div>

    <!-- النافذة المنبثقة: الهجوم -->
    <div id="attack-modal" class="modal">
      <div class="modal-content" style="border-color: #c0392b">
        <div class="modal-header">
          <h2
            class="attack-header-title"
            style="margin: 0; display: flex; align-items: center; gap: 10px"
          >
            <span class="material-icons">whatshot</span> غرفة الحرب
          </h2>
          <button class="close-modal" onclick="closeAttackModal()">
            <span class="material-icons">close</span>
          </button>
        </div>
        <div
          style="
            padding: 20px;
            background: rgba(0, 0, 0, 0.5);
            text-align: center;
          "
        >
          <p style="color: #ccc; margin: 0">اختر الجنود للمعركة.</p>
        </div>
        <div class="military-body" id="attack-units-list"></div>
        <div
          style="
            padding: 15px;
            background: #2c0505;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid #500;
          "
        >
          <span style="font-weight: bold; color: #aaa">القوة:</span>
          <span
            id="attack-total-power"
            style="
              font-size: 24px;
              color: #f1c40f;
              font-weight: bold;
              text-shadow: 0 0 10px red;
            "
            >0</span
          >
        </div>
        <button class="war-btn" onclick="launchAttack()">إعلان الحرب</button>
      </div>
    </div>

    <!-- النافذة المنبثقة: التبرع -->
    <div id="donation-modal" class="modal">
      <div class="modal-content" style="border-color: #27ae60">
        <div class="modal-header">
          <h2
            style="
              margin: 0;
              color: #2ecc71;
              display: flex;
              align-items: center;
              gap: 10px;
            "
          >
            <span class="material-icons">volunteer_activism</span> إرسال دعم
          </h2>
          <button class="close-modal" onclick="closeDonationModal()">
            <span class="material-icons">close</span>
          </button>
        </div>
        <div class="military-body" id="donation-body">
          <!-- الموارد -->
          <div class="donation-section">
            <span class="donation-label"> الذهب</span>
            <div class="donation-row">
              <span
                id="disp-donate-gold"
                style="min-width: 60px; text-align: center"
                >0</span
              >
              <input
                type="range"
                id="donate-gold"
                min="0"
                value="0"
                style="width: 100%; accent-color: #f1c40f"
                oninput="document.getElementById('disp-donate-gold').innerText = parseInt(this.value).toLocaleString()"
              />
            </div>
          </div>
          <div class="donation-section">
            <span class="donation-label"> الفضة</span>
            <div class="donation-row">
              <span
                id="disp-donate-silver"
                style="min-width: 60px; text-align: center"
                >0</span
              >
              <input
                type="range"
                id="donate-silver"
                min="0"
                value="0"
                style="width: 100%; accent-color: #bdc3c7"
                oninput="document.getElementById('disp-donate-silver').innerText = parseInt(this.value).toLocaleString()"
              />
            </div>
          </div>
          <div class="donation-section">
            <span class="donation-label"> الخشب</span>
            <div class="donation-row">
              <span
                id="disp-donate-wood"
                style="min-width: 60px; text-align: center"
                >0</span
              >
              <input
                type="range"
                id="donate-wood"
                min="0"
                value="0"
                style="width: 100%; accent-color: #d35400"
                oninput="document.getElementById('disp-donate-wood').innerText = parseInt(this.value).toLocaleString()"
              />
            </div>
          </div>

          <h3
            style="color: #fff; border-top: 1px solid #444; padding-top: 10px"
          >
            إرسال قوات (دعم عسكري)
          </h3>
          <div id="donation-units-list"></div>
        </div>
        <button class="donate-btn" onclick="sendDonation()">
          إرسال القافلة
        </button>
      </div>
    </div>

    <!-- النافذة المنبثقة: تطوير القلعة -->
    <div id="upgrade-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2
            style="
              margin: 0;
              color: #fff;
              display: flex;
              align-items: center;
              gap: 10px;
            "
          >
            <span class="material-icons">foundation</span> تطوير القلعة
          </h2>
          <button class="close-modal" onclick="closeUpgradeModal()">
            <span class="material-icons">close</span>
          </button>
        </div>
        <div class="upgrade-details">
          <p>ترقية القلعة</p>
          <span id="upg-next-lvl" class="lvl-badge">Level 2</span>
          <div id="upg-costs-container"></div>
          <div
            class="resource-row"
            style="
              margin-top: 20px;
              border: none;
              justify-content: center;
              gap: 10px;
            "
          >
            <span class="material-icons" style="color: #f1c40f">schedule</span>
            <span>الوقت المطلوب: </span>
            <span id="upg-time" style="color: #fff">5 دقائق</span>
          </div>
          <button
            id="confirm-upgrade-btn"
            class="confirm-upgrade-btn"
            onclick="executeUpgrade()"
          >
            تأكيد التطوير
          </button>
        </div>
      </div>
    </div>

    <!-- أزرار التحكم (MOBILE CONTROLS) -->
    <div id="mobile-controls">
      <div class="m-btn" id="m-up">
        <span class="material-icons">arrow_upward</span>
      </div>
      <div class="control-row-middle">
        <div class="m-btn" id="m-left">
          <span class="material-icons">arrow_back</span>
        </div>
        <div class="m-btn" id="m-right">
          <span class="material-icons">arrow_forward</span>
        </div>
      </div>
      <div class="m-btn" id="m-down">
        <span class="material-icons">arrow_downward</span>
      </div>
    </div>
    <!-- نافذة الدبلوماسية -->
    <div id="diplomacy-modal" class="modal">
      <div class="modal-content admin-modal-content">
        <!-- نستخدم نفس كلاس الأدمن لأنه مصمم جيداً للعرض -->
        <div
          class="modal-header"
          style="background: linear-gradient(90deg, #1a2a6c, #000)"
        >
          <h2 style="margin: 0; color: #3498db; display: flex; gap: 10px">
            <span class="material-icons">public</span> العلاقات الخارجية
          </h2>
          <button
            class="close-modal"
            onclick="document.getElementById('diplomacy-modal').style.display='none'"
          >
            <span class="material-icons">close</span>
          </button>
        </div>

        <!-- تبويبات داخلية -->
        <div class="admin-tabs">
          <div class="admin-tab active" onclick="switchDiplomacyTab('peace')">
            🕊️ معاهدة سلام
          </div>
          <div class="admin-tab" onclick="switchDiplomacyTab('siege')">
            ⚔️ حصار وعقوبات
          </div>
        </div>

        <!-- قسم معاهدة السلام -->
        <div
          id="dip-sec-peace"
          class="admin-section active"
          style="display: block"
        >
          <div class="dip-grid">
            <div class="dip-col">
              <label class="admin-form-label">اختر المملكة:</label>
              <select
                id="peace-target-select"
                class="dynamic-unit-select"
                style="width: 100%"
              ></select>
            </div>
            <div class="dip-col">
              <label class="admin-form-label">مدة الاتفاقية (ساعة):</label>
              <input
                type="number"
                id="peace-duration"
                class="admin-input"
                value="24"
                min="1"
              />
            </div>
          </div>
          <p
            style="
              color: #aaa;
              font-size: 12px;
              margin: 10px 0;
              text-align: center;
            "
          >
            <span
              class="material-icons"
              style="font-size: 14px; vertical-align: middle"
              >info</span
            >
            أثناء سريان الاتفاقية، يُمنع أي هجوم عسكري متبادل بين الطرفين
            نهائياً.
          </p>
          <button
            class="recruit-btn"
            style="
              width: 100%;
              background: linear-gradient(180deg, #2980b9, #1f618d);
            "
            onclick="proposePeace()"
          >
            إرسال عرض السلام 🕊️
          </button>
        </div>

        <!-- قسم الحصار -->
        <div id="dip-sec-siege" class="admin-section" style="display: none">
          <div class="dip-grid">
            <div class="dip-col">
              <label class="admin-form-label">المملكة المستهدفة:</label>
              <select
                id="siege-target-select"
                class="dynamic-unit-select"
                style="width: 100%"
              ></select>
            </div>
            <div class="dip-col">
              <label class="admin-form-label">نوع العقوبة:</label>
              <select
                id="siege-type"
                class="dynamic-unit-select"
                style="width: 100%"
              >
                <option value="economic">💰 حصار اقتصادي (خنق الموارد)</option>
                <option value="military">🛡️ حظر عسكري (تقييد الجيش)</option>
              </select>
            </div>
          </div>
          <div
            style="
              background: rgba(192, 57, 43, 0.1);
              padding: 10px;
              border-radius: 8px;
              margin: 10px 0;
              border: 1px solid rgba(192, 57, 43, 0.3);
            "
          >
            <p style="color: #e74c3c; font-size: 12px; margin: 0">
              ⚠️ نسبة العقوبة تعتمد على فارق القوة. لا يمكنك فرض حصار على مملكة
              أقوى منك بكثير.
            </p>
          </div>
          <button
            class="recruit-btn"
            style="
              width: 100%;
              background: linear-gradient(180deg, #27ae60, #1e8449);
            "
            onclick="declareSiege()"
          >
            فرض الحصار وتطبيق العقوبة ⚔️
          </button>
        </div>
      </div>
    </div>

    <!-- استيراد المكتبات -->
    <script type="importmap">
      {
        "imports": {
          "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
          "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/",
          "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
          "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
          "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
        }
      }
       </script>
    <!-- الكود البرمجي الرئيسي -->
    <script type="module">
      import { initializeApp } from "firebase/app";
      import {
        getAuth,
        signInWithPopup,
        GoogleAuthProvider,
        signOut,
        onAuthStateChanged,
        deleteUser,
      } from "firebase/auth";
      import {
        initializeFirestore,
        doc,
        getDoc,
        setDoc,
        updateDoc,
        addDoc,
        deleteDoc,
        increment,
        onSnapshot,
        persistentLocalCache,
        collection,
        query,
        orderBy,
        limit,
        getDocs,
        where,
        arrayUnion,
      } from "firebase/firestore";
      import * as THREE from "three";
      import { OrbitControls } from "three/addons/controls/OrbitControls.js";

      // --- 1. إعدادات وثوابت اللعبة ---
      const MINING_DURATION_MS = 1 * 60 * 1000;
      const REWARD_GOLD = 100000;
      const REWARD_SILVER = 500000;
      const REWARD_WOOD = 200000;
      const BASE_UPGRADE_COST = 100000;
      const BASE_UPGRADE_TIME_MIN = 5;

      // New Constants
      const MAX_DAILY_RESOURCE = 15000000;

      // --- إعدادات الإدارة ---
      const ADMIN_EMAIL = "houcinjibrane@gmail.com"; // Super Admin
      const ADMIN_PASSCODE = "********************";

      let isAdmin = false; // Is Super Admin?
      let isModerator = false; // Is Moderator?

      const firebaseConfig = {
        apiKey: "AIzaSyAdCRJlitQVOahuRb6qdHVYUtJocYNLWjI",
        authDomain: "game-of-throns-1b771.firebaseapp.com",
        projectId: "game-of-throns-1b771",
        storageBucket: "game-of-throns-1b771.firebasestorage.app",
        messagingSenderId: "680806420550",
        appId: "1:680806420550:web:67293ce47187ba9bfb3a47",
        measurementId: "G-0XTP3RZ5SR",
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      // FIX: Using simplified Firestore initialization to prevent multi-tab errors
      const db = initializeFirestore(app, {});

      // عناصر الواجهة
      const loginBtn = document.getElementById("google-login-btn");
      const loginForm = document.getElementById("login-form");
      const navbar = document.getElementById("game-navbar");
      const mobileControls = document.getElementById("mobile-controls");
      const castleControlsPanel = document.getElementById(
        "castle-controls-panel",
      );

      // Audio Elements
      // ملاحظة مهمة: تم نقل تشغيل الصوت إلى زر الدخول لتجنب أخطاء المتصفح
      const bgMusic = document.getElementById("bg-music");
      const alarmSound = document.getElementById("alarm-sound");
      const warningOverlay = document.getElementById("attack-warning-overlay");
      const mailBadge = document.getElementById("mail-badge");
      const eventTicker = document.getElementById("event-ticker-container");

      const uiGold = document.getElementById("ui-gold");
      const uiSilver = document.getElementById("ui-silver");
      const uiPower = document.getElementById("ui-power");
      const uiLvl = document.getElementById("ui-lvl");
      const uiWood = document.getElementById("ui-wood");

      let currentUser = null;
      let userDocData = null;
      let isBloodEventActive = false; // State for Event

      const otherCastles = {};
      let myCastleMesh = null;

      // متغيرات الهجوم والتفاعل
      let targetEnemyId = null;

      // إدارة النوافذ
      window.militaryModal = document.getElementById("military-modal");
      window.attackModal = document.getElementById("attack-modal");
      window.upgradeModal = document.getElementById("upgrade-modal");
      window.actionModal = document.getElementById("action-modal");
      window.donationModal = document.getElementById("donation-modal");
      window.reportsModal = document.getElementById("reports-modal");
      window.giftModal = document.getElementById("gift-modal");
      window.adminModal = document.getElementById("admin-modal");

      // --- SPLASH SCREEN LOGIC ---
      function initIntro() {
        const splash = document.getElementById("splash-screen");
        // Hide splash after 4 seconds
        setTimeout(() => {
          splash.style.opacity = "0";
          splash.style.pointerEvents = "none"; // منع التفاعل أثناء الاختفاء
          setTimeout(() => {
            splash.style.display = "none";
          }, 1500); // wait for fade out
        }, 4000);
      }
      // Call immediately
      initIntro();

      // --- NEW: Deterministic Random for Map Sync ---
      let seed = 123456;
      function seededRandom() {
        const x = Math.sin(seed++) * 10000;
        return x - Math.floor(x);
      }

      // --- NEW SIDEBAR LOGIC ---
      window.toggleSidePanel = () => {
        const p = document.getElementById("sidebar-container");
        p.classList.toggle("open");
      };

      window.openGiftModal = () => {
        giftModal.style.display = "flex";
      };

      // --- NEW: The Blood Leaderboard Logic ---
      window.openBloodLeaderboard = async () => {
        const modal = document.getElementById("blood-leaderboard-modal");
        const container = document.getElementById("blood-leaderboard-list");
        modal.style.display = "flex";
        container.innerHTML =
          "<p style='text-align:center; color:#888;'>جاري تحميل البيانات...</p>";

        try {
          // Sort by event kills (if tracked separately) or global kills.
          // Assuming 'eventKills' field in user doc for this specific event or global 'kills'
          const q = query(
            collection(db, "users"),
            orderBy("eventKills", "desc"),
            limit(50),
          );
          const snap = await getDocs(q);

          container.innerHTML = "";
          let rank = 1;

          if (snap.empty) {
            container.innerHTML =
              "<p style='text-align:center; color:#888;'>لا يوجد لاعبين في الترتيب بعد.</p>";
            return;
          }

          snap.forEach((doc) => {
            const d = doc.data();
            const kills = d.eventKills || 0;
            let rankClass = "";
            if (rank === 1) rankClass = "top-1";
            else if (rank === 2) rankClass = "top-2";
            else if (rank === 3) rankClass = "top-3";

            const div = document.createElement("div");
            div.className = `leaderboard-row ${rankClass}`;
            div.innerHTML = `
                  <div style="flex:1;">#${rank} ${d.username || "مجهول"}</div>
                  <div>☠️ ${kills}</div>
              `;
            container.appendChild(div);
            rank++;
          });
        } catch (e) {
          console.error(e);
          container.innerHTML =
            "<p style='color:red; text-align:center;'>خطأ في تحميل البيانات</p>";
        }
      };

      // --- NEW: التحقق من كود الهدية (ديناميكي) ---
      // --- NEW: التحقق من كود الهدية (ديناميكي مع منع التكرار) ---
      window.verifyGiftCode = async () => {
        const code = document.getElementById("gift-code-input").value.trim();
        if (!code) return alert("أدخل كود صالح");

        // 1. التحقق محلياً قبل الاتصال بالسيرفر (لتوفير الموارد)
        // نتأكد هل قام اللاعب باستخدام الكود من قبل والمخزن في بياناته
        if (
          userDocData.redeemedCodes &&
          userDocData.redeemedCodes.includes(code)
        ) {
          return alert(
            "⛔ لقد قمت باستخدام هذا الكود مسبقاً! لا يمكن استخدامه مرة أخرى.",
          );
        }

        try {
          // 2. جلب بيانات الكود من قاعدة البيانات
          const codeRef = doc(db, "gift_codes", code);
          const codeSnap = await getDoc(codeRef);

          if (!codeSnap.exists()) {
            return alert("❌ كود غير صحيح.");
          }

          const codeData = codeSnap.data();

          // 3. التحقق من الصلاحية الزمنية
          if (Date.now() > codeData.expiresAt) {
            return alert("⏰ هذا الكود منتهي الصلاحية.");
          }

          // 4. تجهيز الجوائز
          const reward = codeData.rewards;
          const update = {
            // إضافة الكود لقائمة المستخدم لمنع استخدامه مستقبلاً
            redeemedCodes: arrayUnion(code),
          };

          let msg = "🎉 تم قبول الهدية! حصلت على:\n";

          if (reward.gold) {
            update.gold = increment(reward.gold);
            msg += `- ${reward.gold} ذهب\n`;
          }
          if (reward.silver) {
            update.silver = increment(reward.silver);
            msg += `- ${reward.silver} فضة\n`;
          }
          if (reward.wood) {
            update.wood = increment(reward.wood);
            msg += `- ${reward.wood} خشب\n`;
          }

          // إضافة الجيش إذا وجد
          if (reward.units) {
            for (let uKey in reward.units) {
              update[`units.${uKey}`] = increment(reward.units[uKey]);

              // إضافة قوة الجيش للمستخدم (اختياري - لتحسين الواقعية)
              // يمكنك حساب القوة هنا وإضافتها للمتغير update.power

              msg += `- جيش دعم (${uKey}: ${reward.units[uKey]})\n`;
            }
          }

          // 5. تحديث بيانات المستخدم في قاعدة البيانات
          await updateDoc(doc(db, "users", currentUser.uid), update);

          alert(msg);
          document.getElementById("gift-code-input").value = "";
          giftModal.style.display = "none";
        } catch (err) {
          console.error(err);
          alert("حدث خطأ أثناء التحقق: " + err.message);
        }
      };

      window.logoutUser = () => {
        signOut(auth);
        if (bgMusic) bgMusic.pause();
        window.toggleSidePanel();
      };

      window.deleteAccount = async () => {
        if (
          !confirm(
            " هل أنت متأكد تماماً من حذف حسابك؟\nسيتم فقدان القلعة والجيوش والموارد نهائياً ولا يمكن استعادتها!",
          )
        )
          return;

        if (prompt("للتأكيد، اكتب كلمة 'حذف' في المربع أدناه:") !== "حذف") {
          return alert("تم إلغاء العملية.");
        }

        try {
          const uid = currentUser.uid;
          await deleteDoc(doc(db, "users", uid));
          await deleteUser(currentUser);
          alert("تم حذف الحساب بنجاح. إلى اللقاء.");
          location.reload();
        } catch (error) {
          console.error(error);
          if (error.code === "auth/requires-recent-login") {
            alert(
              "لأمانك، يرجى تسجيل الخروج ثم تسجيل الدخول مرة أخرى لمحاولة حذف الحساب.",
            );
          } else {
            alert("حدث خطأ أثناء الحذف: " + error.message);
          }
        }
      };

      // --- ADMIN & MODERATOR LOGIC ---

      // 1. الدخول للوحة التحكم
      window.attemptAdminLogin = async () => {
        if (!currentUser) return alert("يجب تسجيل الدخول أولاً.");

        const myEmail = currentUser.email.toLowerCase();

        // Check Super Admin
        if (myEmail === ADMIN_EMAIL.toLowerCase()) {
          const code = prompt("🔒 أدخل كود المسؤول (Super Admin):");
          if (code === ADMIN_PASSCODE) {
            isAdmin = true;
            isModerator = true;
            openAdminPanel();
          } else {
            alert("كود خاطئ.");
          }
          return;
        }

        // Check Moderator
        try {
          const modRef = doc(db, "moderators", myEmail);
          const modSnap = await getDoc(modRef);

          if (modSnap.exists()) {
            // For Moderators, use same passcode or a different logic if preferred
            const code = prompt("🛡️ أدخل كود المشرف:");
            if (code === ADMIN_PASSCODE) {
              isAdmin = false;
              isModerator = true;
              openAdminPanel();
            } else {
              alert("كود خاطئ.");
            }
          } else {
            alert("ليس لديك صلاحية الوصول.");
          }
        } catch (e) {
          console.error(e);
          alert("خطأ في التحقق من الصلاحيات.");
        }
      };

      function openAdminPanel() {
        toggleSidePanel(); // إغلاق القائمة الجانبية
        adminModal.style.display = "flex";

        // عناصر التحكم الخاصة بالأدمن فقط
        const modTab = document.getElementById("tab-moderators");
        const modSection = document.getElementById("admin-sec-moderators");

        // إظهار/إخفاء تبويب "المشرفين" (إضافة/حذف مشرفين)
        // المتغير isAdmin تم تحديده عند تسجيل الدخول
        if (isAdmin) {
          if (modTab) modTab.style.display = "block";
        } else {
          if (modTab) modTab.style.display = "none";
          // إذا كان القسم مفتوحاً بالخطأ (أو كان مفتوحاً سابقاً)، نغلقه ونعود للاعبين
          if (modSection && modSection.classList.contains("active")) {
            switchAdminTab("players");
          }
        }

        // فتح تبويب اللاعبين افتراضياً
        switchAdminTab("players");

        // تشغيل نظام مراقبة الأحداث (إذا كان موجوداً)
        if (typeof initEventSystem === "function") {
          initEventSystem();
        }
      }
      window.switchAdminTab = (tabId) => {
        // Deactivate all tabs and sections
        document
          .querySelectorAll(".admin-tab")
          .forEach((t) => t.classList.remove("active"));
        document
          .querySelectorAll(".admin-section")
          .forEach((s) => s.classList.remove("active"));

        // Activate clicked tab (find by text roughly or assume order, here simple logic)
        // Better way: identify by click event, but here we manually handle UI state:
        const tabEl = document.querySelector(`.admin-tab[onclick*='${tabId}']`);
        if (tabEl) tabEl.classList.add("active");

        // Activate Section
        const sec = document.getElementById(`admin-sec-${tabId}`);
        if (sec) sec.classList.add("active");

        // Load Data
        if (tabId === "players") loadAdminPlayers();
        if (tabId === "sanctions") loadSanctionsList();
        if (tabId === "moderators") loadModeratorsList();
      };

      // 2. إدارة المشرفين (Super Admin Only)
      window.addModerator = async () => {
        if (!isAdmin) return alert("صلاحية مرفوضة. للآدمن فقط.");

        const email = document
          .getElementById("new-mod-email")
          .value.trim()
          .toLowerCase();
        if (!email) return alert("أدخل الإيميل.");

        try {
          await setDoc(doc(db, "moderators", email), {
            addedBy: currentUser.email,
            timestamp: Date.now(),
          });
          alert(`تم إضافة المشرف: ${email}`);
          loadModeratorsList();
          document.getElementById("new-mod-email").value = "";
        } catch (e) {
          alert("خطأ: " + e.message);
        }
      };

      window.loadModeratorsList = async () => {
        if (!isAdmin) return;
        const list = document.getElementById("moderators-list");
        list.innerHTML = "جاري التحميل...";

        const q = query(collection(db, "moderators"));
        const snap = await getDocs(q);

        list.innerHTML = "";
        snap.forEach((d) => {
          const li = document.createElement("li");
          li.style.borderBottom = "1px solid #333";
          li.style.padding = "5px";
          li.innerHTML = `${d.id} <button onclick="removeModerator('${d.id}')" style="color:red; background:none; border:none; cursor:pointer; float:left;">[حذف]</button>`;
          list.appendChild(li);
        });
      };

      window.removeModerator = async (email) => {
        if (!isAdmin) return;
        if (confirm(`حذف المشرف ${email}؟`)) {
          await deleteDoc(doc(db, "moderators", email));
          loadModeratorsList();
        }
      };

      // 3. إدارة العقوبات (Sanctions) - Admin & Moderators
      window.loadSanctionsList = async () => {
        const tbody = document.getElementById("admin-sanctions-body");
        tbody.innerHTML = "<tr><td colspan='3'>تحميل...</td></tr>";

        const q = query(
          collection(db, "users"),
          orderBy("username"),
          limit(50),
        );
        const snap = await getDocs(q);

        tbody.innerHTML = "";
        snap.forEach((docSnap) => {
          const data = docSnap.data();
          const uid = docSnap.id;
          const s = data.sanctions || {};

          const hasSanction = s.noMining || s.noRecruit || s.noAttack;
          const statusText = hasSanction
            ? `<span style="color:red">⛔ معاقب</span>`
            : `<span style="color:#2ecc71">سليم</span>`;

          const tr = document.createElement("tr");
          tr.innerHTML = `
              <td>${
                data.username || "بدون اسم"
              } <br><small style="color:#666">${data.email}</small></td>
              <td>${statusText}</td>
              <td>
                  <button class="recruit-btn" style="background:#e67e22; padding:5px 10px;" 
                  onclick="openSanctionModal('${uid}', '${
                    data.username
                  }')">إدارة العقوبات</button>
              </td>
          `;
          tbody.appendChild(tr);
        });
      };

      window.openSanctionModal = async (uid, name) => {
        document.getElementById("sanction-action-modal").style.display = "flex";
        document.getElementById("sanction-target-name").innerText = name;
        document.getElementById("sanction-target-id").value = uid;

        // Load current sanctions
        const snap = await getDoc(doc(db, "users", uid));
        const data = snap.data();
        const s = data.sanctions || {};

        document.getElementById("chk-no-mining").checked = !!s.noMining;
        document.getElementById("chk-no-recruit").checked = !!s.noRecruit;
        document.getElementById("chk-no-attack").checked = !!s.noAttack;

        // Remove Button visible only to Super Admin
        const btnRemove = document.getElementById("btn-remove-sanctions");
        if (isAdmin) {
          btnRemove.style.display = "block";
        } else {
          btnRemove.style.display = "none";
        }
      };

      window.confirmSanctions = async () => {
        const uid = document.getElementById("sanction-target-id").value;
        const sanctions = {
          noMining: document.getElementById("chk-no-mining").checked,
          noRecruit: document.getElementById("chk-no-recruit").checked,
          noAttack: document.getElementById("chk-no-attack").checked,
        };

        try {
          await updateDoc(doc(db, "users", uid), {
            sanctions: sanctions,
          });
          alert("تم تحديث العقوبات بنجاح.");
          document.getElementById("sanction-action-modal").style.display =
            "none";
          loadSanctionsList(); // Refresh list
        } catch (e) {
          alert("خطأ: " + e.message);
        }
      };

      window.removeSanctions = async () => {
        if (!isAdmin)
          return alert("فقط الآدمن الرئيسي يمكنه إزالة العقوبات بالكامل.");

        if (confirm("هل أنت متأكد من مسح جميع العقوبات عن هذا اللاعب؟")) {
          const uid = document.getElementById("sanction-target-id").value;
          try {
            await updateDoc(doc(db, "users", uid), {
              sanctions: {
                noMining: false,
                noRecruit: false,
                noAttack: false,
              },
            });
            alert("تم رفع العقوبات.");
            document.getElementById("sanction-action-modal").style.display =
              "none";
            loadSanctionsList();
          } catch (e) {
            alert("خطأ: " + e.message);
          }
        }
      };

      window.loadAdminPlayers = async () => {
        const tbody = document.getElementById("admin-players-body");
        tbody.innerHTML = "<tr><td colspan='9'>جاري التحميل...</td></tr>";

        try {
          // جلب كل المستخدمين مرتبين بالقوة
          const q = query(collection(db, "users"), orderBy("power", "desc"));
          const snapshot = await getDocs(q);

          tbody.innerHTML = "";
          let idCounter = 1;

          snapshot.forEach((docSnap) => {
            const data = docSnap.data();
            const uid = docSnap.id;

            const row = document.createElement("tr");
            row.innerHTML = `
                  <td>${idCounter++}</td>
                  <td>${data.username || "مجهول"}</td>
                  <td>${data.email || "-"}</td>
                  <td>${data.rank || 1}</td> <!-- Castle Level -->
                  <td style="color:#f1c40f">${(
                    data.gold || 0
                  ).toLocaleString()}</td>
                  <td style="color:#bdc3c7">${(
                    data.silver || 0
                  ).toLocaleString()}</td>
                  <td style="color:#d35400">${(
                    data.wood || 0
                  ).toLocaleString()}</td>
                  <td style="color:#e74c3c">${(
                    data.power || 0
                  ).toLocaleString()}</td>
                  <td>
                      <button class="btn-delete-user" onclick="adminDeleteUser('${uid}', '${
                        data.email
                      }')">حذف</button>
                  </td>
              `;
            tbody.appendChild(row);
          });
        } catch (e) {
          console.error(e);
          tbody.innerHTML =
            "<tr><td colspan='9' style='color:red'>فشل التحميل</td></tr>";
        }
      };

      window.adminDeleteUser = async (uid, email) => {
        if (
          confirm(
            `هل أنت متأكد من حذف حساب اللاعب: ${email}؟\nسيختفي من اللعبة نهائياً.`,
          )
        ) {
          try {
            // الحذف من قاعدة البيانات فقط (Firebase Admin SDK مطلوب لحذف Auth من هنا، لكن حذف الداتا يكفي للعبة)
            await deleteDoc(doc(db, "users", uid));
            alert("تم حذف بيانات اللاعب من اللعبة.");
            loadAdminPlayers(); // Refresh
          } catch (e) {
            alert("خطأ: " + e.message);
          }
        }
      };

      // --- NEW: Code Crafting Logic (Dynamic Inputs) ---
      window.addCodeUnitRow = () => {
        const container = document.getElementById("adm-unit-list-container");
        const div = document.createElement("div");
        div.className = "dynamic-unit-row";
        div.innerHTML = `
          <select class="dynamic-unit-select unit-type">
             <option value="infantry">مشاة</option>
             <option value="archers">رماة</option>
             <option value="cavalry">فرسان</option>
             <option value="siege">مركبات</option>
          </select>
          <input type="number" class="dynamic-unit-input unit-level" placeholder="Level" min="1" value="1" style="width:60px;">
          <input type="number" class="dynamic-unit-input unit-count" placeholder="Count" min="1" value="100" style="width:80px;">
          <button class="recruit-btn" style="background:#c0392b; padding:5px 10px;" onclick="this.parentElement.remove()">X</button>
      `;
        container.appendChild(div);
      };

      window.createGiftCode = async () => {
        const codeText = document.getElementById("adm-code-text").value.trim();
        const duration =
          parseFloat(document.getElementById("adm-code-duration").value) || 24;
        const g = parseInt(document.getElementById("adm-g-reward").value) || 0;
        const s = parseInt(document.getElementById("adm-s-reward").value) || 0;
        const w = parseInt(document.getElementById("adm-w-reward").value) || 0;

        // Units check (New Dynamic System)
        const units = {};
        let hasUnits = false;

        document.querySelectorAll(".dynamic-unit-row").forEach((row) => {
          const type = row.querySelector(".unit-type").value;
          const level = parseInt(row.querySelector(".unit-level").value) || 1;
          const count = parseInt(row.querySelector(".unit-count").value) || 1;

          if (count > 0) {
            const key = `${type}_${level}`;
            if (units[key]) units[key] += count;
            else units[key] = count;
            hasUnits = true;
          }
        });

        if (!codeText) return alert("أدخل رمز الكود");

        const rewards = {
          gold: g,
          silver: s,
          wood: w,
        };
        if (hasUnits) rewards.units = units;

        const expiresAt = Date.now() + duration * 60 * 60 * 1000;

        try {
          await setDoc(doc(db, "gift_codes", codeText), {
            rewards: rewards,
            expiresAt: expiresAt,
            createdBy: currentUser.email,
            createdAt: Date.now(),
          });
          alert("تم إنشاء الكود بنجاح! \nالرمز: " + codeText);
          // Reset inputs
          document.getElementById("adm-code-text").value = "";
          document.getElementById("adm-unit-list-container").innerHTML = ""; // Clear rows
        } catch (e) {
          console.error(e);
          alert("خطأ: " + e.message);
        }
      };

      // --- NEW: The Blood Event Logic ---
      window.startTheBloodEvent = () => {
        // Open rewards modal
        document.getElementById("event-rewards-modal").style.display = "flex";
      };

      window.confirmStartTheBlood = async () => {
        // Gather rewards data
        const rewards = {
          rank1: {
            gold:
              parseInt(document.getElementById("reward-r1-gold").value) || 0,
            silver:
              parseInt(document.getElementById("reward-r1-silver").value) || 0,
            wood:
              parseInt(document.getElementById("reward-r1-wood").value) || 0,
            army: document.getElementById("reward-r1-army").value || "", // format like infantry_5:100
          },
          rank2: {
            gold:
              parseInt(document.getElementById("reward-r2-gold").value) || 0,
            silver:
              parseInt(document.getElementById("reward-r2-silver").value) || 0,
            wood:
              parseInt(document.getElementById("reward-r2-wood").value) || 0,
            army: document.getElementById("reward-r2-army").value || "",
          },
          rank3: {
            gold:
              parseInt(document.getElementById("reward-r3-gold").value) || 0,
            silver:
              parseInt(document.getElementById("reward-r3-silver").value) || 0,
            wood:
              parseInt(document.getElementById("reward-r3-wood").value) || 0,
            army: document.getElementById("reward-r3-army").value || "",
          },
        };

        try {
          // Set active in DB
          await setDoc(doc(db, "events", "the_blood"), {
            active: true,
            startTime: Date.now(),
            rewards: rewards,
          });

          alert("تم بدء الحدث بنجاح!");
          document.getElementById("event-rewards-modal").style.display = "none";
          // Update UI buttons immediately for admin
          document.getElementById("btn-start-event").disabled = true;
          document.getElementById("btn-stop-event").disabled = false;
        } catch (e) {
          alert("خطأ في بدء الحدث: " + e.message);
        }
      };

      window.stopTheBloodEvent = async () => {
        if (!confirm("هل أنت متأكد من إيقاف الحدث؟")) return;
        try {
          await updateDoc(doc(db, "events", "the_blood"), {
            active: false,
            endTime: Date.now(),
          });
          alert("تم إيقاف الحدث.");
          document.getElementById("btn-start-event").disabled = false;
          document.getElementById("btn-stop-event").disabled = true;
        } catch (e) {
          alert("Error: " + e.message);
        }
      };

      // Listen for event status (Admin & Global)
      function initEventSystem() {
        onSnapshot(doc(db, "events", "the_blood"), (docSnap) => {
          const data = docSnap.data();
          const active = data && data.active;
          isBloodEventActive = active;

          // Admin Buttons
          const btnStart = document.getElementById("btn-start-event");
          const btnStop = document.getElementById("btn-stop-event");
          const statusText = document.getElementById("event-status-text");

          if (btnStart && btnStop) {
            if (active) {
              btnStart.disabled = true;
              btnStop.disabled = false;
              statusText.innerText = "الحالة: جاري التشغيل 🟢";
              statusText.style.color = "#2ecc71";
            } else {
              btnStart.disabled = false;
              btnStop.disabled = true;
              statusText.innerText = "الحالة: متوقف 🔴";
              statusText.style.color = "#e74c3c";
            }
          }

          // Navbar Ticker
          if (active) {
            eventTicker.style.display = "block";
          } else {
            eventTicker.style.display = "none";
          }
        });
      }

      // Init event listener on load regardless of admin
      initEventSystem();

      // --- END SIDEBAR & ADMIN LOGIC ---

      window.closeMilitaryModal = () => {
        militaryModal.style.display = "none";
        if (currentUser) mobileControls.style.display = "flex";
      };
      window.closeAttackModal = () => {
        attackModal.style.display = "none";
        targetEnemyId = null;
        if (currentUser) mobileControls.style.display = "flex";
      };
      window.closeUpgradeModal = () => {
        upgradeModal.style.display = "none";
        if (currentUser) mobileControls.style.display = "flex";
      };
      window.closeDonationModal = () => {
        donationModal.style.display = "none";
        targetEnemyId = null;
        if (currentUser) mobileControls.style.display = "flex";
      };

      const UNIT_DATA = {
  infantry: {
    name: "مشاة",
    baseAtk: 5,
    baseDef: 10,
    costGold: 5000,   // كان 100
    costSilver: 3000, // كان 50
  },
  archers: {
    name: "رماة",
    baseAtk: 15,
    baseDef: 5,
    costGold: 8000,   // كان 150
    costSilver: 6000,
  },
  cavalry: {
    name: "فرسان",
    baseAtk: 25,
    baseDef: 15,
    costGold: 15000,  // كان 300
    costSilver: 10000,
  },
  siege: {
    name: "مركبات",
    baseAtk: 50,
    baseDef: 30,
    costGold: 50000,  // كان 1000
    costSilver: 40000,
  },
};

      let currentTab = "infantry";

      // --- 2. دوال المنطق العسكري والتجنيد ---

      window.switchTab = (tabName) => {
        currentTab = tabName;
        document
          .querySelectorAll(".tab-btn")
          .forEach((btn) => btn.classList.remove("active"));
        event.target.classList.add("active");
        renderUnits();
      };

      window.renderUnits = () => {
        const container = document.getElementById("units-list");
        container.innerHTML = "";
        if (!userDocData) return;
        const castleLevel = userDocData.rank || 1;
        const unitTypeData = UNIT_DATA[currentTab];
        const myUnits = userDocData.units || {};

        for (let i = 1; i <= castleLevel; i++) {
          
          // --- التعديل هنا: معادلة خطية (زيادة 20% لكل مستوى) ---
          // هذا يمنع الأسعار من الوصول للملايين في المستويات العليا
          const levelMultiplier = 1 + ((i - 1) * 0.2);

          // حساب القوة والدفاع (يزداد بقوة مع المستوى لجعل الترقية مفيدة)
          const atk = Math.round(unitTypeData.baseAtk * levelMultiplier * i);
          const def = Math.round(unitTypeData.baseDef * levelMultiplier * i);
          
          // حساب التكلفة (تزداد بشكل معقول الآن)
          const costG = Math.round(unitTypeData.costGold * levelMultiplier);
          const costS = Math.round(unitTypeData.costSilver * levelMultiplier);
          const power = atk + def;

          const unitKey = `${currentTab}_${i}`;
          const ownedCount = myUnits[unitKey] || 0;

          const div = document.createElement("div");
          div.className = "unit-card";
          // تم إضافة toLocaleString() لعرض الفواصل في الأرقام (مثلاً 5,000)
          div.innerHTML = `
            <div class="unit-info">
                <h3>${unitTypeData.name} - مستوى ${i} <small style="font-size:12px; color:#aaa;">(تملك: ${ownedCount})</small></h3>
                <div class="unit-stats">
                    <span class="stat-badge" style="color:#e74c3c"> ${atk}</span>
                    <span class="stat-badge" style="color:#3498db"> ${def}</span>
                    <span class="stat-badge" style="color:#f1c40f"> ${power}</span>
                </div>
                <div style="font-size:11px; margin-top:5px; color:#aaa;">
                    تكلفة: ${costG.toLocaleString()} ذهب | ${costS.toLocaleString()} فضة
                </div>
            </div>
            <div class="recruit-actions">
                <input type="number" min="1" value="1" id="qty-${currentTab}-${i}" class="recruit-input">
                <button class="recruit-btn" onclick="recruitUnit('${currentTab}', ${i}, ${costG}, ${costS}, ${power})">تجنيد</button>
            </div>
        `;
          container.appendChild(div);
        }
      };
      // ... (نهاية دوال الدبلوماسية مثل window.declareSiege) ...

      // =========================================================
      //  ضع الدالة هنا 👇👇
      // =========================================================
      async function getActiveSiegePenalty(uid, type) {
        let totalPenalty = 0;
        const q = query(
          collection(db, "active_sieges"),
          where("targetId", "==", uid),
          where("type", "==", type),
        );
        const snap = await getDocs(q);
        snap.forEach((doc) => {
          const d = doc.data();
          if (d.endTime > Date.now()) {
            totalPenalty += d.rate;
          }
        });
        // سقف العقوبة 80% حتى لا تموت اللعبة
        return Math.min(0.8, totalPenalty);
      }
      // =========================================================

      // --- دالة التجنيد (مع نظام الحصار العسكري) ---
      window.recruitUnit = async (type, level, costG, costS, powerPerUnit) => {
        if (!currentUser) return;

        // 1. فحص العقوبات الإدارية (Admin Sanctions)
        if (userDocData.sanctions && userDocData.sanctions.noRecruit) {
          return alert("⛔ تم منعك من التجنيد بقرار إداري!");
        }

        // 2. قراءة الكمية المطلوبة
        const qtyInput = document.getElementById(`qty-${type}-${level}`);
        const qty = parseInt(qtyInput.value);
        if (qty <= 0) return alert("العدد غير صحيح");

        try {
          // 3. [جديد] فحص الحصار العسكري (Diplomacy Siege)
          // نجلب نسبة العقوبة من السيرفر
          const penalty = await getActiveSiegePenalty(
            currentUser.uid,
            "military",
          );

          // حساب مضاعف التكلفة (مثلاً لو العقوبة 0.3 ستصبح التكلفة 1.3 ضعف)
          const costMultiplier = 1 + penalty;

          // 4. حساب التكلفة الإجمالية الجديدة
          const totalGold = Math.floor(costG * qty * costMultiplier);
          const totalSilver = Math.floor(costS * qty * costMultiplier);
          const totalPower = powerPerUnit * qty;

          // 5. التحقق من توفر الموارد
          if (
            userDocData.gold < totalGold ||
            userDocData.silver < totalSilver
          ) {
            return alert(
              `لا يوجد موارد كافية!\nالمطلوب: ${totalGold} ذهب | ${totalSilver} فضة`,
            );
          }

          // 6. رسالة التأكيد (تختلف إذا كان هناك حصار)
          let confirmMessage = `تجنيد ${qty} من ${UNIT_DATA[type].name} مستوى ${level}؟\nالتكلفة النهائية: ${totalGold} ذهب و ${totalSilver} فضة`;

          if (penalty > 0) {
            confirmMessage = `⚠️ تنبيه: مدينتك تحت حصار عسكري!\nتم زيادة تكلفة التجنيد بنسبة ${(
              penalty * 100
            ).toFixed(0)}%.\n\n${confirmMessage}`;
          }

          if (!confirm(confirmMessage)) return;

          // 7. تنفيذ العملية في قاعدة البيانات
          const userRef = doc(db, "users", currentUser.uid);
          const unitKey = `units.${type}_${level}`;

          await updateDoc(userRef, {
            gold: increment(-totalGold),
            silver: increment(-totalSilver),
            power: increment(totalPower),
            [unitKey]: increment(qty),
          });

          alert(`✅ تم تجنيد القوات بنجاح! زادت قوتك بمقدار ${totalPower}`);
        } catch (err) {
          console.error(err);
          alert("حدث خطأ أثناء العملية: " + err.message);
        }
      };
      // --- 3. منطق التفاعل (هجوم / تبرع) ---

      // يفتح نافذة الاختيار
      window.openActionMenu = (enemyId) => {
        targetEnemyId = enemyId;
        actionModal.style.display = "flex";
      };

      window.chooseAttack = () => {
        actionModal.style.display = "none";
        openAttackWindow(targetEnemyId);
      };

      window.chooseDonate = () => {
        actionModal.style.display = "none";
        openDonationWindow(targetEnemyId);
      };

      // --- الهجوم ---
      window.openAttackWindow = (enemyId) => {
        const container = document.getElementById("attack-units-list");
        container.innerHTML = "";

        if (!userDocData.units || Object.keys(userDocData.units).length === 0) {
          container.innerHTML =
            "<p style='text-align:center; color:#e74c3c;'>ليس لديك قوات! اذهب للثكنات وجند جيشاً.</p>";
          attackModal.style.display = "flex";
          return;
        }

        let hasAnyUnit = false;
        for (const [key, count] of Object.entries(userDocData.units)) {
          if (count > 0) {
            hasAnyUnit = true;
            const [type, levelStr] = key.split("_");
            const level = parseInt(levelStr);
            const uData = UNIT_DATA[type];

            const levelMultiplier = Math.pow(1.2, level - 1);
            const atk = Math.round(uData.baseAtk * levelMultiplier * level);
            const def = Math.round(uData.baseDef * levelMultiplier * level);
            const unitPower = atk + def;

            const div = document.createElement("div");
            div.className = "attack-unit-row";
            div.innerHTML = `
                  <div class="attack-unit-info">
                      <div class="attack-unit-name">${uData.name} - LVL ${level}</div>
                      <div class="attack-unit-avail">متاح: ${count} | قوة: ${unitPower}</div>
                  </div>
                  <div style="display:flex; flex-direction: column; align-items:flex-end; gap:5px; min-width: 120px;">
                      <span id="disp-${key}" style="color: #fff; font-weight: bold; font-size: 18px;">0</span>
                      <input type="range" 
                             id="atk-qty-${key}" 
                             min="0" max="${count}" value="0"
                             style="width: 100%; accent-color: #c0392b; cursor: pointer;"
                             data-power="${unitPower}"
                             data-unitkey="${key}"
                             oninput="document.getElementById('disp-${key}').innerText = this.value; calculateTotalAttackPower()">
                  </div>
              `;
            container.appendChild(div);
          }
        }

        if (!hasAnyUnit)
          container.innerHTML =
            "<p style='text-align:center; color:#e74c3c;'>كل قواتك في مهام أخرى أو عددها صفر.</p>";

        document.getElementById("attack-total-power").innerText = "0";
        attackModal.style.display = "flex";
      };

      window.calculateTotalAttackPower = () => {
        let total = 0;
        const inputs = document.querySelectorAll('[id^="atk-qty-"]');
        inputs.forEach((inp) => {
          const val = parseInt(inp.value) || 0;
          const pow = parseInt(inp.getAttribute("data-power")) || 0;
          total += val * pow;
        });
        document.getElementById("attack-total-power").innerText = total;
      };

      // --- دالة الهجوم (نسخة بدون سيرفر) ---
      // --- دالة الهجوم (معدلة لتعمل أوفلاين) ---
      window.launchAttack = async () => {
        if (!targetEnemyId) return;
        // داخل launchAttack في البداية:
        // (يفضل أن يكون لديك مصفوفة محلية للاتفاقيات، لكن هنا سنفحص السيرفر للسرعة)

        // ... (بعد التحقق من targetEnemyId)

        // فحص السلام
        const peaceQuery = query(
          collection(db, "peace_treaties"),
          where("parties", "array-contains", currentUser.uid),
        );
        const peaceSnap = await getDocs(peaceQuery);
        let isPeace = false;
        peaceSnap.forEach((doc) => {
          const d = doc.data();
          // إذا كان الطرف الآخر هو الهدف، والوقت لم ينته
          if (d.parties.includes(targetEnemyId) && d.endTime > Date.now()) {
            isPeace = true;
          }
        });

        if (isPeace) {
          return alert("🏳️ لا يمكنك الهجوم! توجد اتفاقية سلام سارية بينكما.");
        }

        // ... (تكملة كود الهجوم)
        // فحص العقوبات
        if (userDocData.sanctions && userDocData.sanctions.noAttack) {
          return alert("⛔ تم منعك من الهجوم بقرار إداري!");
        }

        // تجميع الجيش
        const inputs = document.querySelectorAll('[id^="atk-qty-"]');
        let totalPower = 0;
        let totalSoldiers = 0;
        const unitsPayload = {};

        inputs.forEach((inp) => {
          const val = parseInt(inp.value) || 0;
          if (val > 0) {
            const pow = parseInt(inp.getAttribute("data-power")) || 0;
            const uKey = inp.getAttribute("data-unitkey");
            totalPower += val * pow;
            totalSoldiers += val;
            unitsPayload[uKey] = val;
          }
        });

        if (totalSoldiers === 0)
          return alert("يجب اختيار جندي واحد على الأقل!");

        if (
          confirm(
            `هل أنت متأكد من شن الحرب؟\nعدد الجنود: ${totalSoldiers}\nالقوة: ${totalPower}`,
          )
        ) {
          const enemyIdToAttack = targetEnemyId;
          closeAttackModal();

          const enemyCastle = otherCastles[enemyIdToAttack];

          // 1. حساب وقت الوصول بناءً على المسافة (نفس سرعة الأنيميشن)
          // المسافة / السرعة (60 وحدة) / 60 إطار في الثانية * 1000 ميلي ثانية
          const dist = myCastleMesh.position.distanceTo(enemyCastle.position);
          const durationMs = (dist / 60 / 60) * 1000;
          const endTime = Date.now() + durationMs;

          // 2. خصم الجنود
          const myRef = doc(db, "users", currentUser.uid);
          const updates = {};
          for (let key in unitsPayload) {
            updates[`units.${key}`] = increment(-unitsPayload[key]);
          }
          updateDoc(myRef, updates);

          // 3. تسجيل الهجوم في قاعدة البيانات مع وقت الانتهاء وتفاصيل الجيش
          let attackDocId = null;
          try {
            const docRef = await addDoc(collection(db, "attacks"), {
              attackerId: currentUser.uid,
              targetId: enemyIdToAttack,
              startTime: Date.now(),
              endTime: endTime, // <-- مهم جداً
              unitsPayload: unitsPayload, // <-- مهم جداً لحساب المعركة لاحقاً
              status: "active",
            });
            attackDocId = docRef.id;
          } catch (e) {
            console.error(e);
          }

          // 4. إطلاق الأنيميشن للمشاهدة
          if (myCastleMesh && enemyCastle) {
            spawnWarArmy(
              myCastleMesh.position,
              enemyCastle.position,
              totalPower,
              enemyIdToAttack,
              0xff0000,
              "ATTACK",
              unitsPayload,
              attackDocId,
            );
          } else {
            alert(
              `جاري الهجوم! ستصل القوات خلال ${(durationMs / 1000 / 60).toFixed(
                1,
              )} دقيقة.`,
            );
          }
        }
      };
      // --- التبرع ---
      window.openDonationWindow = (friendId) => {
        if (!userDocData) return;

        // إعداد موارد (تصفير القيم والحد الأقصى)
        const gInput = document.getElementById("donate-gold");
        const sInput = document.getElementById("donate-silver");
        const wInput = document.getElementById("donate-wood");

        gInput.max = userDocData.gold || 0;
        gInput.value = 0;
        document.getElementById("disp-donate-gold").innerText = "0";

        sInput.max = userDocData.silver || 0;
        sInput.value = 0;
        document.getElementById("disp-donate-silver").innerText = "0";

        wInput.max = userDocData.wood || 0;
        wInput.value = 0;
        document.getElementById("disp-donate-wood").innerText = "0";

        // --- إعداد الوحدات (الجيش) ---
        const container = document.getElementById("donation-units-list");
        container.innerHTML = ""; // مسح القائمة القديمة

        let hasUnits = false;

        // التحقق مما إذا كان اللاعب يملك جيشاً
        if (userDocData.units && Object.keys(userDocData.units).length > 0) {
          for (const [key, count] of Object.entries(userDocData.units)) {
            if (count > 0) {
              hasUnits = true;
              const [type, levelStr] = key.split("_");
              const unitName = UNIT_DATA[type] ? UNIT_DATA[type].name : type;

              // إنشاء عنصر الواجهة بنفس تصميم الموارد (.donation-section)
              const div = document.createElement("div");
              div.className = "donation-section"; // استخدام نفس الكلاس للتصميم
              div.innerHTML = `
                <span class="donation-label">${unitName} (مستوى ${levelStr})</span>
                <div class="donation-row">
                    <span id="disp-don-unit-${key}" style="min-width: 40px; text-align: center;">0</span>
                    <input type="range" 
                           class="donate-unit-input" 
                           id="don-unit-${key}" 
                           data-key="${key}" 
                           min="0" 
                           max="${count}" 
                           value="0" 
                           style="width: 100%; accent-color: #27ae60;" 
                           oninput="document.getElementById('disp-don-unit-${key}').innerText = parseInt(this.value).toLocaleString()">
                    <span style="font-size:10px; color:#aaa;">/${count}</span>
                </div>
            `;
              container.appendChild(div);
            }
          }
        }

        // إذا لم يكن لديه جيش، اعرض رسالة
        if (!hasUnits) {
          container.innerHTML =
            "<p style='text-align:center; color:#555; font-size:12px;'>لا توجد قوات متاحة في الثكنة للإرسال.</p>";
        }

        donationModal.style.display = "flex";
      };

      window.sendDonation = () => {
        if (!targetEnemyId) return;

        // قراءة قيم الموارد
        const goldAmt =
          parseInt(document.getElementById("donate-gold").value) || 0;
        const silverAmt =
          parseInt(document.getElementById("donate-silver").value) || 0;
        const woodAmt =
          parseInt(document.getElementById("donate-wood").value) || 0;

        // قراءة قيم الجيش
        const unitInputs = document.querySelectorAll(".donate-unit-input");
        const unitsToSend = {};
        let totalUnits = 0;

        unitInputs.forEach((inp) => {
          const val = parseInt(inp.value) || 0;
          if (val > 0) {
            unitsToSend[inp.dataset.key] = val;
            totalUnits += val;
          }
        });

        // التحقق من أن اللاعب اختار شيئاً ليرسله
        if (
          goldAmt === 0 &&
          silverAmt === 0 &&
          woodAmt === 0 &&
          totalUnits === 0
        ) {
          alert("يجب اختيار موارد أو جنود لإرسالها!");
          return;
        }

        if (
          confirm(
            `هل أنت متأكد من إرسال الدعم؟\n(الموارد: ${
              goldAmt + silverAmt + woodAmt
            } | الجنود: ${totalUnits})`,
          )
        ) {
          const friendId = targetEnemyId;
          closeDonationModal(); // إغلاق النافذة

          // 1. خصم الموارد والجيش من المرسل (أنت)
          const myUpdate = {
            gold: increment(-goldAmt),
            silver: increment(-silverAmt),
            wood: increment(-woodAmt),
          };

          // خصم الجنود
          for (const k in unitsToSend) {
            myUpdate[`units.${k}`] = increment(-unitsToSend[k]);

            // حساب القوة المخصومة (تقريبي) لتحديث القوة الكلية
            const [type, lvlStr] = k.split("_");
            const lvl = parseInt(lvlStr) || 1;
            const stats = UNIT_DATA[type];
            if (stats) {
              // معادلة القوة: (هجوم + دفاع) * العدد
              const powerPerUnit =
                (stats.baseAtk + stats.baseDef) * Math.pow(1.2, lvl - 1) * lvl;
              myUpdate.power = increment(
                -Math.floor(powerPerUnit * unitsToSend[k]),
              );
            }
          }

          updateDoc(doc(db, "users", currentUser.uid), myUpdate);

          // 2. إضافة الموارد والجيش للمستقبل (الصديق)
          const friendUpdate = {
            gold: increment(goldAmt),
            silver: increment(silverAmt),
            wood: increment(woodAmt),
          };

          // إضافة الجنود
          for (const k in unitsToSend) {
            friendUpdate[`units.${k}`] = increment(unitsToSend[k]);

            // إضافة القوة للصديق
            const [type, lvlStr] = k.split("_");
            const lvl = parseInt(lvlStr) || 1;
            const stats = UNIT_DATA[type];
            if (stats) {
              const powerPerUnit =
                (stats.baseAtk + stats.baseDef) * Math.pow(1.2, lvl - 1) * lvl;
              friendUpdate.power = increment(
                Math.floor(powerPerUnit * unitsToSend[k]),
              );
            }
          }

          updateDoc(doc(db, "users", friendId), friendUpdate);

          // 3. تشغيل أنيميشن القافلة (باللون الأخضر)
          const enemyCastle = otherCastles[friendId];
          if (myCastleMesh && enemyCastle) {
            spawnWarArmy(
              myCastleMesh.position,
              enemyCastle.position,
              0, // القوة هنا لا تهم لأنها تبرع
              friendId,
              0x2ecc71, // لون أخضر للدعم
              "DONATE",
            );
          }

          alert("تم إرسال القافلة والدعم بنجاح! 🚚");
        }
      };
      // --- 4. أنيميشن الحرب والجيش ---
      const activeArmies = [];

      function createSoldierModel(colorHex) {
        const soldier = new THREE.Group();
        const metalMat = new THREE.MeshStandardMaterial({
          color: 0x7f8c8d,
          roughness: 0.5,
        });
        const skinMat = new THREE.MeshStandardMaterial({ color: 0xffcd94 });
        const armorMat = new THREE.MeshStandardMaterial({ color: colorHex });

        const legGeo = new THREE.BoxGeometry(3, 10, 3);
        const lLeg = new THREE.Mesh(legGeo, metalMat);
        lLeg.position.set(-2, 5, 0);
        const rLeg = new THREE.Mesh(legGeo, metalMat);
        rLeg.position.set(2, 5, 0);
        const body = new THREE.Mesh(new THREE.BoxGeometry(10, 10, 5), armorMat);
        body.position.y = 15;
        const head = new THREE.Mesh(new THREE.BoxGeometry(6, 6, 6), skinMat);
        head.position.y = 23;
        const helmet = new THREE.Mesh(new THREE.BoxGeometry(7, 3, 7), metalMat);
        helmet.position.y = 26;
        const armGeo = new THREE.BoxGeometry(3, 9, 3);
        const rArm = new THREE.Mesh(armGeo, armorMat);
        rArm.position.set(6.5, 15, 0);
        const lArm = new THREE.Mesh(armGeo, armorMat);
        lArm.position.set(-6.5, 15, 0);
        const spear = new THREE.Mesh(
          new THREE.CylinderGeometry(0.5, 0.5, 30),
          new THREE.MeshStandardMaterial({ color: 0x5c4033 }),
        );
        spear.rotation.x = Math.PI / 2;
        spear.position.set(6.5, 15, 10);

        soldier.add(lLeg, rLeg, body, head, helmet, rArm, lArm, spear);
        soldier.scale.set(5, 5, 5);
        return soldier;
      }

      function spawnWarArmy(
        startPos,
        endPos,
        attackPower,
        targetId,
        colorHex,
        type,
        unitsPayload = null,
        attackDocId = null,
      ) {
        const points = [];
        const height = 100;
        points.push(new THREE.Vector3(startPos.x, height, startPos.z));
        points.push(new THREE.Vector3(endPos.x, height, endPos.z));

        const lineGeo = new THREE.BufferGeometry().setFromPoints(points);
        const lineMat = new THREE.LineBasicMaterial({
          color: colorHex,
          linewidth: 3,
        });
        const visualLine = new THREE.Line(lineGeo, lineMat);
        scene.add(visualLine);

        const armyGroup = new THREE.Group();
        const offsets = [
          { x: 0, z: 0 },
          { x: -60, z: 60 },
          { x: 60, z: 60 },
          { x: -120, z: 120 },
          { x: 120, z: 120 },
        ];

        offsets.forEach((offset) => {
          const soldier = createSoldierModel(colorHex);
          soldier.position.set(offset.x, 0, offset.z);
          armyGroup.add(soldier);
        });

        // العلم
        const pole = new THREE.Mesh(
          new THREE.CylinderGeometry(3, 3, 150),
          new THREE.MeshBasicMaterial({ color: 0xffffff }),
        );
        pole.position.set(0, 75, -20);
        const flag = new THREE.Mesh(
          new THREE.PlaneGeometry(80, 60),
          new THREE.MeshBasicMaterial({
            color: colorHex,
            side: THREE.DoubleSide,
          }),
        );
        flag.position.set(40, 130, -20);
        armyGroup.add(pole);
        armyGroup.add(flag);

        armyGroup.position.copy(startPos);
        armyGroup.position.y += 10;
        armyGroup.lookAt(endPos.x, armyGroup.position.y, endPos.z);
        scene.add(armyGroup);

        const dist = startPos.distanceTo(endPos);
        const minSeconds = 15;
        const fps = 60;
        const minFrames = minSeconds * fps;
        const unitsPerFrame = 60;
        let totalFrames = dist / unitsPerFrame;
        if (totalFrames < minFrames) totalFrames = minFrames;
        const finalSpeed = 1 / totalFrames;

        activeArmies.push({
          mesh: armyGroup,
          line: visualLine,
          start: startPos.clone(),
          end: endPos.clone(),
          progress: 0,
          speed: finalSpeed,
          power: attackPower,
          targetId: targetId,
          type: type, // 'ATTACK' or 'DONATE'
          unitsPayload: unitsPayload,
          attackDocId: attackDocId,
        });
      }

      // --- NEW: War Logic & Report Saving ---
      // --- دالة مساعدة لحساب خصائص الوحدة بناءً على مستواها ---
      function getUnitStats(type, level) {
        const uData = UNIT_DATA[type];
        const levelMultiplier = Math.pow(1.2, level - 1);

        return {
          atk: Math.round(uData.baseAtk * levelMultiplier * level),
          def: Math.round(uData.baseDef * levelMultiplier * level),
        };
      }

      // --- منطق المعركة المطور (الخوارزمية الواقعية) ---

      // --- عرض التقارير (محدث لدعم الدبلوماسية والحصار) ---
      window.openReportsModal = async () => {
        if (!currentUser) return;
        mailBadge.style.display = "none";
        document.getElementById("reports-modal").style.display = "flex";
        const container = document.getElementById("reports-list");
        container.innerHTML =
          "<p style='text-align:center;'>جاري التحميل...</p>";

        try {
          const reportsRef = collection(
            db,
            "users",
            currentUser.uid,
            "reports",
          );
          // نجلب آخر 30 رسالة
          const q = query(reportsRef, orderBy("timestamp", "desc"), limit(30));
          const querySnapshot = await getDocs(q);

          container.innerHTML = "";

          if (querySnapshot.empty) {
            container.innerHTML =
              "<p style='text-align:center; color:#888;'>لا توجد رسائل.</p>";
            return;
          }

          querySnapshot.forEach((docSnap) => {
            const data = docSnap.data();
            const date = new Date(data.timestamp).toLocaleString("ar-EG");
            let htmlContent = "";

            // --- الحالة 1: عرض سلام 🕊️ ---
            if (data.type === "peace_offer") {
              const durationHours = (data.duration / (1000 * 60 * 60)).toFixed(
                1,
              );
              const isPending = data.status === "pending";

              htmlContent = `
                <div class="report-item" style="border-right: 5px solid #3498db; background: rgba(52, 152, 219, 0.1);">
                    <div class="report-header">
                        <span style="color:#3498db">🕊️ عرض معاهدة سلام</span>
                        <span>من: ${data.senderName}</span>
                    </div>
                    <div style="font-size:13px; color:#ddd; margin: 5px 0;">
                        يرغب في هدنة لمدة: <b style="color:#fff">${durationHours} ساعة</b>
                    </div>
                    ${
                      isPending
                        ? `
                    <div style="display:flex; gap:10px; margin-top:5px;">
                        <button onclick="respondToPeace('${docSnap.id}', '${data.senderId}', ${data.duration}, true)" 
                                class="recruit-btn" style="padding:5px 10px; font-size:12px; background:#2ecc71;">قبول ✅</button>
                        <button onclick="respondToPeace('${docSnap.id}', '${data.senderId}', 0, false)" 
                                class="recruit-btn" style="padding:5px 10px; font-size:12px; background:#e74c3c;">رفض ❌</button>
                    </div>`
                        : `<div style="font-size:12px; color:${
                            data.status === "accepted" ? "#2ecc71" : "#e74c3c"
                          }">الحالة: ${
                            data.status === "accepted"
                              ? "تم القبول"
                              : "تم الرفض"
                          }</div>`
                    }
                    <div class="report-time">${date}</div>
                </div>`;
            }

            // --- الحالة 2: إنذار حصار ⚔️ ---
            else if (data.type === "siege_alert") {
              htmlContent = `
                <div class="report-item" style="border-right: 5px solid #e74c3c; background: rgba(231, 76, 60, 0.1);">
                    <div class="report-header">
                        <span style="color:#e74c3c">⚠️ إنذار بالحصار</span>
                        <span>بواسطة: ${data.senderName}</span>
                    </div>
                    <div style="font-size:13px; color:#ddd; margin: 5px 0;">
                        نوع العقوبة: <b>${data.siegeType}</b><br>
                        نسبة الضرر: <b style="color:#e74c3c">${data.penaltyRate}%</b>
                    </div>
                    <div style="font-size:11px; color:#aaa;">الخضوع أو الحرب هو خيارك الوحيد.</div>
                    <div class="report-time">${date}</div>
                </div>`;
            }

            // --- الحالة 3: تقرير معركة عادي (القديم) ⚔️ ---
            else {
              const isWin = data.outcome === "win";
              htmlContent = `
                <div class="report-item ${isWin ? "win" : "loss"}">
                    <div class="report-header">
                        <span style="color: ${isWin ? "#2ecc71" : "#e74c3c"}">${
                          isWin ? "انتصار 🏆" : "هزيمة ☠️"
                        }</span>
                        <span>ضد: ${data.enemyName}</span>
                    </div>
                    <div style="font-size:12px; color:#ccc;">
                        قوتك: ${(
                          data.myPower || 0
                        ).toLocaleString()} | العدو: ${(
                          data.enemyPower || 0
                        ).toLocaleString()}
                    </div>
                    ${
                      isWin
                        ? `
                    <div class="report-loot">
                        <span>+${data.lootGold} 🟡</span>
                        <span>+${data.lootSilver} ⚪</span>
                    </div>`
                        : ""
                    }
                    ${
                      !isWin && data.powerLost
                        ? `
                    <div class="report-loot" style="color: #e74c3c;">
                       <span>خسائر: -${data.powerLost} قوة</span>
                    </div>`
                        : ""
                    }
                    <div class="report-time">${date}</div>
                </div>`;
            }

            // إضافة العنصر للقائمة
            const wrapper = document.createElement("div");
            wrapper.innerHTML = htmlContent;
            container.appendChild(wrapper.firstElementChild);
          });
        } catch (e) {
          console.error("Error fetching reports:", e);
          container.innerHTML =
            "<p style='text-align:center; color:#e74c3c;'>خطأ في تحميل البريد.</p>";
        }
      };
      // 👇👇👇 ضع الكود هنا (في هذه المساحة) 👇👇👇

      // --- الرد على معاهدة السلام ---
      window.respondToPeace = async (
        reportId,
        senderId,
        duration,
        isAccepted,
      ) => {
        if (!currentUser) return;

        const newStatus = isAccepted ? "accepted" : "rejected";

        try {
          // 1. تحديث حالة الرسالة في بريدك كي لا تضغط الزر مرتين
          await updateDoc(
            doc(db, "users", currentUser.uid, "reports", reportId),
            {
              status: newStatus,
            },
          );

          if (isAccepted) {
            // 2. تفعيل المعاهدة في قاعدة البيانات
            await addDoc(collection(db, "peace_treaties"), {
              parties: [currentUser.uid, senderId], // الطرفين
              startTime: Date.now(),
              endTime: Date.now() + duration,
              active: true,
            });

            alert("🕊️ تم توقيع معاهدة السلام بنجاح!");
          } else {
            alert("تم رفض المعاهدة.");
          }

          // تحديث النافذة لإخفاء الأزرار
          openReportsModal();
        } catch (e) {
          console.error(e);
          alert("حدث خطأ أثناء الرد.");
        }
      };

     // --- 5. المصادقة والتحكم ---
      if (loginBtn) {
        loginBtn.addEventListener("click", () => {
          // تم حذف toggleFullScreen() من هنا لأنها تسبب تعارضاً مع نافذة جوجل
          const provider = new GoogleAuthProvider();
          signInWithPopup(auth, provider)
            .then(() => {
              // Play Music on login (user interaction)
              if (bgMusic) {
                bgMusic.volume = 0.4;
                bgMusic
                  .play()
                  .catch((e) =>
                    console.log(
                      "Audio autoplay blocked, user must interact first",
                    ),
                  );
              }
            })
            .catch((error) => alert("خطأ في تسجيل الدخول: " + error.message));
        });
      }

      // --- 6. إعداد المشهد (Three.js) ---
      const scene = new THREE.Scene();
      scene.background = new THREE.Color(0x87ceeb);
      scene.fog = new THREE.Fog(0x87ceeb, 20000, 300000);

      const camera = new THREE.PerspectiveCamera(
        60,
        window.innerWidth / window.innerHeight,
        10,
        500000,
      );
      camera.position.set(0, 10000, 0);
      camera.lookAt(0, 0, 0);

      const renderer = new THREE.WebGLRenderer({
        antialias: true,
        powerPreference: "high-performance",
      });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.setPixelRatio(Math.min(window.devicePixelRatio, 1.5));
      renderer.shadowMap.enabled = true;
      renderer.shadowMap.type = THREE.PCFSoftShadowMap;
      document.body.appendChild(renderer.domElement);

      const controls = new OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.dampingFactor = 0.05;
      controls.enableZoom = true;
      controls.enablePan = false; // --- FIX: Disable Panning to prevent camera drift
      controls.enableRotate = true;
      controls.maxPolarAngle = Math.PI / 2;
      controls.minDistance = 200;
      controls.maxDistance = 200000;

      scene.add(new THREE.AmbientLight(0xffffff, 0.7));
      const sun = new THREE.DirectionalLight(0xfff5e6, 1.5);
      sun.position.set(20000, 40000, 20000);
      sun.castShadow = true;
      sun.shadow.mapSize.width = 4096;
      sun.shadow.mapSize.height = 4096;
      sun.shadow.camera.left = -50000;
      sun.shadow.camera.right = 50000;
      sun.shadow.camera.top = 50000;
      sun.shadow.camera.bottom = -50000;
      sun.shadow.bias = -0.0005;
      scene.add(sun);

      // --- 7. البيئة (Terrain) ---
      const mapSize = 400000;
      const terrainGeo = new THREE.PlaneGeometry(mapSize, mapSize, 250, 250);
      terrainGeo.rotateX(-Math.PI / 2);
      const pos = terrainGeo.attributes.position;
      const colors = [];
      const cGrass = new THREE.Color(0x3d5a2d);

      for (let i = 0; i < pos.count; i++) {
        let h = 0;
        pos.setY(i, h);
        let finalCol = cGrass.clone();
        finalCol.offsetHSL(0, 0, (Math.random() - 0.5) * 0.05);
        colors.push(finalCol.r, finalCol.g, finalCol.b);
      }
      terrainGeo.setAttribute(
        "color",
        new THREE.Float32BufferAttribute(colors, 3),
      );
      terrainGeo.computeVertexNormals();
      const terrain = new THREE.Mesh(
        terrainGeo,
        new THREE.MeshStandardMaterial({ vertexColors: true, roughness: 0.9 }),
      );
      terrain.receiveShadow = true;
      scene.add(terrain);
      // مراقب للأخطاء - إذا حاول الهاكر التعديل وفشل بسبب القواعد
      window.addEventListener("unhandledrejection", async function (event) {
        // إذا كان الخطأ بسبب صلاحيات (Permission Denied)
        if (event.reason && event.reason.code === "permission-denied") {
          console.warn("تم كشف محاولة تلاعب!");

          // محاولة تسجيل الغشاش في قائمة سوداء
          // (قد تنجح إذا كانت القواعد تسمح بالكتابة في هذه القائمة)
          try {
            if (currentUser) {
              await addDoc(collection(db, "cheaters_log"), {
                userId: currentUser.uid,
                email: currentUser.email,
                timestamp: Date.now(),
                note: "حاول تعديل البيانات بطريقة غير شرعية (تجاوز الحد)",
              });
            }
          } catch (e) {
            // غالباً سيفشل هذا أيضاً إذا كان الهاكر ذكياً، لكنها محاولة جيدة
          }
        }
      });
      // --- تعريف المواد ---
      const mineWoodMat = new THREE.MeshStandardMaterial({ color: 0x5c4033 });
      const sandStoneMat = new THREE.MeshStandardMaterial({
        color: 0xe5d3b3,
        roughness: 0.9,
      });
      const darkStoneMat = new THREE.MeshStandardMaterial({
        color: 0x8b7e66,
        roughness: 1.0,
      });
      const roofMat = new THREE.MeshStandardMaterial({
        color: 0xc2a67e,
        roughness: 0.8,
      });
      const woodMat = new THREE.MeshStandardMaterial({
        color: 0xdeb887,
        roughness: 1.0,
      });

      // --- 8. الغابات (Forests) ---

      const forests = [];

      function createForests() {
        // إعدادات الأعداد
        const numberOfClusters = 150; // عدد الغابات
        const treesPerCluster = 15; // كثافة الأشجار
        const totalTrees = numberOfClusters * treesPerCluster;

        // 1. تجهيز الأشكال والخامات مرة واحدة فقط
        const trunkGeo = new THREE.CylinderGeometry(10, 15, 60, 5); // تقليل الأضلاع لزيادة الأداء
        const trunkMat = new THREE.MeshStandardMaterial({ color: 0x5c4033 });

        // أوراق الصنوبر (مخروط)
        const pineGeo = new THREE.ConeGeometry(40, 100, 5);
        const pineMat = new THREE.MeshStandardMaterial({
          color: 0x2d4c1e,
          flatShading: true,
        });

        // أوراق البلوط (آيكوساهيدرون - خفيف جداً)
        const oakGeo = new THREE.IcosahedronGeometry(50, 0);
        const oakMat = new THREE.MeshStandardMaterial({
          color: 0x4ca64c,
          flatShading: true,
        });

        // 2. إنشاء الـ InstancedMeshes (الحاوية الكبرى لكل الأشجار)
        const iTrunks = new THREE.InstancedMesh(trunkGeo, trunkMat, totalTrees);
        const iPines = new THREE.InstancedMesh(pineGeo, pineMat, totalTrees);
        const iOaks = new THREE.InstancedMesh(oakGeo, oakMat, totalTrees);

        // تفعيل الظلال
        iTrunks.castShadow = true;
        iTrunks.receiveShadow = true;
        iPines.castShadow = true;
        iPines.receiveShadow = true;
        iOaks.castShadow = true;
        iOaks.receiveShadow = true;

        scene.add(iTrunks);
        scene.add(iPines);
        scene.add(iOaks);

        // متغير وهمي للمساعدة في الحسابات
        const dummy = new THREE.Object3D();
        let treeIndex = 0;
        const mapRange = 350000;

        // 3. حلقة إنشاء الغابات
        for (let i = 0; i < numberOfClusters; i++) {
          // إنشاء "مجموعة منطقية" فقط (للتفاعل واللمس) وليس للرسم
          const forestGroup = new THREE.Group();

          const angle = Math.random() * Math.PI * 2;
          const distance = 8000 + Math.random() * (mapRange / 2);
          const cx = Math.cos(angle) * distance;
          const cz = Math.sin(angle) * distance;

          forestGroup.position.set(cx, 0, cz);

          // بيانات التفاعل (للنقر)
          forestGroup.userData = {
            type: "wood",
            isForest: true,
            id: `forest_${i}`,
          };

          // إضافة صندوق تصادم وهمي (غير مرئي) ليتمكن اللاعب من النقر عليه
          const hitBox = new THREE.Mesh(
            new THREE.CylinderGeometry(200, 200, 300, 8),
            new THREE.MeshBasicMaterial({ visible: false }), // غير مرئي
          );
          hitBox.position.y = 150;
          forestGroup.add(hitBox);

          // إضافة الأيقونات (كما في الكود السابق)
          addForestLabelAndIcons(forestGroup); // (دالة مساعدة بالأسفل)

          scene.add(forestGroup);
          forests.push(forestGroup);

          // 4. توزيع الأشجار داخل الـ InstancedMesh
          const isPineForest = Math.random() > 0.5;

          for (let j = 0; j < treesPerCluster; j++) {
            // موقع الشجرة النسبي
            const r = Math.random() * 700;
            const theta = Math.random() * Math.PI * 2;
            const tx = cx + Math.cos(theta) * r;
            const tz = cz + Math.sin(theta) * r;
            const scale = 2 + Math.random() * 1.5;

            // ضبط الجذع
            dummy.position.set(tx, 30, tz);
            dummy.rotation.set(0, Math.random() * Math.PI, 0);
            dummy.scale.set(scale, scale, scale);
            dummy.updateMatrix();
            iTrunks.setMatrixAt(treeIndex, dummy.matrix);

            // ضبط الأوراق
            if (isPineForest) {
              dummy.position.set(tx, 90, tz); // رفع الأوراق للأعلى
              dummy.updateMatrix();
              iPines.setMatrixAt(treeIndex, dummy.matrix);
              // إخفاء البلوط لهذه الشجرة (تصغيره للصفر)
              dummy.scale.set(0, 0, 0);
              dummy.updateMatrix();
              iOaks.setMatrixAt(treeIndex, dummy.matrix);
            } else {
              dummy.position.set(tx, 100, tz);
              dummy.updateMatrix();
              iOaks.setMatrixAt(treeIndex, dummy.matrix);
              // إخفاء الصنوبر
              dummy.scale.set(0, 0, 0);
              dummy.updateMatrix();
              iPines.setMatrixAt(treeIndex, dummy.matrix);
            }

            treeIndex++;
          }
        }

        // تحديث المصفوفات لتظهر في المشهد
        iTrunks.instanceMatrix.needsUpdate = true;
        iPines.instanceMatrix.needsUpdate = true;
        iOaks.instanceMatrix.needsUpdate = true;
      }

      // دالة مساعدة لإضافة الأيقونات (فصلناها للترتيب)
      function addForestLabelAndIcons(group) {
        // النص (غابة)
        const txtC = document.createElement("canvas");
        txtC.width = 256;
        txtC.height = 64;
        const tCtx = txtC.getContext("2d");
        tCtx.font = "bold 40px 'Cairo'";
        tCtx.fillStyle = "#4CAF50";
        tCtx.textAlign = "center";
        tCtx.fillText("غابة", 128, 45);
        const lbl = new THREE.Sprite(
          new THREE.SpriteMaterial({
            map: new THREE.CanvasTexture(txtC),
            transparent: true,
          }),
        );
        lbl.position.set(0, 500, 0);
        lbl.scale.set(900, 600, 1);
        group.add(lbl);

        // أيقونة الفأس
        const iconC = document.createElement("canvas");
        iconC.width = 128;
        iconC.height = 128;
        const iCtx = iconC.getContext("2d");
        iCtx.shadowColor = "rgba(0,0,0,0.5)";
        iCtx.shadowBlur = 10;
        const grad = iCtx.createLinearGradient(0, 0, 0, 128);
        grad.addColorStop(0, "#4CAF50");
        grad.addColorStop(1, "#1B5E20");
        iCtx.beginPath();
        iCtx.arc(64, 64, 55, 0, Math.PI * 2);
        iCtx.fillStyle = grad;
        iCtx.fill();
        iCtx.lineWidth = 4;
        iCtx.strokeStyle = "#FFD700";
        iCtx.stroke();
        iCtx.fillStyle = "#fff";
        iCtx.font = '60px "Material Icons"';
        iCtx.textAlign = "center";
        iCtx.textBaseline = "middle";
        iCtx.fillText("\uea42", 64, 64);

        const icon = new THREE.Sprite(
          new THREE.SpriteMaterial({
            map: new THREE.CanvasTexture(iconC),
            transparent: true,
            depthTest: false,
          }),
        );
        icon.position.set(0, 700, 0);
        icon.scale.set(1000, 1000, 1);
        icon.visible = false;
        icon.userData = {
          isIcon: true,
          parentTarget: group,
          baseY: 350,
          animOffset: Math.random() * 100,
        };
        group.add(icon);
        group.icon = icon;

        // أيقونة الإشغال
        const occC = document.createElement("canvas");
        occC.width = 64;
        occC.height = 64;
        const oCtx = occC.getContext("2d");
        oCtx.fillStyle = "red";
        oCtx.font = '50px "Material Icons"';
        oCtx.textAlign = "center";
        oCtx.textBaseline = "middle";
        oCtx.fillText("\ue332", 32, 32);
        const occIcon = new THREE.Sprite(
          new THREE.SpriteMaterial({
            map: new THREE.CanvasTexture(occC),
            transparent: true,
            depthTest: false,
          }),
        );
        occIcon.position.set(0, 700, 0);
        occIcon.scale.set(1000, 1000, 1);
        occIcon.visible = false;
        group.add(occIcon);
        group.occupancyIcon = occIcon;
      }

      // تشغيل الدالة
      createForests();
      // --- 9. المناجم (Mines) - نسخة الأداء العالي (InstancedMesh) ---
      const mines = [];

      function initMinesSystem() {
        // إعدادات الأعداد
        const goldCount = 200;
        const silverCount = 200;
        const totalMines = goldCount + silverCount;

        // 1. هندسة المنجم (Dodecahedron) - شكل واحد للجميع
        const mineGeo = new THREE.DodecahedronGeometry(40);
        const mineMat = new THREE.MeshStandardMaterial({
          roughness: 0.4,
          metalness: 0.6,
        });

        // 2. إنشاء الـ InstancedMesh (أمر رسم واحد لكل المناجم)
        const iMines = new THREE.InstancedMesh(mineGeo, mineMat, totalMines);
        iMines.castShadow = true;
        iMines.receiveShadow = true;
        scene.add(iMines);

        const dummy = new THREE.Object3D();
        const colorGold = new THREE.Color(0xffd700);
        const colorSilver = new THREE.Color(0xc0c0c0);

        let index = 0;

        // دالة داخلية لإنشاء مجموعة المنجم (المنطقية)
        function createMineGroup(type, idx) {
          // استخدام seededRandom الموجودة في كودك الأصلي
          const theta = seededRandom() * Math.PI * 2;
          const r = 10000 + seededRandom() * 180000;
          const x = Math.cos(theta) * r;
          const z = Math.sin(theta) * r;
          const y = 20;

          // وضع الشكل البصري في الـ InstancedMesh
          dummy.position.set(x, y, z);
          dummy.rotation.set(
            Math.random() * Math.PI,
            Math.random() * Math.PI,
            0,
          );
          dummy.scale.set(5, 5, 5); // تكبير الحجم
          dummy.updateMatrix();

          // ضبط الموقع واللون في المصفوفة الموحدة
          iMines.setMatrixAt(idx, dummy.matrix);
          iMines.setColorAt(idx, type === "gold" ? colorGold : colorSilver);

          // إنشاء المجموعة المنطقية (للتفاعل والنقر فقط - غير مرئية)
          const group = new THREE.Group();
          group.position.set(x, 0, z); // الموقع على الأرض
          group.userData = {
            type: type,
            isMine: true,
            id: `mine_${type}_${idx}`,
          };

          // هيت بوكس شفاف للنقر
          const hitBox = new THREE.Mesh(
            new THREE.BoxGeometry(200, 200, 200),
            new THREE.MeshBasicMaterial({ visible: false }),
          );
          hitBox.position.y = 100;
          group.add(hitBox);

          // إضافة النصوص والأيقونات (تظهر عند النقر)
          addMineLabelAndIcons(group, type);

          scene.add(group);
          mines.push(group);
        }

        // إنشاء مناجم الذهب
        for (let i = 0; i < goldCount; i++) {
          createMineGroup("gold", index++);
        }
        // إنشاء مناجم الفضة
        for (let i = 0; i < silverCount; i++) {
          createMineGroup("silver", index++);
        }

        // تحديث المصفوفة لتظهر في المشهد
        iMines.instanceMatrix.needsUpdate = true;
        if (iMines.instanceColor) iMines.instanceColor.needsUpdate = true;
      }

      // دالة مساعدة لإضافة نصوص وأيقونات المناجم
      function addMineLabelAndIcons(group, type) {
        // النص (Canvas Sprite)
        const txtC = document.createElement("canvas");
        txtC.width = 256;
        txtC.height = 64;
        const tCtx = txtC.getContext("2d");
        tCtx.font = "bold 40px 'Cairo'";
        tCtx.fillStyle = type === "gold" ? "#ffd700" : "#fff";
        tCtx.textAlign = "center";
        tCtx.fillText(type === "gold" ? "منجم ذهب" : "منجم فضة", 128, 45);
        const lbl = new THREE.Sprite(
          new THREE.SpriteMaterial({
            map: new THREE.CanvasTexture(txtC),
            transparent: true,
          }),
        );
        lbl.position.set(0, 90, 0);
        lbl.scale.set(80, 20, 1);
        group.add(lbl);

        // الأيقونة (تظهر عند النقر)
        const iconC = document.createElement("canvas");
        iconC.width = 64;
        iconC.height = 64;
        const iCtx = iconC.getContext("2d");
        iCtx.beginPath();
        iCtx.arc(32, 32, 30, 0, Math.PI * 2);
        iCtx.fillStyle = "rgba(0,0,0,0.5)";
        iCtx.fill();
        iCtx.fillStyle = "#fff";
        iCtx.font = '30px "Material Icons"';
        iCtx.textAlign = "center";
        iCtx.textBaseline = "middle";
        iCtx.fillText("\ue558", 32, 32);

        const icon = new THREE.Sprite(
          new THREE.SpriteMaterial({
            map: new THREE.CanvasTexture(iconC),
            transparent: true,
            depthTest: false,
          }),
        );
        icon.position.set(0, 400, 0);
        icon.scale.set(300, 300, 1);
        icon.visible = false;
        icon.userData = { isIcon: true, parentTarget: group };
        group.add(icon);
        group.icon = icon;

        // أيقونة الإشغال (تظهر إذا كان المورد محجوزاً)
        const occC = document.createElement("canvas");
        occC.width = 64;
        occC.height = 64;
        const oCtx = occC.getContext("2d");
        oCtx.fillStyle = "red";
        oCtx.font = '50px "Material Icons"';
        oCtx.textAlign = "center";
        oCtx.textBaseline = "middle";
        oCtx.fillText("\ue332", 32, 32);
        const occIcon = new THREE.Sprite(
          new THREE.SpriteMaterial({
            map: new THREE.CanvasTexture(occC),
            transparent: true,
            depthTest: false,
          }),
        );
        occIcon.position.set(0, 180, 0);
        occIcon.scale.set(60, 60, 1);
        occIcon.visible = false;
        group.add(occIcon);
        group.occupancyIcon = occIcon;
      }

      // تشغيل النظام الجديد
      initMinesSystem();

      function spawnMines(type, count) {
        for (let i = 0; i < count; i++) {
          const theta = seededRandom() * Math.PI * 2;
          const r = 10000 + seededRandom() * 180000;
          const x = Math.cos(theta) * r;
          const z = Math.sin(theta) * r;
          const y = 0;
          const id = `mine_${type}_${i}`;
          createMine(x, y, z, seededRandom() * Math.PI * 2, type, id);
        }
      }

      // Listen for Occupancy Changes (Global)
      onSnapshot(collection(db, "map_occupancy"), (snapshot) => {
        // Reset all
        mines.forEach((m) => (m.occupancyIcon.visible = false));
        forests.forEach((f) => (f.occupancyIcon.visible = false));

        snapshot.forEach((doc) => {
          const id = doc.id;
          // Find object
          const m = mines.find((x) => x.userData.id === id);
          if (m) m.occupancyIcon.visible = true;

          const f = forests.find((x) => x.userData.id === id);
          if (f) f.occupancyIcon.visible = true;
        });
      });

      // --- 10. نموذج القلعة الجديد (Advanced 3D Castle) ---
      // إنشاء الخامات مرة واحدة لتقليل التحميل
      const _castleCanvas = document.createElement("canvas");
      _castleCanvas.width = 256;
      _castleCanvas.height = 256;
      const _castleCtx = _castleCanvas.getContext("2d");
      _castleCtx.fillStyle = "#808080";
      _castleCtx.fillRect(0, 0, 256, 256);
      for (let i = 0; i < 60; i++) {
        _castleCtx.fillStyle = Math.random() > 0.5 ? "#707070" : "#909090";
        _castleCtx.fillRect(
          Math.random() * 240,
          Math.random() * 240,
          20 + Math.random() * 30,
          10 + Math.random() * 20,
        );
      }
      const _stoneTex = new THREE.CanvasTexture(_castleCanvas);
      _stoneTex.wrapS = _stoneTex.wrapT = THREE.RepeatWrapping;
      _stoneTex.repeat.set(2, 2);

      const _cMatStone = new THREE.MeshStandardMaterial({
        map: _stoneTex,
        roughness: 0.8,
      });
      const _cMatDark = new THREE.MeshStandardMaterial({
        color: 0x4a4a4a,
        roughness: 0.9,
      });
      const _cMatWood = new THREE.MeshStandardMaterial({
        color: 0x5c4033,
        roughness: 1,
      });
      const _cMatRoof = new THREE.MeshStandardMaterial({
        color: 0x2f4f4f,
        roughness: 0.6,
      });
      const _cMatFlag = new THREE.MeshStandardMaterial({
        color: 0xcc0000,
        side: THREE.DoubleSide,
      });

      function createCastleModel(level, username, uid) {
        const castleGroup = new THREE.Group();
        castleGroup.userData = { isCastle: true, uid: uid };

        // Helper functions from the provided model
        function addBox(w, h, d, x, y, z, mat) {
          const mesh = new THREE.Mesh(new THREE.BoxGeometry(w, h, d), mat);
          mesh.position.set(x, y, z);
          mesh.castShadow = true;
          mesh.receiveShadow = true;
          castleGroup.add(mesh);
          return mesh;
        }
        function addCyl(rt, rb, h, x, y, z, mat) {
          const mesh = new THREE.Mesh(
            new THREE.CylinderGeometry(rt, rb, h, 16),
            mat,
          );
          mesh.position.set(x, y, z);
          mesh.castShadow = true;
          mesh.receiveShadow = true;
          castleGroup.add(mesh);
          return mesh;
        }

        // --- Building Construction ---
        // Main Keep
        addBox(10, 12, 10, 0, 6, 0, _cMatStone);
        addBox(8, 6, 8, 0, 15, 0, _cMatStone); // Upper Floor

        // Towers
        const towerPos = [
          { x: 14, z: 14 },
          { x: -14, z: 14 },
          { x: 14, z: -14 },
          { x: -14, z: -14 },
        ];
        towerPos.forEach((pos) => {
          addCyl(3.5, 4, 15, pos.x, 7.5, pos.z, _cMatStone); // Base
          addCyl(0, 4.5, 6, pos.x, 18, pos.z, _cMatRoof); // Roof
          // Flag Pole & Flag
          addCyl(0.1, 0.1, 6, pos.x, 21, pos.z, _cMatWood);
          const flag = new THREE.Mesh(
            new THREE.PlaneGeometry(2, 1.2),
            _cMatFlag,
          );
          flag.position.set(pos.x + 1, 23, pos.z);
          castleGroup.add(flag);
        });

        // Walls
        addBox(28, 8, 3, 0, 4, -14, _cMatStone); // Back
        addBox(3, 8, 28, 14, 4, 0, _cMatStone); // Right
        addBox(3, 8, 28, -14, 4, 0, _cMatStone); // Left
        addBox(10, 8, 3, 9, 4, 14, _cMatStone); // Front R
        addBox(10, 8, 3, -9, 4, 14, _cMatStone); // Front L

        // Gatehouse
        addBox(2, 10, 4, 4, 5, 14, _cMatStone);
        addBox(2, 10, 4, -4, 5, 14, _cMatStone);
        addBox(6, 2, 4, 0, 9, 14, _cMatStone);

        // Drawbridge
        const bridge = addBox(6, 0.5, 8, 0, 0.5, 18, _cMatWood);
        bridge.rotation.x = -0.1;

        // Torches
        const torchLeft = addCyl(0.1, 0.1, 1, 3, 6, 16, _cMatWood);
        torchLeft.rotation.x = 0.5;
        const torchRight = addCyl(0.1, 0.1, 1, -3, 6, 16, _cMatWood);
        torchRight.rotation.x = 0.5;

        // --- Scaling Logic ---
        // The original model was ~200 units wide. New model is ~30 units.
        // To match the large map size, we must multiply the scale.
        const scale = 20 + level * 1.5;
        castleGroup.scale.set(scale, scale, scale);

        // --- Name Tag (Re-added) ---
        const canvas = document.createElement("canvas");
        canvas.width = 256;
        canvas.height = 128;
        const ctx = canvas.getContext("2d");
        ctx.fillStyle = "rgba(0, 0, 0, 0.5)";
        ctx.fillRect(0, 20, 256, 88);
        ctx.fillStyle = "#ffffff";
        ctx.font = "bold 40px 'Arial'";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText(username || "لاعب", 128, 50);
        ctx.fillStyle = "#f1c40f";
        ctx.font = "bold 30px 'Arial'";
        ctx.fillText("Lvl " + level, 128, 90);
        const nameSprite = new THREE.Sprite(
          new THREE.SpriteMaterial({
            map: new THREE.CanvasTexture(canvas),
            transparent: true,
          }),
        );
        nameSprite.position.set(0, 35, 0); // Position relative to new model height
        nameSprite.scale.set(40, 20, 1); // Scale relative to new model size
        castleGroup.add(nameSprite);

        return castleGroup;
      }

      // --- 11. إدارة الملف الشخصي والتعدد ---
      // --- 11. إدارة الملف الشخصي والتعدد ---
      async function handleUserProfile(user) {
        if (!user) return;
        const userRef = doc(db, "users", user.uid);
        try {
          const userSnap = await getDoc(userRef);

          let spawnX, spawnZ;
          if (!userSnap.exists() || !userSnap.data().x) {
            // Use Seeded Random even for spawns so admins can theoretically predict (optional)
            const angle = Math.random() * Math.PI * 2;
            const dist = 5000 + Math.random() * 40000;
            spawnX = Math.cos(angle) * dist;
            spawnZ = Math.sin(angle) * dist;
          }

          if (!userSnap.exists()) {
            await setDoc(userRef, {
              username: user.displayName,
              email: user.email,
              gold: 2000000,
              silver: 2000000,
              wood: 500000,
              power: 100,
              rank: 1,
              upgradeEndTime: null,
              x: spawnX,
              z: spawnZ,
              units: {},
              dailyStats: {
                date: new Date().toDateString(),
                gold: 0,
                silver: 0,
                wood: 0,
              },
              eventKills: 0, // For The Blood Event
              sanctions: { noMining: false, noRecruit: false, noAttack: false }, // Default sanctions
            });
          } else if (!userSnap.data().x) {
            await updateDoc(userRef, { x: spawnX, z: spawnZ });
          }
          // =========================================================
          // [جديد] مراقب القوافل والموارد (Mining Offline Fix)
          // =========================================================
          // =========================================================
          // [معدل] مراقب القوافل والموارد (Mining Offline Fix)
          // =========================================================
          // =========================================================
          // [معدل] مراقب القوافل والموارد (مع نظام العقوبات الاقتصادية)
          // =========================================================
          const myMiningQuery = query(
            collection(db, "mining_missions"),
            where("userId", "==", user.uid),
          );

          // لاحظ إضافة كلمة async هنا 👇
          onSnapshot(myMiningQuery, async (snapshot) => {
            if (!userDocData) return;

            // نستخدم for...of بدلاً من forEach ليعمل الـ await بشكل صحيح
            for (const docSnap of snapshot.docs) {
              const mission = docSnap.data();

              // هل انتهت المهمة؟
              if (Date.now() > mission.endTime) {
                // 1. حساب الجائزة الأساسية
                let reward = 0;
                const updateData = {};

                const today = new Date().toDateString();
                let dailyStats = userDocData.dailyStats || {
                  date: today,
                  gold: 0,
                  silver: 0,
                  wood: 0,
                };
                if (dailyStats.date !== today)
                  dailyStats = { date: today, gold: 0, silver: 0, wood: 0 };

                if (mission.targetType === "gold") reward = REWARD_GOLD;
                else if (mission.targetType === "silver")
                  reward = REWARD_SILVER;
                else if (mission.targetType === "wood") reward = REWARD_WOOD;

                // 2. [جديد] تطبيق العقوبات الاقتصادية (الحصار)
                // -----------------------------------------------------
                // جلب نسبة العقوبة من السيرفر
                const penalty = await getActiveSiegePenalty(
                  user.uid,
                  "economic",
                );

                // تطبيق الخصم (إذا كانت العقوبة 0 لن يتغير شيء)
                if (penalty > 0) {
                  console.log(
                    `تم تطبيق عقوبة اقتصادية بنسبة ${penalty * 100}%`,
                  );
                }
                reward = Math.floor(reward * (1 - penalty));
                // -----------------------------------------------------

                // 3. التحقق من الحد اليومي وتحديث البيانات
                let cappedReward = reward;

                if (mission.targetType === "gold") {
                  if (dailyStats.gold + reward > MAX_DAILY_RESOURCE)
                    cappedReward = Math.max(
                      0,
                      MAX_DAILY_RESOURCE - dailyStats.gold,
                    );
                  if (cappedReward > 0) {
                    updateData.gold = increment(cappedReward);
                    dailyStats.gold += cappedReward;
                  }
                } else if (mission.targetType === "silver") {
                  if (dailyStats.silver + reward > MAX_DAILY_RESOURCE)
                    cappedReward = Math.max(
                      0,
                      MAX_DAILY_RESOURCE - dailyStats.silver,
                    );
                  if (cappedReward > 0) {
                    updateData.silver = increment(cappedReward);
                    dailyStats.silver += cappedReward;
                  }
                } else if (mission.targetType === "wood") {
                  if (dailyStats.wood + reward > MAX_DAILY_RESOURCE)
                    cappedReward = Math.max(
                      0,
                      MAX_DAILY_RESOURCE - dailyStats.wood,
                    );
                  if (cappedReward > 0) {
                    updateData.wood = increment(cappedReward);
                    dailyStats.wood += cappedReward;
                  }
                }

                // التنفيذ
                if (cappedReward > 0) {
                  updateData.dailyStats = dailyStats;
                  updateDoc(userRef, updateData);
                  if (mission.resourceId)
                    deleteDoc(
                      doc(db, "map_occupancy", mission.resourceId),
                    ).catch(() => {});
                  deleteDoc(doc(db, "mining_missions", docSnap.id));
                } else {
                  // حذف المهمة حتى لو وصل للحد الأقصى
                  deleteDoc(doc(db, "mining_missions", docSnap.id));
                  if (mission.resourceId)
                    deleteDoc(
                      doc(db, "map_occupancy", mission.resourceId),
                    ).catch(() => {});
                }
              }
            }
          });
          // =========================================================
          // =========================================================

          // 1. مراقب بيانات المستخدم (الموارد + إصلاح التطوير أوفلاين)
         onSnapshot(userRef, (doc) => {
            if (doc.exists()) {
              userDocData = doc.data();

              // [جديد] إصلاح مشكلة التطوير أثناء الخروج (Offline Upgrade Fix)
              if (userDocData.upgradeEndTime) {
                const now = Date.now();
                // إذا كان الوقت الحالي أكبر من وقت الانتهاء
                if (now > userDocData.upgradeEndTime) {
                  updateDoc(userRef, {
                    rank: increment(1), // زيادة المستوى
                    power: increment(500), // زيادة القوة
                    upgradeEndTime: null, // إزالة المؤقت
                  }).then(() => {
                    alert("🎉 تم اكتمال تطوير قلعتك أثناء غيابك!");
                  });
                }
              }

              // 👇👇 [تمت الإضافة] تشغيل الشرح التعليمي عند التحميل 👇👇
              if (typeof checkAndStartTutorial === "function" && !window.tutorialStartedFlag) {
                   window.tutorialStartedFlag = true; // متغير لمنع التكرار في نفس الجلسة
                   checkAndStartTutorial();
              }
              // 👆👆 --------------------------------------------- 👆👆

              // تحديث واجهة المستخدم (UI Update)
              uiGold.innerText = userDocData.gold
                ? userDocData.gold.toLocaleString()
                : "0";
              uiSilver.innerText = userDocData.silver
                ? userDocData.silver.toLocaleString()
                : "0";
              uiWood.innerText = userDocData.wood
                ? userDocData.wood.toLocaleString()
                : "0";
              uiPower.innerText = userDocData.power
                ? userDocData.power.toLocaleString()
                : "0";
              uiLvl.innerText = userDocData.rank || 1;

              if (myCastleMesh) {
                // Update scale based on level
                const scale = 20 + (userDocData.rank || 1) * 1.5;
                myCastleMesh.scale.set(scale, scale, scale);
              }
            }
          });

          // =========================================================
          // [مضاف هنا] إصلاح مشكلة الهجوم أثناء الخروج (Offline Battle Fix)
          // =========================================================
          const myAttacksQuery = query(
            collection(db, "attacks"),
            where("attackerId", "==", user.uid),
            where("status", "==", "active"),
          );

          // نراقب الهجمات التي قمت بإرسالها
          onSnapshot(myAttacksQuery, (snapshot) => {
            snapshot.forEach((docSnap) => {
              const attackData = docSnap.data();
              // هل انتهى الوقت المحدد للهجوم؟
              if (Date.now() > attackData.endTime) {
                console.log("Found finished offline attack:", docSnap.id);

                // ننشئ كائن جيش وهمي لنمرره لدالة المعركة
                const mockArmy = {
                  targetId: attackData.targetId,
                  unitsPayload: attackData.unitsPayload, // الجيش الذي حفظناه
                  attackDocId: docSnap.id,
                  type: "ATTACK",
                };

                // ننفذ المعركة فوراً
                resolveBattle(mockArmy);
              }
            });
          });
          // =========================================================

          // 2. مراقب التحذير من الهجوم (Incoming Attack Warning)
          const attacksQuery = query(
            collection(db, "attacks"),
            where("targetId", "==", user.uid),
          );

          let firstLoad = true;

          onSnapshot(attacksQuery, (snapshot) => {
            if (firstLoad) {
              firstLoad = false;
              return;
            }

            let underAttack = false;
            snapshot.forEach((doc) => {
              if (doc.data().status === "active") {
                underAttack = true;
              }
            });

            if (underAttack) {
              warningOverlay.style.display = "flex";
              alarmSound.play().catch(() => {});
              setTimeout(() => {
                warningOverlay.style.display = "none";
              }, 3000);
            } else {
              warningOverlay.style.display = "none";
              alarmSound.pause();
              alarmSound.currentTime = 0;
            }
          });

          // 3. مراقب البريد (Mail Badge)
          const reportsRef = collection(db, "users", user.uid, "reports");
          const qRep = query(
            reportsRef,
            orderBy("timestamp", "desc"),
            limit(1),
          );
          onSnapshot(qRep, (snap) => {
            snap.docChanges().forEach((change) => {
              if (change.type === "added") {
                if (
                  document.getElementById("reports-modal").style.display ===
                  "none"
                ) {
                  mailBadge.style.display = "block";
                }
              }
            });
          });

          initMultiplayer();
        } catch (error) {
          console.error("Database Error:", error);
        }
      }

      function initMultiplayer() {
        const usersRef = collection(db, "users");
        onSnapshot(usersRef, (snapshot) => {
          snapshot.docChanges().forEach((change) => {
            const data = change.doc.data();
            const uid = change.doc.id;
            if (typeof data.x !== "number" || typeof data.z !== "number")
              return;

            if (change.type === "added" || change.type === "modified") {
              if (otherCastles[uid]) scene.remove(otherCastles[uid]);
              const castle = createCastleModel(
                data.rank || 1,
                data.username,
                uid,
              );
              castle.position.set(data.x, 0, data.z);
              scene.add(castle);
              otherCastles[uid] = castle;

              if (currentUser && uid === currentUser.uid) {
                myCastleMesh = castle;
                updateMyCastleIcons(data.x, 600, data.z);
                if (change.type === "added") {
                  // توجيه الكاميرا نحو قلعة اللاعب مباشرة عند الدخول
                  camera.position.set(data.x, 8000, data.z);
                  controls.target.set(data.x, 0, data.z);
                }
              }
            }
            if (change.type === "removed") {
              if (otherCastles[uid]) {
                scene.remove(otherCastles[uid]);
                delete otherCastles[uid];
              }
            }
          });
        });
      }

      // --- 12. شريط التقدم (بدون أيقونات التاج) ---
      let progressBarSprite;

      function updateMyCastleIcons(x, y, z) {
        if (progressBarSprite) progressBarSprite.position.set(x, y + 200, z);
      }

      function createProgressBar() {
        const canvas = document.createElement("canvas");
        canvas.width = 256;
        canvas.height = 32;
        const sprite = new THREE.Sprite(
          new THREE.SpriteMaterial({
            map: new THREE.CanvasTexture(canvas),
            transparent: true,
            depthTest: false,
          }),
        );
        sprite.scale.set(200, 25, 1);
        sprite.position.set(0, -5000, 0);
        sprite.visible = false;
        sprite.userData = { isProgressBar: true, canvas: canvas };
        scene.add(sprite);
        return sprite;
      }
      progressBarSprite = createProgressBar();

      function updateProgressBar(percentage) {
        if (!progressBarSprite) return;
        const { canvas } = progressBarSprite.userData;
        const ctx = canvas.getContext("2d");
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = "#333";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = "#00FF00";
        ctx.fillRect(
          2,
          2,
          canvas.width * Math.min(percentage, 1) - 4,
          canvas.height - 4,
        );
        progressBarSprite.material.map.needsUpdate = true;
      }

      // --- 13. القوافل (Caravans) - نسخة الأوفلاين ---
      const activeCaravans = [];

      async function spawnCaravan(targetObject) {
        if (!currentUser || !myCastleMesh)
          return alert("سجل الدخول أولاً وانتظر ظهور قلعتك!");

        // فحص العقوبات
        if (userDocData.sanctions && userDocData.sanctions.noMining) {
          return alert("⛔ تم منعك من جمع الموارد بقرار إداري!");
        }

        // فحص العدد الأقصى
        const lvl = userDocData.rank || 1;
        let maxCaravans = 1;
        if (lvl >= 50) maxCaravans = 5;
        else if (lvl >= 20) maxCaravans = 3;
        else if (lvl >= 10) maxCaravans = 2;

        // نحسب القوافل النشطة في السيرفر (سنحتاج لقراءة هذا الرقم، لكن سنعتمد على المصفوفة مؤقتاً)
        if (activeCaravans.length >= maxCaravans) {
          return alert(
            `لقد وصلت للحد الأقصى للقوافل (${maxCaravans}) لمستوى قلعتك.`,
          );
        }

        // فحص الحجز
        const resourceId = targetObject.userData.id;
        if (resourceId) {
          const ref = doc(db, "map_occupancy", resourceId);
          const snap = await getDoc(ref);
          if (snap.exists()) {
            return alert("⛔ هذا المورد محجوز حالياً بواسطة لاعب آخر!");
          }
          // حجز المورد
          await setDoc(ref, {
            occupier: currentUser.uid,
            timestamp: Date.now(),
          });
        }

        // --- حساب الوقت ---
        // المسافة
        const startPos = myCastleMesh.position.clone();
        const end = new THREE.Vector3(
          targetObject.position.x,
          targetObject.position.y,
          targetObject.position.z,
        );
        const dist = startPos.distanceTo(end);

        // السرعة في الأنيميشن تقريباً 0.002 من المسافة لكل إطار
        // سنحسب وقتاً تقريبياً: (المسافة / السرعة) * 2 (ذهاب وعودة) + وقت التعدين
        // معادلة تقريبية: المسافة / 30 = ثواني الطريق (مثال)
        const travelTimeMs = (dist / 100) * 1000;
        const totalTimeMs = travelTimeMs * 2 + MINING_DURATION_MS;
        const endTime = Date.now() + totalTimeMs;

        // --- تسجيل المهمة في السيرفر (الأهم للأوفلاين) ---
        try {
          await addDoc(collection(db, "mining_missions"), {
            userId: currentUser.uid,
            resourceId: resourceId || "unknown",
            targetType: targetObject.userData.type,
            startTime: Date.now(),
            endTime: endTime,
            status: "active",
          });
        } catch (e) {
          console.error(e);
        }

        // --- الرسم (للمشاهدة فقط) ---
        startPos.y += 30;
        const caravan = new THREE.Group();
        const body = new THREE.Mesh(
          new THREE.BoxGeometry(20, 15, 30),
          mineWoodMat,
        );
        body.position.y = 15;
        caravan.add(body);
        caravan.position.copy(startPos);
        scene.add(caravan);

        const points = [startPos, end];
        const line = new THREE.Line(
          new THREE.BufferGeometry().setFromPoints(points),
          new THREE.LineBasicMaterial({ color: 0x00ff00 }),
        );
        scene.add(line);

        activeCaravans.push({
          mesh: caravan,
          line: line,
          start: startPos,
          end: end,
          progress: 0,
          speed: 0.002, // سرعة الرسم
          state: "TO_MINE",
          targetType: targetObject.userData.type,
          resourceId: resourceId,
          mineStart: 0, // سيتم ضبطه في الأنيميشن
        });

        targetObject.icon.visible = false;
        alert("انطلقت القافلة! سيتم جمع الموارد حتى لو أغلقت اللعبة.");
      }
      // --- 14. التفاعل (Raycasting and Clicks) ---
      const raycaster = new THREE.Raycaster();
      const mouse = new THREE.Vector2();
      window.addEventListener("mousedown", (e) => {
    // الحل الجذري: إذا لم يكن العنصر المضغوط هو الـ Canvas (اللعبة)، لا تفعل شيئاً
    if (e.target.tagName !== "CANVAS") return;

    mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
    mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
    raycaster.setFromCamera(mouse, camera);

    // =========================================================
    // [جديد] منطق نقل القلعة (الأولوية القصوى)
    // =========================================================
    if (isTeleporting) {
        // التحقق من تقاطع الشعاع مع الأرض (terrain)
        // ملاحظة: يجب أن يكون المتغير terrain معرفاً في النطاق العام (وهو موجود في كودك الأصلي)
        const hitTerrain = raycaster.intersectObject(terrain);
        
        if (hitTerrain.length > 0) {
            const point = hitTerrain[0].point;
            // تنفيذ النقل إلى النقطة التي تم الضغط عليها
            executeTeleport(point.x, point.z);
        }
        // إيقاف أي تفاعل آخر (مثل فتح القوائم) أثناء وضع النقل
        return;
    }
    // =========================================================

    // منطق إرسال القوافل (Caravans) - النقر على الأيقونات العائمة
    const allResIcons = [
        ...mines.map((m) => m.icon).filter((i) => i.visible),
        ...forests.map((f) => f.icon).filter((i) => i.visible),
    ];
    const hitResIcon = raycaster.intersectObjects(allResIcons);
    if (hitResIcon.length > 0) {
        spawnCaravan(hitResIcon[0].object.userData.parentTarget);
        return;
    }

    // منطق النقر على المناجم (لإظهار الأيقونة)
    const hitMine = raycaster.intersectObjects(mines, true);
    if (hitMine.length > 0) {
        let p = hitMine[0].object;
        while (p.parent && !p.userData.isMine) p = p.parent;
        
        // إخفاء جميع الأيقونات الأخرى
        mines.forEach((m) => (m.icon.visible = false));
        forests.forEach((f) => (f.icon.visible = false));
        
        // إظهار أيقونة هذا المنجم
        p.icon.visible = true;
        
        // إخفاء القوائم الأخرى
        castleControlsPanel.style.display = "none";
        if (currentUser) mobileControls.style.display = "flex"; // Restore buttons
        return;
    }

    // منطق النقر على الغابات (لإظهار الأيقونة)
    const hitForest = raycaster.intersectObjects(forests, true);
    if (hitForest.length > 0) {
        let p = hitForest[0].object;
        while (p.parent && !p.userData.isForest) p = p.parent;
        
        mines.forEach((m) => (m.icon.visible = false));
        forests.forEach((f) => (f.icon.visible = false));
        
        p.icon.visible = true;
        
        castleControlsPanel.style.display = "none";
        if (currentUser) mobileControls.style.display = "flex";
        return;
    }

    // منطق النقر على القلاع (صديقة أو عدو)
    const castleIntersect = raycaster.intersectObjects(
        Object.values(otherCastles),
        true,
    );
    if (castleIntersect.length > 0) {
        let target = castleIntersect[0].object;
        while (target.parent && !target.userData.isCastle)
            target = target.parent;

        if (target.userData.isCastle) {
            // الحالة 1: ضغطت على قلعتي
            if (currentUser && target.userData.uid === currentUser.uid) {
                // إظهار قائمة التحكم بالقلعة
                castleControlsPanel.style.display = "flex";
                // إخفاء أزرار الموبايل لمنع التداخل
                mobileControls.style.display = "none";
            }
            // الحالة 2: ضغطت على قلعة عدو
            else if (currentUser && target.userData.uid !== currentUser.uid) {
                castleControlsPanel.style.display = "none";
                if (currentUser) mobileControls.style.display = "flex";
                // فتح قائمة الهجوم/التبرع
                openActionMenu(target.userData.uid);
            }
        }
        return;
    }

    // النقر في الفراغ (إلغاء التحديدات)
    mines.forEach((m) => (m.icon.visible = false));
    forests.forEach((f) => (f.icon.visible = false));
    castleControlsPanel.style.display = "none";
    if (currentUser) mobileControls.style.display = "flex"; // إعادة الأزرار
});

      // --- 15. منطق نافذة التطوير الجديد ---

      window.openUpgradeModal = () => {
          resetInputKeys();
        if (!currentUser || !userDocData) return;
        if (userDocData.upgradeEndTime) {
          alert("القلعة قيد التطوير بالفعل!");
          // Restore buttons immediately if blocked
          mobileControls.style.display = "flex";
          return;
        }

        const lvl = userDocData.rank || 1;
        const nextLvl = lvl + 1;
        const cost = BASE_UPGRADE_COST * Math.pow(3, lvl - 1);
        let woodCost = 0;
        if (lvl >= 10) woodCost = 2000000 * Math.pow(3, lvl - 10);

        document.getElementById("upg-next-lvl").innerText =
          `Level ${lvl} ➔ Level ${nextLvl}`;
        document.getElementById("upg-time").innerText = `${
          BASE_UPGRADE_TIME_MIN * lvl
        } دقيقة`;

        const container = document.getElementById("upg-costs-container");
        container.innerHTML = "";

        const goldClass = userDocData.gold >= cost ? "ok" : "no";
        const silverClass = userDocData.silver >= cost ? "ok" : "no";

        container.innerHTML += `
        <div class="resource-row"><span class="res-name">الذهب:</span><span class="res-val ${goldClass}">${cost.toLocaleString()}</span></div>
        <div class="resource-row"><span class="res-name">الفضة:</span><span class="res-val ${silverClass}">${cost.toLocaleString()}</span></div>
      `;

        if (woodCost > 0) {
          const woodClass = userDocData.wood >= woodCost ? "ok" : "no";
          container.innerHTML += `<div class="resource-row"><span class="res-name">الخشب:</span><span class="res-val ${woodClass}">${woodCost.toLocaleString()}</span></div>`;
        }

        const btn = document.getElementById("confirm-upgrade-btn");
        if (
          userDocData.gold < cost ||
          userDocData.silver < cost ||
          userDocData.wood < woodCost
        ) {
          btn.disabled = true;
          btn.innerText = "موارد غير كافية ";
        } else {
          btn.disabled = false;
          btn.innerText = "تأكيد التطوير وبدء البناء ";
          btn.onclick = () => executeUpgrade(cost, woodCost, lvl);
        }

        upgradeModal.style.display = "flex";
      };

      window.executeUpgrade = async (cost, woodCost, lvl) => {
        const btn = document.getElementById("confirm-upgrade-btn");
        
        // 1. حماية الواجهة: تعطيل الزر فوراً وتغيير نصه
        if (btn) {
            if (btn.disabled) return; // إذا كان معطلاً بالفعل، توقف
            btn.disabled = true;
            btn.innerText = "⏳ جاري المعالجة...";
        }

        // 2. حماية المنطق: التأكد من أن البيانات محدثة
        if (!userDocData) return;
        
        // التحقق مما إذا كان هناك تطوير جارٍ بالفعل (حماية إضافية)
        if (userDocData.upgradeEndTime && userDocData.upgradeEndTime > Date.now()) {
            alert("⛔ القلعة قيد التطوير بالفعل! لا يمكن تنفيذ طلبين في وقت واحد.");
            closeUpgradeModal();
            return;
        }

        // التحقق من الموارد مرة أخرى (للحماية من التلاعب السريع)
        if (userDocData.gold < cost || userDocData.silver < cost || (woodCost > 0 && userDocData.wood < woodCost)) {
             alert("الموارد غير كافية!");
             closeUpgradeModal();
             return;
        }

        try {
            // 3. التنفيذ الآمن
            await updateDoc(doc(db, "users", currentUser.uid), {
                gold: increment(-cost),
                silver: increment(-cost),
                wood: increment(-woodCost),
                upgradeEndTime: Date.now() + BASE_UPGRADE_TIME_MIN * lvl * 60000,
            });
            
            // إغلاق النافذة بعد النجاح
            closeUpgradeModal();
            
        } catch (e) {
            console.error(e);
            alert("حدث خطأ في الاتصال، حاول مرة أخرى.");
            // إعادة تفعيل الزر في حالة الفشل فقط
            if (btn) {
                btn.disabled = false;
                btn.innerText = "تأكيد التطوير";
            }
        }
      };

      // --- كود المصادقة المعدل (لحل مشكلة زر المشرفين) ---
      onAuthStateChanged(auth, async (u) => {
        // تعريف العناصر
        const uiContainer = document.getElementById("ui-container");
        const loginForm = document.getElementById("login-form");
        const navbar = document.getElementById("game-navbar");
        const mobileControls = document.getElementById("mobile-controls");
        const adminBtn = document.getElementById("admin-sidebar-btn");
        const splash = document.getElementById("splash-screen");

        if (u) {
          // --- حالة تسجيل الدخول ---
          console.log("User Logged In:", u.email);
          currentUser = u;
          initEventSystem();

          // 1. إخفاء الشاشة السوداء وشاشة البداية
          if (uiContainer) uiContainer.style.display = "none";
          if (loginForm) loginForm.style.display = "none";
          if (splash) splash.style.display = "none";

          // 2. إظهار عناصر اللعبة
          if (navbar) navbar.style.display = "flex";
          if (mobileControls) mobileControls.style.display = "flex";

          // 3. تحميل بيانات اللاعب
          handleUserProfile(u);

          // 4. التحقق من الصلاحيات (أدمن أو مشرف) لإظهار الزر
          if (adminBtn) {
            // افتراضياً نخفي الزر حتى نتأكد
            adminBtn.style.display = "none";

            const myEmail = u.email.toLowerCase();
            const adminEmail = ADMIN_EMAIL.toLowerCase();

            if (myEmail === adminEmail) {
              // هذا هو الأدمن الرئيسي
              adminBtn.style.display = "flex";
            } else {
              // التحقق مما إذا كان مشرفاً في قاعدة البيانات
              try {
                const modRef = doc(db, "moderators", myEmail);
                const modSnap = await getDoc(modRef);
                if (modSnap.exists()) {
                  adminBtn.style.display = "flex"; // إظهار الزر للمشرف
                }
              } catch (e) {
                console.error("Error checking moderator status:", e);
              }
            }
          }
        } else {
          // --- حالة تسجيل الخروج ---
          onAuthStateChanged(auth, async (u) => {
            // ... تعريف المتغيرات ...

            if (u) {
              // --- حالة تسجيل الدخول (أنت مسجل بالفعل) ---
              console.log("User Logged In:", u.email);
              currentUser = u;

              // 1. تأكد أن واجهة الدخول مخفية
              if (document.getElementById("ui-container")) {
                document.getElementById("ui-container").style.display = "none";
              }

              // إخفاء شاشة البداية (Splash)
              const splash = document.getElementById("splash-screen");
              if (splash) splash.style.display = "none";

              // إظهار اللعبة
              if (navbar) navbar.style.display = "flex";
              if (mobileControls) mobileControls.style.display = "flex";

              // تحميل البيانات
              handleUserProfile(u);

              // ... باقي كود التحقق من الآدمن ...
            } else {
              // --- حالة عدم تسجيل الدخول (جديد أو سجل خروج) ---
              console.log("User Logged Out");
              currentUser = null;
              userDocData = null;

              // >>> التعديل هنا: الآن فقط نظهر نافذة الدخول <<<
              if (document.getElementById("ui-container")) {
                document.getElementById("ui-container").style.display = "flex"; // إظهارها الآن
              }

              if (loginForm) loginForm.style.display = "block";
              if (navbar) navbar.style.display = "none";
              if (mobileControls) mobileControls.style.display = "none";

              // تنظيف المشهد
              if (typeof otherCastles !== "undefined") {
                Object.values(otherCastles).forEach((c) => scene.remove(c));
                for (let key in otherCastles) delete otherCastles[key];
              }
              myCastleMesh = null;
            }
          });

          if (uiContainer) uiContainer.style.display = "flex";
          if (loginForm) loginForm.style.display = "block";
          if (navbar) navbar.style.display = "none";
          if (mobileControls) mobileControls.style.display = "none";
          if (document.getElementById("castle-controls-panel")) {
            document.getElementById("castle-controls-panel").style.display =
              "none";
          }
          if (typeof otherCastles !== "undefined") {
            Object.values(otherCastles).forEach((c) => scene.remove(c));
            for (let key in otherCastles) delete otherCastles[key];
          }
          myCastleMesh = null;
        }
      });
      const keys = {};
      window.onkeydown = (e) => (keys[e.code] = true);
      window.onkeyup = (e) => (keys[e.code] = false);

      // التعامل مع أزرار الموبايل
      const mobileKeys = { up: false, down: false, left: false, right: false };
       // ... (بعد تعريف mobileKeys مباشرة)

      // --- دالة إيقاف الحركة (تضاف هنا) ---
      function resetInputKeys() {
        // تصفير مفاتيح الكيبورد
        for (let key in keys) keys[key] = false;
        // تصفير أزرار الموبايل
        mobileKeys.up = false;
        mobileKeys.down = false;
        mobileKeys.left = false;
        mobileKeys.right = false;
      }
      const attachMobileEvents = (id, key) => {
        const btn = document.getElementById(id);
        const start = (e) => {
          e.preventDefault();
          mobileKeys[key] = true;
        };
        const end = (e) => {
          e.preventDefault();
          mobileKeys[key] = false;
        };
        btn.addEventListener("mousedown", start);
        btn.addEventListener("mouseup", end);
        btn.addEventListener("mouseleave", end);
        btn.addEventListener("touchstart", start);
        btn.addEventListener("touchend", end);
      };
      attachMobileEvents("m-up", "up");
      attachMobileEvents("m-down", "down");
      attachMobileEvents("m-left", "left");
      attachMobileEvents("m-right", "right");

      window.onresize = () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      };
           // --- تعريف خصائص الوحدات (للحسابات المعقدة) ---
const UNIT_STATS = {
    infantry: { atk: 10, def: 20, capacity: 10, bonusVs: 'cavalry' }, // مشاة: دفاعي + ضد الفرسان
    archers:  { atk: 25, def: 5,  capacity: 5,  bonusVs: 'infantry' }, // رماة: هجومي + ضد المشاة
    cavalry:  { atk: 35, def: 15, capacity: 20, bonusVs: 'archers' },  // فرسان: سريع + ضد الرماة
    siege:    { atk: 80, def: 10, capacity: 50, bonusVs: 'wall' }      // مركبات: تدمير الجدران
};
     // --- دالة المعركة المتطورة ---
async function resolveBattle(army) {
    // 1. تنظيف التنبيهات من قاعدة البيانات
    if (army.attackDocId) {
        try {
            // نحدث الحالة فقط، والحذف يتم لاحقاً أو عبر Cloud Function
            updateDoc(doc(db, "attacks", army.attackDocId), { status: "finished" });
            setTimeout(() => deleteDoc(doc(db, "attacks", army.attackDocId)).catch(()=>{}), 5000);
        } catch (e) {}
    }

    // التبرع لا يمر من هنا
    if (army.type === "DONATE") return;

    try {
        // --- 1. جلب بيانات المدافع ---
        const enemyRef = doc(db, "users", army.targetId);
        const enemySnap = await getDoc(enemyRef);

        if (!enemySnap.exists()) return console.error("Enemy not found");

        const enemyData = enemySnap.data();
        const defenderUnits = enemyData.units || {};
        const defenderCastleLevel = enemyData.rank || 1;

        // --- 2. حساب قوة المهاجم (مع تصنيف الوحدات) ---
        let attTotalAtk = 0;
        let attTotalDef = 0; // نحتاجه لحساب الخسائر
        let attCapacity = 0; // سعة التحميل
        let attComposition = { infantry:0, archers:0, cavalry:0, siege:0 }; // إحصاء العدد

        for (const [key, count] of Object.entries(army.unitsPayload)) {
            if(count <= 0) continue;
            const [type, lvlStr] = key.split('_'); 
            const level = parseInt(lvlStr) || 1;
            const stats = UNIT_STATS[type] || {atk:10, def:10, capacity:10};
            
            // معادلة القوة مع المستوى
            const lvlMult = Math.pow(1.2, level - 1); // زيادة 20% لكل مستوى
            
            const unitAtk = stats.atk * lvlMult * level;
            const unitDef = stats.def * lvlMult * level;

            attTotalAtk += unitAtk * count;
            attTotalDef += unitDef * count;
            attCapacity += (stats.capacity * count);
            
            if(attComposition[type] !== undefined) attComposition[type] += count;
        }

        // --- 3. حساب قوة المدافع (مع تصنيف الوحدات) ---
        let defTotalAtk = 0; // نحتاجه لحساب ضرر المهاجم
        let defTotalDef = 0;
        let defComposition = { infantry:0, archers:0, cavalry:0, siege:0 };

        for (const [key, count] of Object.entries(defenderUnits)) {
            if(count <= 0) continue;
            const [type, lvlStr] = key.split('_');
            const level = parseInt(lvlStr) || 1;
            const stats = UNIT_STATS[type] || {atk:10, def:10};

            const lvlMult = Math.pow(1.2, level - 1);

            const unitAtk = stats.atk * lvlMult * level;
            const unitDef = stats.def * lvlMult * level;

            defTotalAtk += unitAtk * count;
            defTotalDef += unitDef * count;

            if(defComposition[type] !== undefined) defComposition[type] += count;
        }

        // --- 4. تطبيق "بونص" الجدار (Wall Bonus) للمدافع ---
        // كل مستوى قلعة يعطي زيادة 5% للدفاع
        // لكن المركبات (Siege) عند المهاجم تقلل هذا البونص!
        const baseWallBonus = 1 + (defenderCastleLevel * 0.05); 
        // كل مركبة تقلل كفاءة الجدار قليلاً (بحد أقصى إلغاء البونص)
        const siegeReduction = Math.min(0.5, (attComposition.siege * 0.01)); // أقصى حد خصم 50%
        const finalWallBonus = Math.max(1, baseWallBonus - siegeReduction);

        defTotalDef = defTotalDef * finalWallBonus;

        // --- 5. تطبيق نظام المضادات (Tactical Counters) ---
        // إضافة 15% قوة هجومية إذا كان لديك النوع المضاد للعدو
        
        // هل المهاجم يملك فرسان أكثر من مشاة العدو؟ (بونص ضد الرماة)
        if (attComposition.cavalry > defComposition.infantry) attTotalAtk *= 1.15;
        // هل المهاجم يملك رماة ويحميهم؟
        if (attComposition.archers > 0 && attComposition.infantry > 0) attTotalAtk *= 1.1; 

        // هل المدافع يملك مشاة لصد الفرسان؟
        if (defComposition.infantry > attComposition.cavalry) defTotalDef *= 1.15;

        // --- 6. عامل الحظ (Random Factor) ---
        // رقم عشوائي بين 0.9 و 1.1
        const attLuck = 0.9 + Math.random() * 0.2;
        const defLuck = 0.9 + Math.random() * 0.2;

        const finalAttPower = attTotalAtk * attLuck;
        const finalDefPower = defTotalDef * defLuck;

        console.log(`Battle: ATT(${finalAttPower.toFixed(0)}) vs DEF(${finalDefPower.toFixed(0)})`);

        // --- 7. تحديد النتيجة وحساب الخسائر ---
        const isAttackerWin = finalAttPower > finalDefPower;
        
        // حساب نسبة الضرر (كلما كانت المعركة متقاربة، زادت الخسائر)
        // Ratio: 1.0 = متكافئة جداً (خسائر عالية)، 2.0 = اكتساح (خسائر قليلة)
        const battleRatio = isAttackerWin ? (finalAttPower / finalDefPower) : (finalDefPower / finalAttPower);
        
        // دالة لحساب نسبة الخسارة (Loss Percentage)
        // إذا النسبة 1 (متادلة) الخسارة 40%، إذا النسبة 3 (اكتساح) الخسارة 10%
        const lossFactor = Math.max(0.05, 0.4 - ((battleRatio - 1) * 0.1)); 

        const myUpdate = {};
        const enemyUpdate = {};

        // === إذا فاز المهاجم ===
        if (isAttackerWin) {
            // أ. حساب الموارد المنهوبة (بناءً على سعة التحميل)
            let lootGold = 0, lootSilver = 0;
            // المدافع يخسر نسبة من موارده (مثلاً 30%)
            const potentialGold = Math.floor((enemyData.gold || 0) * 0.3);
            const potentialSilver = Math.floor((enemyData.silver || 0) * 0.3);
            
            // لا نأخذ أكثر مما نستطيع حمله
            let currentLoad = 0;
            
            // نملأ الذهب أولاً
            if (currentLoad < attCapacity) {
                const take = Math.min(potentialGold, attCapacity - currentLoad);
                lootGold = take;
                currentLoad += take;
            }
            // ثم الفضة
            if (currentLoad < attCapacity) {
                const take = Math.min(potentialSilver, attCapacity - currentLoad);
                lootSilver = take;
                currentLoad += take;
            }

            // تحديث الموارد
            myUpdate.gold = increment(lootGold);
            myUpdate.silver = increment(lootSilver);
            enemyUpdate.gold = increment(-lootGold);
            enemyUpdate.silver = increment(-lootSilver);

            // ب. خسائر المهاجم (الفائز يخسر القليل)
            // نعيد الجنود الأحياء فقط
            for (const [unitKey, count] of Object.entries(army.unitsPayload)) {
                // الفائز يخسر (lossFactor / 2) لأنه انتصر
                const survivors = Math.floor(count * (1 - (lossFactor * 0.5)));
                if (survivors > 0) {
                    myUpdate[`units.${unitKey}`] = increment(survivors);
                }
            }

            // ج. خسائر المدافع (الخاسر يخسر الكثير)
            for (const [unitKey, count] of Object.entries(defenderUnits)) {
                // الخاسر يخسر (lossFactor * 1.5)
                const dead = Math.floor(count * (lossFactor * 1.5));
                if (dead > 0) {
                    enemyUpdate[`units.${unitKey}`] = increment(-dead);
                }
            }

            // تحديث The Blood Event
            if (isBloodEventActive) {
                // نحسب عدد قتلى العدو الإجمالي
                let totalKills = 0;
                for(let k in defenderUnits) totalKills += Math.floor(defenderUnits[k] * lossFactor * 1.5);
                myUpdate.eventKills = increment(totalKills);
            }

            alert(`🏆 نصر ساحق!\nالموارد المنهوبة: ${lootGold} ذهب | ${lootSilver} فضة\nخسائر جيشك: ${((lossFactor * 0.5)*100).toFixed(1)}%`);

        } 
        // === إذا خسر المهاجم ===
        else {
            // أ. خسائر المهاجم (الخاسر)
            // يعود القليل جداً من الناجين (أو لا أحد)
            for (const [unitKey, count] of Object.entries(army.unitsPayload)) {
                // يخسر نسبة كبيرة جداً (مثلاً 80% ماتوا)
                const survivors = Math.floor(count * 0.1); // عودة 10% فقط كفلول هاربة
                if (survivors > 0) {
                    myUpdate[`units.${unitKey}`] = increment(survivors);
                }
            }

            // ب. خسائر المدافع (الفائز)
            for (const [unitKey, count] of Object.entries(defenderUnits)) {
                const dead = Math.floor(count * (lossFactor * 0.5));
                if (dead > 0) {
                    enemyUpdate[`units.${unitKey}`] = increment(-dead);
                }
            }

            alert(`☠️ هزيمة مؤلمة!\nدفاعات العدو كانت قوية جداً.\nنجا فقط 10% من جيشك.`);
        }

        // --- 8. تنفيذ التحديثات في قاعدة البيانات ---
        await updateDoc(doc(db, "users", currentUser.uid), myUpdate);
        await updateDoc(enemyRef, enemyUpdate);

    } catch (e) {
        console.error("Battle Logic Error:", e);
    }
}
      // --- منطق الدبلوماسية (Diplomacy Logic) ---

      // 1. فتح النافذة وتحميل اللاعبين
      window.openDiplomacyModal = async () => {
        document.getElementById("diplomacy-modal").style.display = "flex";
        switchDiplomacyTab("peace"); // الافتراضي

        // تحميل قائمة اللاعبين (باستثناء نفسي)
        const peaceSelect = document.getElementById("peace-target-select");
        const siegeSelect = document.getElementById("siege-target-select");

        peaceSelect.innerHTML = "<option>جاري التحميل...</option>";

        try {
          const q = query(collection(db, "users"), limit(50)); // جلب عينة
          const snapshot = await getDocs(q);

          let optionsHTML = "";
          snapshot.forEach((doc) => {
            if (doc.id !== currentUser.uid) {
              const d = doc.data();
              // عرض الاسم والقوة للمساعدة في القرار
              optionsHTML += `<option value="${doc.id}" data-power="${
                d.power || 0
              }">
                      ${d.username} (قوة: ${(d.power || 0).toLocaleString()})
                  </option>`;
            }
          });

          peaceSelect.innerHTML = optionsHTML;
          siegeSelect.innerHTML = optionsHTML;
        } catch (e) {
          console.error(e);
          peaceSelect.innerHTML = "<option>خطأ في التحميل</option>";
        }
      };

      // 2. التبديل بين التبويبات
      window.switchDiplomacyTab = (tab) => {
        document
          .querySelectorAll(".admin-tab")
          .forEach((t) => t.classList.remove("active"));
        document
          .querySelectorAll(".admin-section")
          .forEach((s) => (s.style.display = "none"));

        // تفعيل الزر والقسم (استخدمنا نفس كلاسات الأدمن لسهولة التنسيق)
        if (tab === "peace") {
          document
            .querySelector(".admin-tab:nth-child(1)")
            .classList.add("active"); // هذا تقريبي، يفضل استخدام ID
          document.getElementById("dip-sec-peace").style.display = "block";
        } else {
          document
            .querySelector(".admin-tab:nth-child(2)")
            .classList.add("active");
          document.getElementById("dip-sec-siege").style.display = "block";
        }
      };

      // 3. إرسال اقتراح سلام
      window.proposePeace = async () => {
        const targetId = document.getElementById("peace-target-select").value;
        const durationHours =
          parseInt(document.getElementById("peace-duration").value) || 24;

        if (!targetId) return;

        if (confirm(`هل تريد إرسال معاهدة سلام لمدة ${durationHours} ساعة؟`)) {
          try {
            // إرسال رسالة للهدف تحتوي على بيانات المعاهدة
            await addDoc(collection(db, "users", targetId, "reports"), {
              // نستخدم reports كصندوق بريد
              type: "peace_offer",
              senderId: currentUser.uid,
              senderName: userDocData.username,
              duration: durationHours * 60 * 60 * 1000, // بالمللي ثانية
              timestamp: Date.now(),
              status: "pending",
              enemyName: "عرض دبلوماسي", // ليظهر في قائمة الرسائل
              outcome: "info", // لون محايد
            });

            alert("تم إرسال العرض بنجاح! انتظر القبول.");
            document.getElementById("diplomacy-modal").style.display = "none";
          } catch (e) {
            alert("خطأ: " + e.message);
          }
        }
      };

      // 4. فرض الحصار (العقوبات)
      // 4. فرض الحصار (العقوبات) - نسخة مصححة (Fix 400 Error)
      window.declareSiege = async () => {
        const targetSelect = document.getElementById("siege-target-select");

        // حماية: التأكد من وجود عنصر الاختيار
        if (!targetSelect || targetSelect.selectedIndex === -1) {
          return alert("الرجاء اختيار مملكة للحصار.");
        }

        const targetId = targetSelect.value;
        const type = document.getElementById("siege-type").value;

        if (!targetId) return;

        // حماية: التأكد من قراءة القوة بشكل صحيح (تجنب NaN)
        const selectedOption = targetSelect.options[targetSelect.selectedIndex];
        let targetPower = parseInt(selectedOption.getAttribute("data-power"));
        let myPower = userDocData.power;

        // إذا كانت القوة غير موجودة أو صفر، نضع 1 لتجنب القسمة على صفر
        if (isNaN(targetPower) || targetPower <= 0) targetPower = 1;
        if (isNaN(myPower) || myPower <= 0) myPower = 1;

        // منطق النسبة الديناميكية
        const powerRatio = myPower / targetPower;

        if (powerRatio < 0.5) {
          return alert("⛔ لا يمكنك فرض حصار! الخصم أقوى منك بمرتين.");
        }

        // حساب شدة العقوبة
        let penaltyRate = 0.05; // قيمة افتراضية صغرى
        if (powerRatio >= 2) penaltyRate = 0.5;
        else if (powerRatio >= 1.5) penaltyRate = 0.3;
        else if (powerRatio >= 1) penaltyRate = 0.15;

        const durationMs = 12 * 60 * 60 * 1000;
        const endTimeValue = Date.now() + durationMs;

        // طباعة القيم في الكونسول للتأكد (Debugging)
        console.log("Siege Data:", {
          targetId,
          attackerId: currentUser.uid,
          type,
          rate: penaltyRate,
          endTime: endTimeValue,
        });

        if (
          confirm(
            `نسبة العقوبة المحتسبة: ${(penaltyRate * 100).toFixed(
              0,
            )}%\nهل تريد فرض الحصار؟`,
          )
        ) {
          try {
            // 1. تسجيل العقوبة (تأكدنا أن جميع القيم أرقام صحيحة وليست undefined)
            await addDoc(collection(db, "active_sieges"), {
              targetId: targetId,
              attackerId: currentUser.uid,
              type: type || "economic", // حماية من القيم الفارغة
              rate: Number(penaltyRate), // ضمان أنها رقم
              endTime: Number(endTimeValue), // ضمان أنها رقم
            });

            // 2. إرسال رسالة تحذير
            await addDoc(collection(db, "users", targetId, "reports"), {
              type: "siege_alert",
              senderName: userDocData.username || "Unknown",
              penaltyRate: (penaltyRate * 100).toFixed(0),
              siegeType: type === "economic" ? "اقتصادي" : "عسكري",
              timestamp: Date.now(),
              enemyName: "إنذار حصار ⚠️",
              outcome: "loss",
            });

            alert("تم فرض الحصار بنجاح!");
            document.getElementById("diplomacy-modal").style.display = "none";
          } catch (e) {
            console.error("Siege Error:", e);
            alert("خطأ: " + e.message);
          }
        }
      }; // --- إعدادات عداد FPS ---
let lastTimeFPS = performance.now();
let frameCount = 0;
const fpsDiv = document.createElement("div");
fpsDiv.style.position = "fixed";
fpsDiv.style.top = "60px"; // أسفل الشريط العلوي قليلاً
fpsDiv.style.left = "10px"; // أقصى اليسار
fpsDiv.style.color = "#00ff00"; // لون أخضر
fpsDiv.style.backgroundColor = "rgba(0, 0, 0, 0.6)"; // خلفية شفافة
fpsDiv.style.padding = "5px 10px";
fpsDiv.style.borderRadius = "5px";
fpsDiv.style.fontFamily = "monospace";
fpsDiv.style.fontWeight = "bold";
fpsDiv.style.fontSize = "14px";
fpsDiv.style.zIndex = "10000";
fpsDiv.style.pointerEvents = "none"; // مهم جداً: يمنع تداخل اللمس مع اللعبة
fpsDiv.innerText = "FPS: 60";
document.body.appendChild(fpsDiv);
      // =========================================================
// [جديد] زر العودة للقلعة (Return to Castle Button)
// =========================================================

// 1. إنشاء الزر ديناميكياً
const returnBtn = document.createElement("div");
returnBtn.id = "return-castle-btn";
// استخدام أيقونة 'my_location' أو 'gps_fixed' من جوجل
returnBtn.innerHTML = '<span class="material-icons" style="font-size: 28px; color: #f1c40f;">my_location</span>';

// 2. تطبيق التنسيق (CSS via JS)
Object.assign(returnBtn.style, {
    position: "fixed",
    bottom: "10px",       // ارتفاع مناسب لتجنب التداخل مع أزرار التحكم
    left: "50%",
    transform: "translateX(-50%)", // توسيط دقيق
    borderRadius: "50%",  // دائري
    display: "none",      // مخفي افتراضياً
    justifyContent: "center",
    alignItems: "center",
    cursor: "pointer",
    zIndex: "1900",       // فوق عناصر اللعبة
    transition: "all 0.3s ease"
});

// تأثير عند التحويم (Hover) للكمبيوتر
returnBtn.onmouseover = () => { returnBtn.style.transform = "translateX(-50%) scale(1.1)"; };
returnBtn.onmouseleave = () => { returnBtn.style.transform = "translateX(-50%) scale(1)"; };

// إضافة الزر للصفحة
document.body.appendChild(returnBtn);

// 3. وظيفة النقر: العودة للقلعة
returnBtn.addEventListener("click", (e) => {
    // منع انتشار النقر للعبة (كي لا تتحرك القلعة أو تفتح قوائم)
    e.stopPropagation();
    
    if (myCastleMesh) {
        // نقل الهدف (Target) إلى موقع القلعة
        controls.target.copy(myCastleMesh.position);
        
        // نقل الكاميرا فوق القلعة بمسافة مناسبة
        camera.position.set(
            myCastleMesh.position.x, 
            3000, // ارتفاع الكاميرا
            myCastleMesh.position.z + 4000 // مسافة للخلف
        );
        controls.update();
    }
});

// 4. دالة التحقق من المسافة (توضع داخل animate)
function checkDistanceAndShowButton() {
    if (!myCastleMesh) return;

    // حساب المسافة بين المكان الذي تنظر إليه الكاميرا وموقع قلعتك
    const dist = controls.target.distanceTo(myCastleMesh.position);

    // إذا ابتعدت أكثر من 3000 وحدة، اظهر الزر
    if (dist > 3000) {
        returnBtn.style.display = "flex";
    } else {
        returnBtn.style.display = "none";
    }
}
      // =========================================================
// 🎓 نظام التعليم التفاعلي (Tutorial System) - نسخة الموبايل المحسنة
// =========================================================

const tutorialData = [
    { target: null, title: "👑 مرحباً بك أيها الملك!", text: "أهلاً بك في 'تحدي الملوك'. أنت الآن حاكم لقلعة جديدة. سنأخذك في جولة سريعة لتعلم أساسيات الحكم والحرب." },
    { target: "ui-lvl", title: "🏰 مستوى القلعة", text: "هنا يظهر مستوى قلعتك. كلما زاد، زادت قوتك وفتحت وحدات جديدة." },
    { target: "ui-gold", title: "💰 الموارد", text: "الذهب والفضة والخشب هي عصب مملكتك. استخدمها للتطوير والتجنيد." },
    { target: "mobile-controls", title: "🕹️ التحرك", text: "استخدم الأزرار أو المس الشاشة لاستكشاف الخريطة والبحث عن الغابات والمناجم." },
    { target: ".sidebar-toggle-btn", title: "📜 القائمة", text: "اضغط هنا لفتح القائمة الجانبية (البريد، الترتيب، وكود الهدايا)." },
    { target: "return-castle-btn", title: "🏠 العودة", text: "إذا ضللت الطريق، ستظهر أيقونة هنا لتعيدك فوراً لقلعتك." },
    { target: null, title: "⚔️ انطلق!", text: "أنت جاهز الآن. ابنِ قلعتك وسيطر على العالم!" }
];

let currentStepIndex = 0;

// 1. إنشاء الواجهة (بتصميم متجاوب للموبايل)
function initTutorialUI() {
    // التأكد من عدم وجود عناصر مكررة
    if(document.getElementById("tut-overlay")) return;

    const overlay = document.createElement("div");
    overlay.id = "tut-overlay";
    Object.assign(overlay.style, {
        position: "fixed", top: "0", left: "0", width: "100%", height: "100%",
        backgroundColor: "rgba(0,0,0,0.7)", zIndex: "20000", display: "none",
        pointerEvents: "auto"
    });

    const highlight = document.createElement("div");
    highlight.id = "tut-highlight";
    Object.assign(highlight.style, {
        position: "absolute", zIndex: "20001",
        boxShadow: "0 0 0 9999px rgba(0,0,0,0.7), 0 0 20px rgba(241, 196, 15, 0.8)",
        borderRadius: "10px", pointerEvents: "none", transition: "all 0.3s ease",
        display: "none" // مخفي افتراضياً
    });

    const tooltip = document.createElement("div");
    tooltip.id = "tut-tooltip";
    Object.assign(tooltip.style, {
        position: "fixed", // ثابت دائماً
        zIndex: "20002",
        left: "50%", top: "50%", transform: "translate(-50%, -50%)", // توسيط دائم
        width: "90%", maxWidth: "450px", // عرض مناسب
        maxHeight: "80vh", // أقصى ارتفاع 80% من الشاشة
        overflowY: "auto", // تفعيل التمرير إذا كان النص طويلاً
        padding: "15px",
        backgroundColor: "rgba(20, 20, 30, 0.98)",
        border: "2px solid #f1c40f", borderRadius: "15px",
        color: "white", fontFamily: "'Cairo', sans-serif", textAlign: "center",
        boxShadow: "0 10px 40px rgba(0,0,0,0.8)"
    });

    tooltip.innerHTML = `
        <h3 id="tut-title" style="margin:0 0 10px 0; color:#f1c40f; font-size:16px;"></h3>
        <p id="tut-text" style="font-size:13px; line-height:1.5; margin-bottom:15px; color:#ddd;"></p>
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <button id="tut-skip" style="background:none; border:none; color:#e74c3c; font-size:12px; cursor:pointer;">تخطي</button>
            <button id="tut-next" style="background:linear-gradient(180deg, #f1c40f, #b7950b); border:none; padding:6px 20px; border-radius:5px; color:black; font-weight:bold; font-size:14px; cursor:pointer;">التالي ❯</button>
        </div>
    `;

    document.body.appendChild(overlay);
    document.body.appendChild(highlight);
    document.body.appendChild(tooltip);

    document.getElementById("tut-next").onclick = nextTutorialStep;
    document.getElementById("tut-skip").onclick = endTutorial;
}

// 2. عرض الخطوة (مبسط لتجنب المشاكل)
function showTutorialStep() {
    const step = tutorialData[currentStepIndex];
    const overlay = document.getElementById("tut-overlay");
    const highlight = document.getElementById("tut-highlight");
    const tooltip = document.getElementById("tut-tooltip");
    
    if(!overlay) return;

    overlay.style.display = "block";
    tooltip.style.display = "block"; // تأكد من ظهور النص دائماً
    
    document.getElementById("tut-title").innerText = step.title;
    document.getElementById("tut-text").innerText = step.text;
    document.getElementById("tut-next").innerText = (currentStepIndex === tutorialData.length - 1) ? "ابدأ اللعب 🎮" : "التالي ❯";

    // محاولة العثور على العنصر
    let targetEl = null;
    if (step.target) {
        if (step.target.startsWith(".")) targetEl = document.querySelector(step.target);
        else targetEl = document.getElementById(step.target);
    }

    // المنطق: في شاشات الموبايل العرضية، لا نحرك النص، فقط نحرك الإضاءة
    const isSmallScreen = window.innerHeight < 500;

    if (targetEl && targetEl.offsetParent !== null) {
        const rect = targetEl.getBoundingClientRect();
        
        // تحريك مربع الإضاءة فوق العنصر
        highlight.style.display = "block";
        highlight.style.width = (rect.width + 10) + "px";
        highlight.style.height = (rect.height + 10) + "px";
        highlight.style.top = (rect.top - 5) + "px";
        highlight.style.left = (rect.left - 5) + "px";

    } else {
        // إخفاء الإضاءة للخطوات العامة
        highlight.style.display = "none";
    }
    
    // ملاحظة: النص (tooltip) دائماً في الوسط (Center) بفضل CSS
    // هذا يحل مشكلة اختفائه خارج الشاشة تماماً
}

function nextTutorialStep() {
    currentStepIndex++;
    if (currentStepIndex < tutorialData.length) showTutorialStep();
    else endTutorial();
}

async function endTutorial() {
    document.getElementById("tut-overlay").style.display = "none";
    document.getElementById("tut-highlight").style.display = "none";
    document.getElementById("tut-tooltip").style.display = "none";

    if (currentUser) {
        try {
            await updateDoc(doc(db, "users", currentUser.uid), { tutorialCompleted: true });
        } catch(e) {}
    }
}

// دالة البدء
function checkAndStartTutorial() {
    if (!userDocData) return;
    if (!userDocData.tutorialCompleted) {
        setTimeout(() => {
            initTutorialUI();
            showTutorialStep();
        }, 1500);
    }
}
      // --- 16. حلقة التحريك الرئيسية (Animation Loop) ---
      function animate() {
        requestAnimationFrame(animate);
         // --- بداية كود FPS ---
        const nowFPS = performance.now();
        frameCount++;
        if (nowFPS - lastTimeFPS >= 1000) {
            fpsDiv.innerText = "FPS: " + frameCount;
            // تغيير اللون حسب الأداء
            fpsDiv.style.color = frameCount >= 50 ? "#00ff00" : (frameCount >= 30 ? "#ffff00" : "#ff0000");
            frameCount = 0;
            lastTimeFPS = nowFPS;
        }
        // --- نهاية كود FPS ---

        // =========================================================
        // [2] منطق تطوير القلعة
        // =========================================================
        if (userDocData && userDocData.upgradeEndTime) {
          const now = Date.now();
          if (now < userDocData.upgradeEndTime) {
            if (typeof progressBarSprite !== "undefined") {
              progressBarSprite.visible = true;
              const tot =
                BASE_UPGRADE_TIME_MIN * (userDocData.rank || 1) * 60000;
              updateProgressBar(1 - (userDocData.upgradeEndTime - now) / tot);
            }
          } else {
            if (typeof progressBarSprite !== "undefined")
              progressBarSprite.visible = false;
            if (now > userDocData.upgradeEndTime + 2000) {
              updateDoc(doc(db, "users", currentUser.uid), {
                rank: increment(1),
                power: increment(500),
                upgradeEndTime: null,
              });
            }
          }
        }

        // =========================================================
        // [3] تحريك القوافل (Mining) - مع التعديل الأخير (Step 3)
        // =========================================================
        for (let i = activeCaravans.length - 1; i >= 0; i--) {
          const c = activeCaravans[i];
          if (c.state === "TO_MINE") {
            c.progress += c.speed;
            if (c.progress >= 1) {
              c.state = "MINING";
              c.mineStart = Date.now();
            }
          } else if (c.state === "MINING") {
            if (Date.now() - c.mineStart > MINING_DURATION_MS) {
              c.state = "RETURN";
              c.mesh.rotation.y += Math.PI;
              if (c.resourceId)
                deleteDoc(doc(db, "map_occupancy", c.resourceId)).catch(
                  () => {},
                );
            }
          } else if (c.state === "RETURN") {
            c.progress -= c.speed;
            if (c.progress <= 0) {
              // --- التعديل هنا: إزالة الرسم فقط ---
              // تم حذف كود توزيع الجوائز لأن الدالة handleUserProfile تقوم بذلك الآن عبر السيرفر
              scene.remove(c.mesh);
              scene.remove(c.line);
              activeCaravans.splice(i, 1);

              continue;
            }
          }
          const pos = new THREE.Vector3().lerpVectors(
            c.start,
            c.end,
            c.progress,
          );
          pos.y = Math.max(pos.y, 15);
          c.mesh.position.copy(pos);
          if (c.state !== "MINING")
            c.mesh.lookAt(c.state === "TO_MINE" ? c.end : c.start);
        }

        // =========================================================
        // [4] تحريك الجيوش (Attack)
        // =========================================================
        for (let i = activeArmies.length - 1; i >= 0; i--) {
          const army = activeArmies[i];
          army.progress += army.speed;
          if (army.progress >= 1) {
            scene.remove(army.mesh);
            scene.remove(army.line);
            activeArmies.splice(i, 1);
            resolveBattle(army);
          } else {
            const pos = new THREE.Vector3().lerpVectors(
              army.start,
              army.end,
              army.progress,
            );
            pos.y += Math.sin(army.progress * Math.PI) * 100;
            army.mesh.position.copy(pos);
            army.mesh.lookAt(army.end.x, army.mesh.position.y, army.end.z);
          }
        }

        // =========================================================
        // [5] الكاميرا المحسنة (RTS / Minecraft Style)
        // =========================================================
        const moveSpeed = keys["ShiftLeft"] ? 2000 : 600;

        const forward = keys["KeyW"] || mobileKeys.up;
        const backward = keys["KeyS"] || mobileKeys.down;
        const left = keys["KeyA"] || mobileKeys.left;
        const right = keys["KeyD"] || mobileKeys.right;
        const up = keys["KeyE"]; // صعود
        const down = keys["KeyQ"]; // هبوط

        if (forward || backward || left || right || up || down) {
          const frontVector = new THREE.Vector3();
          camera.getWorldDirection(frontVector);
          frontVector.y = 0;
          frontVector.normalize();

          const sideVector = new THREE.Vector3();
          sideVector.crossVectors(frontVector, camera.up).normalize();

          const moveVector = new THREE.Vector3();

          if (forward) moveVector.addScaledVector(frontVector, moveSpeed);
          if (backward) moveVector.addScaledVector(frontVector, -moveSpeed);
          if (left) moveVector.addScaledVector(sideVector, -moveSpeed);
          if (right) moveVector.addScaledVector(sideVector, moveSpeed);

          if (up) moveVector.y += moveSpeed;
          if (down && camera.position.y > 200) moveVector.y -= moveSpeed;

          camera.position.add(moveVector);
          controls.target.add(moveVector);
        }
        // =========================================================
        // [إضافي] تحريك أيقونات التفاعل (Floating Icons)
        // =========================================================
        const time = Date.now() * 0.003; // سرعة الحركة

        // تحريك أيقونات الغابات
        if (typeof forests !== "undefined") {
          forests.forEach((f) => {
            if (f.icon && f.icon.visible) {
              // حركة موجية للأعلى والأسفل
              f.icon.position.y =
                f.icon.userData.baseY +
                Math.sin(time + f.icon.userData.animOffset) * 20;
              // تأثير نبض خفيف في الحجم (Pulsing Scale)
              const scalePulse = 300 + Math.sin(time * 2) * 20;
              f.icon.scale.set(scalePulse, scalePulse, 1);
            }
          });
        }

        // تحريك أيقونات المناجم (اختياري - لنفس التأثير)
        if (typeof mines !== "undefined") {
          mines.forEach((m) => {
            if (m.icon && m.icon.visible) {
              // إذا لم يكن لديه baseY، نعينه مرة واحدة
              if (!m.icon.userData.baseY)
                m.icon.userData.baseY = m.icon.position.y;

              m.icon.position.y = m.icon.userData.baseY + Math.sin(time) * 20;
            }
          });
        }
            if (typeof checkDistanceAndShowButton === "function") checkDistanceAndShowButton();
        controls.update();

        renderer.render(scene, camera);
      }

      // تشغيل الحلقة
      animate();
      // --- دالة ملء الشاشة ---
      window.toggleFullScreen = () => {
        if (!document.fullscreenElement) {
          // الدخول في وضع ملء الشاشة
          document.documentElement.requestFullscreen().catch((err) => {
            console.log(
              `Error attempting to enable full-screen mode: ${err.message}`,
            );
          });
        } else {
          // الخروج من وضع ملء الشاشة
          if (document.exitFullscreen) {
            document.exitFullscreen();
          }
        }
      };
      // --- متغير لتحديد حالة النقل ---
let isTeleporting = false;

// --- دالة تفعيل وضع النقل ---
window.activateTeleportMode = () => {
    if (!currentUser || !userDocData) return;
    
    // 1. التحقق من تكلفة النقل (اختياري - هنا 50,000 ذهب)
    const teleportCost = 50000;
    if (userDocData.gold < teleportCost) {
        alert(`عذراً، تكلفة نقل القلعة هي ${teleportCost.toLocaleString()} ذهب. ليس لديك ما يكفي!`);
        return;
    }

    // 2. تفعيل الوضع وإظهار تنبيه
    isTeleporting = true;
    alert("📍 وضع النقل مفعل!\nاضغط الآن على أي مكان فارغ في الأرض لنقل قلعتك إليه.");
    
    // إخفاء القوائم لتسهيل الرؤية
    if (mobileControls) mobileControls.style.display = 'none';
};

// --- دالة تنفيذ النقل ---
window.executeTeleport = async (newX, newZ) => {
    if (!currentUser) return;
    
    const teleportCost = 50000; // التكلفة

    if (confirm(`هل أنت متأكد من نقل القلعة إلى هذا الموقع؟\nسيكلفك ذلك ${teleportCost.toLocaleString()} ذهب.`)) {
        try {
            // 1. تحديث الإحداثيات وخصم الذهب في قاعدة البيانات
            await updateDoc(doc(db, "users", currentUser.uid), {
                x: newX,
                z: newZ,
                gold: increment(-teleportCost)
            });

            // 2. إنهاء وضع النقل
            isTeleporting = false;
            
            // 3. إعادة إظهار عناصر التحكم
            if (mobileControls) mobileControls.style.display = 'flex';

            alert("✅ تم نقل القلعة بنجاح!");
            
            // 4. تحريك الكاميرا للموقع الجديد فوراً
            if (myCastleMesh) {
                myCastleMesh.position.set(newX, 0, newZ);
                camera.position.set(newX, 8000, newZ + 6000); // كاميرا فوق القلعة
                controls.target.set(newX, 0, newZ);
                controls.update();
            }

        } catch (e) {
            console.error(e);
            alert("حدث خطأ أثناء النقل: " + e.message);
            isTeleporting = false;
            if (mobileControls) mobileControls.style.display = 'flex';
        }
    } else {
        // إلغاء النقل
        isTeleporting = false;
        if (mobileControls) mobileControls.style.display = 'flex';
        alert("تم إلغاء النقل.");
    }
};
      // --- Ramadan Feature Logic ---

// 1. فتح النافذة
window.openRamadanModal = () => {
    document.getElementById('ramadan-modal').style.display = 'flex';
};

// 2. توليد النجوم حول الأيقونة
function createRamadanStars() {
    const container = document.getElementById('ramadan-stars');
    if(!container) return;

    const starCount = 8; // عدد النجوم

    for (let i = 0; i < starCount; i++) {
        const star = document.createElement('div');
        star.classList.add('r-star');
        
        // موضع عشوائي داخل المربع (حول الهلال)
        const x = Math.random() * 100; // %
        const y = Math.random() * 100; // %
        
        star.style.left = x + '%';
        star.style.top = y + '%';
        
        // تأخير عشوائي للأنيميشن لكي لا يظهروا معاً
        star.style.animationDelay = (Math.random() * 2) + 's';
        
        // حجم عشوائي بسيط
        const scale = 0.5 + Math.random();
        star.style.transform = `scale(${scale})`;

        container.appendChild(star);
    }
}

// تشغيل النجوم عند التحميل
createRamadanStars();
    </script>
  </body>
</html>
















